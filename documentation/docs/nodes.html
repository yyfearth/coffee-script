<!DOCTYPE html>  <html> <head>   <title>nodes.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="browser.html">                 browser.coffee               </a>                                           <a class="source" href="cake.html">                 cake.coffee               </a>                                           <a class="source" href="coffee-script.html">                 coffee-script.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="grammar.html">                 grammar.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="iced.html">                 iced.coffee               </a>                                           <a class="source" href="icedlib.html">                 icedlib.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="nodes.html">                 nodes.coffee               </a>                                           <a class="source" href="optparse.html">                 optparse.coffee               </a>                                           <a class="source" href="repl.html">                 repl.coffee               </a>                                           <a class="source" href="rewriter.html">                 rewriter.coffee               </a>                                           <a class="source" href="scope.html">                 scope.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               nodes.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>-<em>- mode: coffee; tab-width: 2; c-basic-offset: 2; indent-tabs-mode: nil; -</em>-
<code>nodes.coffee</code> contains all of the node classes for the syntax tree. Most
nodes are created as the result of actions in the <a href="grammar.html">grammar</a>,
but some are created by other nodes as a method of code generation. To convert
the syntax tree into a string of JavaScript code, call <code>compile()</code> on the root.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">Scope</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./scope&#39;</span>
<span class="p">{</span><span class="nx">RESERVED</span><span class="p">,</span> <span class="nx">STRICT_PROSCRIBED</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./lexer&#39;</span>
<span class="nv">iced = </span><span class="nx">require</span> <span class="s1">&#39;./iced&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Import the helpers we plan to use.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">{</span><span class="nx">compact</span><span class="p">,</span> <span class="nx">flatten</span><span class="p">,</span> <span class="nx">extend</span><span class="p">,</span> <span class="nx">merge</span><span class="p">,</span> <span class="nx">del</span><span class="p">,</span> <span class="nx">starts</span><span class="p">,</span> <span class="nx">ends</span><span class="p">,</span> <span class="nx">last</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s1">&#39;./helpers&#39;</span>

<span class="nv">exports.extend = </span><span class="nx">extend</span>  <span class="c1"># for parser</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Constant functions for nodes that don't need customization.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">YES     = </span><span class="o">-&gt;</span> <span class="kc">yes</span>
<span class="nv">NO      = </span><span class="o">-&gt;</span> <span class="kc">no</span>
<span class="nv">THIS    = </span><span class="o">-&gt;</span> <span class="k">this</span>
<span class="nv">NEGATE  = </span><span class="o">-&gt;</span> <span class="vi">@negated = </span><span class="o">not</span> <span class="nx">@negated</span><span class="p">;</span> <span class="k">this</span>
<span class="nv">NULL    = </span><span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;null&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h3>Base</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The <strong>Base</strong> is the abstract base class for all nodes in the syntax tree.
Each subclass implements the <code>compileNode</code> method, which performs the
code generation for that node. To compile a node to JavaScript,
call <code>compile</code> on it, which wraps <code>compileNode</code> in some generic extra smarts,
to know when the generated code needs to be wrapped up in a closure.
An options hash is passed and cloned throughout, containing information about
the environment from higher in the tree (such as if a returned value is
being requested by the surrounding function), information about the current
scope, and indentation level.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Base = </span><span class="k">class</span> <span class="nx">Base</span>

  <span class="nv">constructor: </span><span class="o">-&gt;</span>
    <span class="vi">@icedContinuationBlock = </span><span class="kc">null</span>
    <span class="vi">@icedPrequels          = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>iced AST node flags -- since we make several passes through the
tree setting these bits, we'll actually just flip bits in the nodes,
rather than setting function pointers to YES or NO.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@icedLoopFlag        = </span><span class="kc">false</span>
    <span class="vi">@icedNodeFlag        = </span><span class="kc">false</span>
    <span class="vi">@icedGotCpsSplitFlag = </span><span class="kc">false</span>
    <span class="vi">@icedCpsPivotFlag    = </span><span class="kc">false</span>
    <span class="vi">@icedHasAutocbFlag   = </span><span class="kc">false</span>
    <span class="vi">@icedFoundArguments  = </span><span class="kc">false</span>

    <span class="vi">@icedParentAwait     = </span><span class="kc">null</span>
    <span class="vi">@icedCallContinuationFlag = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Common logic for determining whether to wrap this node in a closure before
compiling it, or to compile directly. We need to wrap if this node is a
<em>statement</em>, and it's not a <em>pureStatement</em>, and we're not at
the top level of a block (which would be unnecessary), and we haven't
already been asked to return the result (because statements know how to
return results).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compile: </span><span class="nf">(o, lvl) -&gt;</span>
    <span class="nv">o        = </span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">o</span>
    <span class="nv">o.level  = </span><span class="nx">lvl</span> <span class="k">if</span> <span class="nx">lvl</span>
    <span class="nv">node     = </span><span class="nx">@unfoldSoak</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span> <span class="k">this</span>
    <span class="nv">node.tab = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span>
    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">icedHasContinuation</span><span class="p">()</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">icedGotCpsSplitFlag</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">compileCps</span> <span class="nx">o</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isStatement</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">compileNode</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">compileClosure</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Statements converted into expressions via closure-wrapping share a scope
object with their parent closure, to preserve the expected lexical scope.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileClosure: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@jumps</span><span class="p">()</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;cannot use a pure statement in an expression.&#39;</span>
    <span class="nv">o.sharedScope = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>This solves this case:</p>

<p>foo = (autocb) ->
  x = (i for i in [0..10])
  x</p>

<p>We don't want the autocb to fire in the evaluation of the list
 comprehension on the RHS.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@icedClearAutocbFlags</span><span class="p">()</span>
    <span class="nx">Closure</span><span class="p">.</span><span class="nx">wrap</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">compileNode</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Statements that need CPS translation will have to be split into
pieces as so.  Note that the icedPrequelsBlock is a slight ugly thing
going on.  The problem is this: icedCpsRotate when working on an expression
will want to extract the iced part <strong>first</strong> and then write the vanilla
expression <strong>second</strong>.  But we're not allowed to change the 'this' node as
we traverse the AST.  So therefore we introduce a Prequel, it's like the
opposite of the continuation.  It's the part of the program that comes before
'this'.</p>

<p>In the case of regular, easy-to-understand statements, we'll be in a nice
situation, in which every Block has code, and potentially a continuation.</p>

<p>In the case of expressions with nested await'ing, things are sadly way
more complicated.  We could have an arbitrarily deep chain here, hence
the calls to CpsCascading in a loop.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileCps : </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@icedGotCpsSplitFlag = </span><span class="kc">true</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">l = </span><span class="nx">@icedPrequels</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>

      <span class="nv">k = </span><span class="k">if</span> <span class="nx">@icedContinuationBlock</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Optimization:  We smush the "this" expression and the continuation
into a flat block.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="p">[</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@icedContinuationBlock</span> <span class="p">]</span>

      <span class="k">else</span> <span class="k">if</span> <span class="nx">@icedWrapContinuation</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>For some types of objects, we wrap the value of the object in a
iced tail call here.  We might have done this earlier (in
icedCallContinuation) but at that point we don't have the option
to replace an AST node with IcedTailCall(this).  So instead, we
do that now.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">new</span> <span class="nx">IcedTailCall</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>The simple case is no continuation, and no added IcedTailCall
needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">this</span>

      <span class="k">while</span> <span class="nx">l</span><span class="o">--</span>
        <span class="nv">pb = </span><span class="nx">@icedPrequels</span><span class="p">[</span><span class="nx">l</span><span class="p">]</span>
        <span class="nv">k = </span><span class="nx">CpsCascade</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">block</span><span class="p">,</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">pb</span><span class="p">.</span><span class="nx">retval</span><span class="p">,</span> <span class="nx">o</span>
      <span class="nv">code = </span><span class="nx">k</span>

    <span class="k">else</span>
      <span class="nv">code = </span><span class="nx">CpsCascade</span><span class="p">.</span><span class="nx">wrap</span> <span class="k">this</span><span class="p">,</span> <span class="nx">@icedContinuationBlock</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">o</span>

    <span class="nx">code</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>If the code generation wishes to use the result of a complex expression
in multiple places, ensure that the expression is only ever evaluated once,
by assigning it to a temporary variable. Pass a level to precompile.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cache: </span><span class="nf">(o, level, reused) -&gt;</span>
    <span class="nx">unless</span> <span class="nx">@isComplex</span><span class="p">()</span>
      <span class="nv">ref = </span><span class="k">if</span> <span class="nx">level</span> <span class="k">then</span> <span class="nx">@compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">level</span> <span class="k">else</span> <span class="k">this</span>
      <span class="p">[</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">ref</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nv">ref = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">reused</span> <span class="o">or</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
      <span class="nv">sub = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ref</span><span class="p">,</span> <span class="k">this</span>
      <span class="k">if</span> <span class="nx">level</span> <span class="k">then</span> <span class="p">[</span><span class="nx">sub</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">level</span><span class="p">),</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">ref</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Compile to a source/variable pair suitable for looping.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileLoopReference: </span><span class="nf">(o, name) -&gt;</span>
    <span class="nv">src = tmp = </span><span class="nx">@compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nx">unless</span> <span class="o">-</span><span class="kc">Infinity</span> <span class="o">&lt;</span> <span class="o">+</span><span class="nx">src</span> <span class="o">&lt;</span> <span class="kc">Infinity</span> <span class="o">or</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span> <span class="o">and</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">src</span><span class="p">,</span> <span class="kc">yes</span><span class="p">)</span>
      <span class="nv">src = </span><span class="s2">&quot;#{ tmp = o.scope.freeVariable name } = #{src}&quot;</span>
    <span class="p">[</span><span class="nx">src</span><span class="p">,</span> <span class="nx">tmp</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Construct a node that returns the current node's result.
Note that this is overridden for smarter behavior for
many statement nodes (e.g. If, For)...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="nv">me = </span><span class="nx">@unwrapAll</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">res</span>
      <span class="k">new</span> <span class="nx">Call</span> <span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="s2">&quot;#{res}.push&quot;</span><span class="p">),</span> <span class="p">[</span><span class="nx">me</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Return</span> <span class="nx">me</span><span class="p">,</span> <span class="nx">@icedHasAutocbFlag</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Does this node, or any of its children, contain a node of a certain kind?
Recursively traverses down the <em>children</em> of the nodes, yielding to a block
and returning true when the block finds a match. <code>contains</code> does not cross
scope boundaries.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">contains: </span><span class="nf">(pred) -&gt;</span>
    <span class="nv">contains = </span><span class="kc">no</span>
    <span class="nx">@traverseChildren</span> <span class="kc">no</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
      <span class="k">if</span> <span class="nx">pred</span> <span class="nx">node</span>
        <span class="nv">contains = </span><span class="kc">yes</span>
        <span class="k">return</span> <span class="kc">no</span>
    <span class="nx">contains</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Is this node of a certain type, or does it contain the type?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">containsType: </span><span class="nf">(type) -&gt;</span>
    <span class="k">this</span> <span class="k">instanceof</span> <span class="nx">type</span> <span class="o">or</span> <span class="nx">@contains</span> <span class="nf">(node) -&gt;</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Pull out the last non-comment node of a node list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">lastNonComment: </span><span class="nf">(list) -&gt;</span>
    <span class="nv">i = </span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">return</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="k">while</span> <span class="nx">i</span><span class="o">--</span> <span class="k">when</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
    <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p><code>toString</code> representation of the node, for inspecting the parse tree.
This is what <code>coffee --nodes</code> prints out.</p>

<p>Add some Iced-specific additions --- the 'A' flag if this node
is an await or its ancestor; the 'L' flag, if this node is a iced
loop or its descendant; a 'P' flag if this node is going to be
a 'pivot' in the CPS tree rotation; a 'C' flag if this node is inside
a function with an autocb.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toString: </span><span class="nf">(idt = &#39;&#39;, name = @constructor.name) -&gt;</span>
    <span class="nv">extras = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;A&quot;</span> <span class="k">if</span> <span class="nx">@icedNodeFlag</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;L&quot;</span> <span class="k">if</span> <span class="nx">@icedLoopFlag</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;P&quot;</span> <span class="k">if</span> <span class="nx">@icedCpsPivotFlag</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;C&quot;</span> <span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;D&quot;</span> <span class="k">if</span> <span class="nx">@icedParentAwait</span>
    <span class="nx">extras</span> <span class="o">+=</span> <span class="s2">&quot;G&quot;</span> <span class="k">if</span> <span class="nx">@icedFoundArguments</span>
    <span class="k">if</span> <span class="nx">extras</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">extras = </span><span class="s2">&quot; (&quot;</span> <span class="o">+</span> <span class="nx">extras</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
    <span class="nv">tree = </span><span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">idt</span> <span class="o">+</span> <span class="nx">name</span>
    <span class="nx">tree</span> <span class="o">+=</span> <span class="s1">&#39;?&#39;</span> <span class="k">if</span> <span class="nx">@soak</span>
    <span class="nx">tree</span> <span class="o">+=</span> <span class="nx">extras</span>
    <span class="k">for</span> <span class="nx">b</span> <span class="k">in</span> <span class="nx">@icedPrequels</span>
      <span class="nv">pidt = </span><span class="nx">idt</span> <span class="o">+</span> <span class="nx">TAB</span>
      <span class="nx">tree</span> <span class="o">+=</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">pidt</span> <span class="o">+</span> <span class="s2">&quot;Prequel&quot;</span>
      <span class="nx">tree</span> <span class="o">+=</span> <span class="nx">b</span><span class="p">.</span><span class="nx">block</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">pidt</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="nx">@eachChild</span> <span class="nf">(node) -&gt;</span> <span class="nx">tree</span> <span class="o">+=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">idt</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="k">if</span> <span class="nx">@icedContinuationBlock</span>
      <span class="nx">idt</span> <span class="o">+=</span> <span class="nx">TAB</span>
      <span class="nx">tree</span> <span class="o">+=</span> <span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">idt</span> <span class="o">+</span> <span class="s2">&quot;Continuation&quot;</span>
      <span class="nx">tree</span> <span class="o">+=</span> <span class="nx">@icedContinuationBlock</span><span class="p">.</span><span class="nx">toString</span> <span class="nx">idt</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="nx">tree</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Passes each child to a function, breaking when the function returns <code>false</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">eachChild: </span><span class="nf">(func) -&gt;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="nx">unless</span> <span class="nx">@children</span>
    <span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">@children</span> <span class="k">when</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">flatten</span> <span class="p">[</span><span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]]</span>
        <span class="k">return</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">func</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span>
    <span class="k">this</span>

  <span class="nv">traverseChildren: </span><span class="nf">(crossScope, func) -&gt;</span>
    <span class="nx">@eachChild</span> <span class="nf">(child) -&gt;</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">func</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">traverseChildren</span> <span class="nx">crossScope</span><span class="p">,</span> <span class="nx">func</span>

  <span class="nv">invert: </span><span class="o">-&gt;</span>
    <span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="k">this</span>

  <span class="nv">unwrapAll: </span><span class="o">-&gt;</span>
    <span class="nv">node = </span><span class="k">this</span>
    <span class="k">continue</span> <span class="nx">until</span> <span class="nx">node</span> <span class="o">is</span> <span class="nv">node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
    <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Don't try this at home with actual human kids.  Added for iced
for slightly different tree traversal mechanics.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">flattenChildren : </span><span class="o">-&gt;</span>
    <span class="nv">out = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">attr</span> <span class="k">in</span> <span class="nx">@children</span> <span class="k">when</span> <span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]</span>
      <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">flatten</span> <span class="p">[</span><span class="err">@</span><span class="p">[</span><span class="nx">attr</span><span class="p">]]</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span>
    <span class="nx">out</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>AST Walking Routines for CPS Pivots, etc.</p>

<p>There are three passes:
   1. Find await's and trace upward.
   2. Find loops found in #1, and flood downward
   3. Find break/continue found in #2, and trace upward</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>icedWalkAst</p>

<p>Walk the AST looking for taming. Mark a node as with iced flags
  if any of its children are iced, but don't cross scope boundary
  when considering the children.</p>

<p>The paremeter <code>p</code> is the parent <code>await</code>.  All nodes beneath the
  first <code>await</code> in a function scope should point to its highest
  parent <code>await</code>.  This is so in the case of nested <code>await</code>s,
  they're really pulled out and run in sequence as the level of the
  topmost await.</p>

<p>The parameter <code>o</code> is a global object, passed through all without
  copies, to push information up and down the AST. This parameter is
  used with subfields:</p>

<pre><code> o.foundAutocb    -- on if the parent function has an autocb
 o.foundDefer     -- on if defer() was found anywhere in the AST
 o.foundAwait     -- on if await... was found anywhere in the AST
 o.foundAwaitFunc -- on if await found in this func
 o.currFunc       -- the current func we're in
 o.foundArguments -- on if we found reference to 'arguments'
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedWalkAst : </span><span class="nf">(p, o) -&gt;</span>
    <span class="vi">@icedParentAwait = </span><span class="nx">p</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@flattenChildren</span><span class="p">()</span>
      <span class="vi">@icedNodeFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">icedWalkAst</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
    <span class="nx">@icedNodeFlag</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>icedWalkAstLoops
  Walk all loops that are marked as "iced" and mark their children
  as being children in a iced loop. They'll need more translations
  than other nodes. Eventually, "switch" statements might also be "loops"</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedWalkAstLoops : </span><span class="nf">(flood) -&gt;</span>
    <span class="nv">flood = </span><span class="kc">true</span> <span class="k">if</span>  <span class="nx">@isLoop</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@icedNodeFlag</span>
    <span class="nv">flood = </span><span class="kc">false</span> <span class="k">if</span> <span class="nx">@isLoop</span><span class="p">()</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@icedNodeFlag</span>
    <span class="vi">@icedLoopFlag = </span><span class="nx">flood</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@flattenChildren</span><span class="p">()</span>
      <span class="vi">@icedLoopFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">icedWalkAstLoops</span> <span class="nx">flood</span>
    <span class="nx">@icedLoopFlag</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>icedWalkCpsPivots
  A node is marked as a "cpsPivot" of it is (a) a 'iced' node,
  (b) a jump node in a iced while loop; or (c) an ancestor of (a) or (b).</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedWalkCpsPivots : </span><span class="o">-&gt;</span>
    <span class="vi">@icedCpsPivotFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">@icedNodeFlag</span> <span class="o">or</span> <span class="p">(</span><span class="nx">@icedLoopFlag</span> <span class="o">and</span> <span class="nx">@icedIsJump</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@flattenChildren</span><span class="p">()</span>
      <span class="vi">@icedCpsPivotFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">child</span><span class="p">.</span><span class="nx">icedWalkCpsPivots</span><span class="p">()</span>
    <span class="nx">@icedCpsPivotFlag</span>

  <span class="nv">icedClearAutocbFlags : </span><span class="o">-&gt;</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="kc">false</span>
    <span class="nx">@traverseChildren</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
      <span class="nv">node.icedHasAutocbFlag = </span><span class="kc">false</span>
      <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Default implementations of the common node properties and methods. Nodes
will override these with custom logic, if needed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">children: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A generic iced AST rotation is just to push down to its children</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedCpsRotate: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">child</span> <span class="k">in</span> <span class="nx">@flattenChildren</span><span class="p">()</span>
      <span class="nx">child</span><span class="p">.</span><span class="nx">icedCpsRotate</span><span class="p">()</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>A CPS Rotation routine for expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedCpsExprRotate : </span><span class="nf">(v) -&gt;</span>
    <span class="nv">doRotate = </span><span class="nx">v</span><span class="p">.</span><span class="nx">icedIsIcedExpr</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">doRotate</span>
      <span class="nx">v</span><span class="p">.</span><span class="nx">icedCallContinuation</span><span class="p">()</span>
    <span class="nx">v</span><span class="p">.</span><span class="nx">icedCpsRotate</span><span class="p">()</span> <span class="c1"># do our children first, regardless...</span>
    <span class="k">if</span> <span class="nx">doRotate</span>
      <span class="nx">@icedNestPrequelBlock</span> <span class="nx">v</span>
    <span class="k">else</span>
      <span class="kc">null</span>

  <span class="nv">icedIsCpsPivot            : </span>    <span class="o">-&gt;</span> <span class="nx">@icedCpsPivotFlag</span>
  <span class="nv">icedNestContinuationBlock : </span><span class="nf">(b) -&gt;</span> <span class="vi">@icedContinuationBlock = </span><span class="nx">b</span>
  <span class="nv">icedHasContinuation       : </span>    <span class="o">-&gt;</span> <span class="p">(</span><span class="o">!!</span><span class="nx">@icedContinuationBlock</span> <span class="o">or</span> <span class="nx">@icedPrequels</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
  <span class="nv">icedCallContinuation      : </span>    <span class="o">-&gt;</span> <span class="vi">@icedCallContinuationFlag = </span><span class="kc">true</span>
  <span class="nv">icedWrapContinuation      : </span>    <span class="nx">NO</span>
  <span class="nv">icedIsJump                : </span>    <span class="nx">NO</span>
  <span class="nv">icedIsIcedExpr           : </span>    <span class="o">-&gt;</span> <span class="p">(</span><span class="k">this</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Code</span><span class="p">)</span> <span class="o">and</span> <span class="nx">@icedNodeFlag</span>

  <span class="nv">icedNestPrequelBlock: </span><span class="nf">(bb) -&gt;</span>
    <span class="nv">rv = </span><span class="k">new</span> <span class="nx">IcedReturnValue</span><span class="p">()</span>
    <span class="nv">obj = </span><span class="nx">@icedParentAwait</span> <span class="o">||</span> <span class="k">this</span>
    <span class="nx">obj</span><span class="p">.</span><span class="nx">icedPrequels</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nv">block : </span><span class="nx">bb</span><span class="p">,</span> <span class="nv">retval : </span><span class="nx">rv</span> <span class="p">}</span>
    <span class="nx">rv</span>

  <span class="nv">icedUnwrap: </span><span class="nf">(e) -&gt;</span>
    <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedHasContinuation</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@icedHasContinuation</span><span class="p">()</span>
      <span class="k">this</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">@icedHasContinuation</span><span class="p">()</span>
        <span class="nv">e.icedContinuationBlock = </span><span class="nx">@icedContinuationBlock</span>
        <span class="nv">e.icedPrequels = </span><span class="nx">@icedPrequels</span>
      <span class="nx">e</span>

  <span class="nv">isStatement     : </span><span class="nx">NO</span>
  <span class="nv">jumps           : </span><span class="nx">NO</span>
  <span class="nv">isComplex       : </span><span class="nx">YES</span>
  <span class="nv">isChainable     : </span><span class="nx">NO</span>
  <span class="nv">isAssignable    : </span><span class="nx">NO</span>
  <span class="nv">isLoop          : </span><span class="nx">NO</span>

  <span class="nv">unwrap     : </span><span class="nx">THIS</span>
  <span class="nv">unfoldSoak : </span><span class="nx">NO</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Is this node used to assign a certain variable?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">assigns: </span><span class="nx">NO</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>Block</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>The block is the list of expressions that forms the body of an
indented block of code -- the implementation of a function, a clause in an
<code>if</code>, <code>switch</code>, or <code>try</code>, and so on...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Block = </span><span class="k">class</span> <span class="nx">Block</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(nodes) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@expressions = </span><span class="nx">compact</span> <span class="nx">flatten</span> <span class="nx">nodes</span> <span class="o">or</span> <span class="p">[]</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;expressions&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Tack an expression on to the end of this expression list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">push: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">@expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">node</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Remove and return the last expression of this expression list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">pop: </span><span class="o">-&gt;</span>
    <span class="nx">@expressions</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Add an expression at the beginning of this expression list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unshift: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">@expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">node</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>If this Block consists of just a single node, unwrap it by pulling
it back out.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unwrap: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">@icedUnwrap</span> <span class="nx">@expressions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Like unwrap, but will return if not a single</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">getSingle : </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">@expressions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Is this an empty block of code?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isEmpty: </span><span class="o">-&gt;</span>
    <span class="o">not</span> <span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span>

  <span class="nv">isStatement: </span><span class="nf">(o) -&gt;</span>
    <span class="k">for</span> <span class="nx">exp</span> <span class="k">in</span> <span class="nx">@expressions</span> <span class="k">when</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">isStatement</span> <span class="nx">o</span>
      <span class="k">return</span> <span class="kc">yes</span>
    <span class="kc">no</span>

  <span class="nv">jumps: </span><span class="nf">(o) -&gt;</span>
    <span class="k">for</span> <span class="nx">exp</span> <span class="k">in</span> <span class="nx">@expressions</span>
      <span class="k">return</span> <span class="nx">exp</span> <span class="k">if</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">jumps</span> <span class="nx">o</span>

  <span class="nv">icedThreadReturn: </span><span class="nf">(call)  -&gt;</span>
    <span class="nv">call = </span><span class="nx">call</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">IcedTailCall</span>
    <span class="nv">len = </span><span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">while</span> <span class="nx">len</span><span class="o">--</span>
      <span class="nv">expr = </span><span class="nx">@expressions</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>If the last expression in the block is either a bonafide statement
or if it's going to be pivoted, then don't thread the return value
through the IcedTailCall, just bolt it onto the end.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">isStatement</span><span class="p">()</span>
        <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>In this case, we have a value that we're going to return out
of the block, so apply the IcedTamilCall onto the value</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">expr</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Comment</span> <span class="o">and</span> <span class="nx">expr</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Return</span>
        <span class="nx">call</span><span class="p">.</span><span class="nx">assignValue</span> <span class="nx">expr</span>
        <span class="nx">@expressions</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span> <span class="o">=</span> <span class="nx">call</span>
        <span class="k">return</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>if nothing was found, just push the call on</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">call</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>A Block node does not return its entire body, rather it
ensures that the final expression is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="nv">len = </span><span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span>
    <span class="nv">foundReturn = </span><span class="kc">false</span>
    <span class="k">while</span> <span class="nx">len</span><span class="o">--</span>
      <span class="nv">expr = </span><span class="nx">@expressions</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">expr</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
        <span class="nx">@expressions</span><span class="p">[</span><span class="nx">len</span><span class="p">]</span> <span class="o">=</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span>
        <span class="k">if</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Return</span> <span class="o">and</span>
           <span class="o">not</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">expression</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">icedHasAutocbFlag</span>
          <span class="nx">@expressions</span><span class="p">.</span><span class="nx">splice</span><span class="p">(</span><span class="nx">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
          <span class="nv">foundReturn = </span><span class="kc">true</span>
        <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="p">(</span><span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">If</span><span class="p">)</span> <span class="o">or</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">elseBody</span>
          <span class="nv">foundReturn = </span><span class="kc">true</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@icedNodeFlag</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">foundReturn</span>
      <span class="nx">@expressions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Return</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Optimization!
Blocks typically don't need their own cpsCascading.  This saves
wasted code.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileCps : </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@icedGotCpsSplitFlag = </span><span class="kc">true</span>
    <span class="k">if</span> <span class="nx">@expressions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">super</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nx">@compileNode</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>A <strong>Block</strong> is the only node that can serve as the root.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compile: </span><span class="nf">(o = {}, level) -&gt;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span> <span class="k">then</span> <span class="k">super</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">level</span> <span class="k">else</span> <span class="nx">@compileRoot</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Compile all expressions within the <strong>Block</strong> body. If we need to
return the result, and it's an expression, simply return it. If it's a
statement, ask the statement to do so.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@tab  = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span>
    <span class="nv">top   = </span><span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span>
    <span class="nv">codes = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@expressions</span>
      <span class="nv">node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()</span>
      <span class="nv">node = </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">unfoldSoak</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span> <span class="nx">node</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Block</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>This is a nested block.  We don't do anything special here like enclose
it in a new scope; we just compile the statements in this block along with
our own.
In the case of IcedRuntime, the block might output nothing.
In that case, don't add extra spaces</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">chld = </span><span class="nx">node</span><span class="p">.</span><span class="nx">compileNode</span> <span class="nx">o</span>
        <span class="nx">codes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">chld</span> <span class="k">if</span> <span class="nx">chld</span> <span class="o">and</span> <span class="nx">chld</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">top</span>
        <span class="nv">node.front = </span><span class="kc">true</span>
        <span class="nv">code = </span><span class="nx">node</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
        <span class="nx">unless</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isStatement</span> <span class="nx">o</span>
          <span class="nv">code = </span><span class="s2">&quot;#{@tab}#{code};&quot;</span>
          <span class="nv">code = </span><span class="s2">&quot;#{code}\n&quot;</span> <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Literal</span>
        <span class="nx">codes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">code</span>
      <span class="k">else</span>
        <span class="nx">codes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">node</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="k">if</span> <span class="nx">top</span>
      <span class="k">if</span> <span class="nx">@spaced</span>
        <span class="k">return</span> <span class="s2">&quot;\n#{codes.join &#39;\n\n&#39;}\n&quot;</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;\n&#39;</span>
    <span class="nv">code = </span><span class="nx">codes</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s1">&#39;void 0&#39;</span>
    <span class="k">if</span> <span class="nx">codes</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_LIST</span> <span class="k">then</span> <span class="s2">&quot;(#{code})&quot;</span> <span class="k">else</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If we happen to be the top-level <strong>Block</strong>, wrap everything in
a safety closure, unless requested not to.
It would be better not to generate them in the first place, but for now,
clean up obvious double-parentheses.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileRoot: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">o.indent  = </span><span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">bare</span> <span class="k">then</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nx">TAB</span>
    <span class="nv">o.scope   = </span><span class="k">new</span> <span class="nx">Scope</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="kc">null</span>
    <span class="nv">o.level   = </span><span class="nx">LEVEL_TOP</span>
    <span class="vi">@spaced   = </span><span class="kc">yes</span>
    <span class="nv">prelude   = </span><span class="s2">&quot;&quot;</span>
    <span class="nx">unless</span> <span class="nx">o</span><span class="p">.</span><span class="nx">bare</span>
      <span class="nv">preludeExps = </span><span class="k">for</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@expressions</span>
        <span class="k">break</span> <span class="nx">unless</span> <span class="nx">exp</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
        <span class="nx">exp</span>

      <span class="nv">rest = </span><span class="nx">@expressions</span><span class="p">[</span><span class="nx">preludeExps</span><span class="p">.</span><span class="nx">length</span><span class="p">...]</span>

      <span class="vi">@expressions = </span><span class="nx">preludeExps</span>
      <span class="nv">prelude = </span><span class="s2">&quot;#{@compileNode merge(o, indent: &#39;&#39;)}\n&quot;</span> <span class="k">if</span> <span class="nx">preludeExps</span><span class="p">.</span><span class="nx">length</span>
      <span class="vi">@expressions = </span><span class="nx">rest</span>
    <span class="nv">code = </span><span class="nx">@compileWithDeclarations</span> <span class="nx">o</span>
    <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">bare</span>
    <span class="s2">&quot;#{prelude}(function() {\n#{code}\n}).call(this);\n&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Compile the expressions body for the contents of a function, with
declarations of all inner variables pushed up to the top.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileWithDeclarations: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">code = post = </span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@expressions</span>
      <span class="nv">exp = </span><span class="nx">exp</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
      <span class="k">break</span> <span class="nx">unless</span> <span class="nx">exp</span> <span class="k">instanceof</span> <span class="nx">Comment</span> <span class="o">or</span> <span class="nx">exp</span> <span class="k">instanceof</span> <span class="nx">Literal</span>
    <span class="nv">o = </span><span class="nx">merge</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nv">level: </span><span class="nx">LEVEL_TOP</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">i</span>
      <span class="nv">rest = </span><span class="nx">@expressions</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">i</span><span class="p">,</span> <span class="mi">9</span><span class="nx">e9</span>
      <span class="p">[</span><span class="nx">spaced</span><span class="p">,</span> <span class="nx">@spaced</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@spaced</span><span class="p">,</span> <span class="kc">no</span><span class="p">]</span>
      <span class="p">[</span><span class="nx">code</span>  <span class="p">,</span> <span class="nx">@spaced</span><span class="p">]</span> <span class="o">=</span> <span class="p">[(</span><span class="nx">@compileNode</span> <span class="nx">o</span><span class="p">),</span> <span class="nx">spaced</span><span class="p">]</span>
      <span class="vi">@expressions = </span><span class="nx">rest</span>
    <span class="nv">post = </span><span class="nx">@compileNode</span> <span class="nx">o</span>
    <span class="p">{</span><span class="nx">scope</span><span class="p">}</span> <span class="o">=</span> <span class="nx">o</span>
    <span class="k">if</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">expressions</span> <span class="o">is</span> <span class="k">this</span>
      <span class="nv">declars = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">hasDeclarations</span><span class="p">()</span>
      <span class="nv">assigns = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">hasAssignments</span>
      <span class="k">if</span> <span class="nx">declars</span> <span class="o">or</span> <span class="nx">assigns</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;\n&#39;</span> <span class="k">if</span> <span class="nx">i</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;#{@tab}var &quot;</span>
        <span class="k">if</span> <span class="nx">declars</span>
          <span class="nx">code</span> <span class="o">+=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">declaredVariables</span><span class="p">().</span><span class="nx">join</span> <span class="s1">&#39;, &#39;</span>
        <span class="k">if</span> <span class="nx">assigns</span>
          <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;,\n#{@tab + TAB}&quot;</span> <span class="k">if</span> <span class="nx">declars</span>
          <span class="nx">code</span> <span class="o">+=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">assignedVariables</span><span class="p">().</span><span class="nx">join</span> <span class="s2">&quot;,\n#{@tab + TAB}&quot;</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s1">&#39;;\n&#39;</span>
    <span class="nx">code</span> <span class="o">+</span> <span class="nx">post</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>icedCpsRotate -- This is the key abstract syntax tree rotation of the
CPS translation. Take a block with a bunch of sequential statements
and "pivot" the AST on the first available pivot.  The expressions
on the LHS of the pivot stay where the are.  The expressions on the RHS
of the pivot become the pivot's continuation. And the process is applied
recursively.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedCpsRotate : </span><span class="o">-&gt;</span>
    <span class="nv">pivot = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Go ahead an look for a pivot</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">for</span> <span class="nx">e</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">@expressions</span>
      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedIsCpsPivot</span><span class="p">()</span>
        <span class="nv">pivot = </span><span class="nx">e</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>The pivot value needs to call the currently active continuation
after it's all done.  For things like if..else.. this does something
interesting and pushes the continuation down both branches.
Note that it's convenient to do this <strong>before</strong> anything is
rotated.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">pivot</span><span class="p">.</span><span class="nx">icedCallContinuation</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Recursively rotate the children, in depth-first order.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">e</span><span class="p">.</span><span class="nx">icedCpsRotate</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>If we've found a pivot, then we break out of here, and then
handle the rest of these children</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">break</span> <span class="k">if</span> <span class="nx">pivot</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>If there's no pivot, then the above should be as in the base
class, and it's safe to return out of here.</p>

<p>We find a pivot if this node has taming, and it's not an Await
itself.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="k">this</span> <span class="nx">unless</span> <span class="nx">pivot</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>We should never have a continuation here, even though we rotated
this guy above.  This is true for one of two cases:
  1. If pivot is a statement, then the continuation will be in the
     grandchild Block node
  2. If pivot is an expression, the pivoted code will be a prequel
     and not a continuation (since we can't replace nodes as we
     walk).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">pivot</span><span class="p">.</span><span class="nx">icedContinuationBlock</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;unexpected continuation block in node&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>These are the expressions on the RHS of the pivot split</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">rest = </span><span class="nx">@expressions</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Leave the pivot in the list of expressions</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@expressions = </span><span class="nx">@expressions</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>If there are elements in rest, then we need to nest a continuation block</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">rest</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">child = </span><span class="k">new</span> <span class="nx">Block</span> <span class="nx">rest</span>
      <span class="nx">pivot</span><span class="p">.</span><span class="nx">icedNestContinuationBlock</span> <span class="nx">child</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>Pass our node bits onto our new children</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">e</span> <span class="k">in</span> <span class="nx">rest</span>
        <span class="nv">child.icedNodeFlag = </span><span class="kc">true</span>      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedNodeFlag</span>
        <span class="nv">child.icedLoopFlag = </span><span class="kc">true</span>      <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedLoopFlag</span>
        <span class="nv">child.icedCpsPivotFlag = </span><span class="kc">true</span>  <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedCpsPivotFlag</span>
        <span class="nv">child.icedHasAutocbFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">e</span><span class="p">.</span><span class="nx">icedHasAutocbFlag</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>now recursive apply the transformation to the new child,
this being especially important in blocks that have multiple
awaits on the same level</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">child</span><span class="p">.</span><span class="nx">icedCpsRotate</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>return this for chaining</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Wrap up the given nodes as a <strong>Block</strong>, unless it already happens
to be one.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@wrap: </span><span class="nf">(nodes) -&gt;</span>
    <span class="k">return</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">nodes</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="nx">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">instanceof</span> <span class="nx">Block</span>
    <span class="k">new</span> <span class="nx">Block</span> <span class="nx">nodes</span>

  <span class="nv">icedAddRuntime : </span><span class="nf">(foundDefer, foundAwait) -&gt;</span>
    <span class="nv">index = </span><span class="mi">0</span>
    <span class="k">while</span> <span class="p">(</span><span class="nv">node = </span><span class="nx">@expressions</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="o">and</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Comment</span> <span class="o">or</span>
        <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isString</span><span class="p">()</span>
      <span class="nx">index</span><span class="o">++</span>
    <span class="nx">@expressions</span><span class="p">.</span><span class="nx">splice</span> <span class="nx">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nx">IcedRuntime</span> <span class="nx">foundDefer</span><span class="p">,</span> <span class="nx">foundAwait</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Perform all steps of the Iced transform</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedTransform : </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>we need to do at least 1 walk -- do the most important walk first</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">obj = </span><span class="p">{}</span>
    <span class="nx">@icedWalkAst</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Add a runtime if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@icedAddRuntime</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">foundDefer</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">foundAwait</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>short-circuit here for optimization. If we didn't find await
then no need to iced anything in this AST</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">foundAwait</span>
      <span class="nx">@icedWalkAstLoops</span> <span class="kc">false</span>
      <span class="nx">@icedWalkCpsPivots</span><span class="p">()</span>
      <span class="nx">@icedCpsRotate</span><span class="p">()</span>

    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h3>Literal</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <p>Literals are static values that can be passed through directly into
JavaScript without translation, such as: strings, numbers,
<code>true</code>, <code>false</code>, <code>null</code>...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Literal = </span><span class="k">class</span> <span class="nx">Literal</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@value, @tag) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">makeReturn: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@isStatement</span><span class="p">()</span> <span class="k">then</span> <span class="k">this</span> <span class="k">else</span> <span class="k">super</span>

  <span class="nv">isAssignable: </span><span class="o">-&gt;</span>
    <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span> <span class="nx">@value</span>

  <span class="nv">isStatement: </span><span class="o">-&gt;</span>
    <span class="nx">@value</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;break&#39;</span><span class="p">,</span> <span class="s1">&#39;continue&#39;</span><span class="p">,</span> <span class="s1">&#39;debugger&#39;</span><span class="p">]</span>

  <span class="nv">isComplex: </span><span class="nx">NO</span>
  <span class="nv">icedIsJump : </span><span class="o">-&gt;</span> <span class="nx">@isStatement</span><span class="p">()</span>

  <span class="nv">assigns: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">name</span> <span class="o">is</span> <span class="nx">@value</span>

  <span class="nv">icedWalkAst : </span><span class="nf">(parent, o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s1">&#39;arguments&#39;</span> <span class="o">and</span> <span class="nx">o</span><span class="p">.</span><span class="nx">foundAwaitFunc</span>
      <span class="nv">o.foundArguments = </span><span class="kc">true</span>
      <span class="vi">@value = </span><span class="s2">&quot;_arguments&quot;</span>
    <span class="kc">false</span>

  <span class="nv">compileIced: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">d =</span>
      <span class="s1">&#39;continue&#39;</span> <span class="o">:</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">c_while</span>
      <span class="s1">&#39;break&#39;</span>    <span class="o">:</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">b_while</span>
    <span class="nv">l = </span><span class="nx">d</span><span class="p">[</span><span class="nx">@value</span><span class="p">]</span>
    <span class="nv">func = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">l</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">func</span><span class="p">,</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="nx">call</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>

  <span class="nv">jumps: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s1">&#39;break&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">loop</span> <span class="o">or</span> <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">block</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s1">&#39;continue&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">loop</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">code = </span><span class="k">if</span> <span class="nx">@isUndefined</span>
      <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_ACCESS</span> <span class="k">then</span> <span class="s1">&#39;(void 0)&#39;</span> <span class="k">else</span> <span class="s1">&#39;void 0&#39;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@value</span> <span class="o">is</span> <span class="s1">&#39;this&#39;</span>
      <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">method</span><span class="o">?</span><span class="p">.</span><span class="nx">bound</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">context</span>
      <span class="k">else</span>
        <span class="nx">@value</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@value</span><span class="p">.</span><span class="nx">reserved</span>
      <span class="s2">&quot;\&quot;#{@value}\&quot;&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@icedLoopFlag</span> <span class="o">and</span> <span class="nx">@icedIsJump</span><span class="p">()</span>
      <span class="nx">@compileIced</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nx">@value</span>
    <span class="k">if</span> <span class="nx">@isStatement</span><span class="p">()</span> <span class="k">then</span> <span class="s2">&quot;#{@tab}#{code};&quot;</span> <span class="k">else</span> <span class="nx">code</span>

  <span class="nv">toString: </span><span class="o">-&gt;</span>
    <span class="s1">&#39; &quot;&#39;</span> <span class="o">+</span> <span class="nx">@value</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h3>Return</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>A <code>return</code> is a <em>pureStatement</em> -- wrapping it in a closure wouldn't
make sense.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Return = </span><span class="k">class</span> <span class="nx">Return</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(expr, auto) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">auto</span>
    <span class="vi">@expression = </span><span class="nx">expr</span> <span class="k">if</span> <span class="nx">expr</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">isUndefined</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span>    <span class="nx">YES</span>
  <span class="nv">makeReturn: </span>     <span class="nx">THIS</span>
  <span class="nv">jumps: </span>          <span class="nx">THIS</span>

  <span class="nv">compile: </span><span class="nf">(o, level) -&gt;</span>
    <span class="nv">expr = </span><span class="nx">@expression</span><span class="o">?</span><span class="p">.</span><span class="nx">makeReturn</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">expr</span> <span class="o">and</span> <span class="nx">expr</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Return</span> <span class="k">then</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">level</span> <span class="k">else</span> <span class="k">super</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">level</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span>
      <span class="nv">cb = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">autocb</span>
      <span class="nv">args = </span><span class="k">if</span> <span class="nx">@expression</span> <span class="k">then</span> <span class="p">[</span> <span class="nx">@expression</span> <span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
      <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">args</span>
      <span class="nv">ret = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;return&quot;</span>
      <span class="nv">block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">call</span><span class="p">,</span> <span class="nx">ret</span><span class="p">];</span>
      <span class="nx">block</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nx">@tab</span> <span class="o">+</span> <span class="s2">&quot;return#{[&quot;</span> <span class="c1">#{@expression.compile o, LEVEL_PAREN}&quot; if @expression]};&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h3>Value</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>A value, variable or literal or parenthesized, indexed or dotted into,
or vanilla.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Value = </span><span class="k">class</span> <span class="nx">Value</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(base, props, tag) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">base</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">props</span> <span class="o">and</span> <span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Value</span>
    <span class="vi">@base       = </span><span class="nx">base</span>
    <span class="vi">@properties = </span><span class="nx">props</span> <span class="o">or</span> <span class="p">[]</span>
    <span class="err">@</span><span class="p">[</span><span class="nx">tag</span><span class="p">]</span>      <span class="o">=</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">tag</span>
    <span class="k">return</span> <span class="k">this</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;base&#39;</span><span class="p">,</span> <span class="s1">&#39;properties&#39;</span><span class="p">]</span>

  <span class="nv">copy : </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Value</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@properties</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Add a property (or <em>properties</em> ) <code>Access</code> to the list.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">add: </span><span class="nf">(props) -&gt;</span>
    <span class="vi">@properties = </span><span class="nx">@properties</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">props</span>
    <span class="k">this</span>

  <span class="nv">hasProperties: </span><span class="o">-&gt;</span>
    <span class="o">!!</span><span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Some boolean checks for the benefit of other nodes.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isArray        : </span><span class="o">-&gt;</span> <span class="o">not</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Arr</span>
  <span class="nv">isComplex      : </span><span class="o">-&gt;</span> <span class="nx">@hasProperties</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
  <span class="nv">isAssignable   : </span><span class="o">-&gt;</span> <span class="nx">@hasProperties</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isAssignable</span><span class="p">()</span>
  <span class="nv">isSimpleNumber : </span><span class="o">-&gt;</span> <span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">SIMPLENUM</span><span class="p">.</span><span class="nx">test</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">value</span>
  <span class="nv">isString       : </span><span class="o">-&gt;</span> <span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">IS_STRING</span><span class="p">.</span><span class="nx">test</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">value</span>
  <span class="nv">isAtomic       : </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">@base</span>
      <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">soak</span> <span class="o">or</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Call</span>
    <span class="kc">yes</span>

  <span class="nv">isStatement : </span><span class="nf">(o)    -&gt;</span> <span class="o">not</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isStatement</span> <span class="nx">o</span>
  <span class="nv">assigns     : </span><span class="nf">(name) -&gt;</span> <span class="o">not</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">assigns</span> <span class="nx">name</span>
  <span class="nv">jumps       : </span><span class="nf">(o)    -&gt;</span> <span class="o">not</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">jumps</span> <span class="nx">o</span>

  <span class="nv">isObject: </span><span class="nf">(onlyGenerated) -&gt;</span>
    <span class="k">return</span> <span class="kc">no</span> <span class="k">if</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">(</span><span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Obj</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">onlyGenerated</span> <span class="o">or</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">generated</span><span class="p">)</span>

  <span class="nv">isSplice: </span><span class="o">-&gt;</span>
    <span class="nx">last</span><span class="p">(</span><span class="nx">@properties</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Slice</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>The value can be unwrapped as its inner node, if there are no attached
properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unwrap: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="k">this</span> <span class="k">else</span> <span class="nx">@icedUnwrap</span> <span class="nx">@base</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>If this value is being used as a slot for the purposes of a defer
then export it here</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">toSlot : </span><span class="nf">(i) -&gt;</span>
    <span class="k">return</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">toSlot</span> <span class="nx">i</span> <span class="k">if</span> <span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Obj</span>
    <span class="nv">sufffix = </span><span class="kc">null</span>
    <span class="k">if</span> <span class="nx">@properties</span> <span class="o">and</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">suffix = </span><span class="nx">@properties</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">Slot</span> <span class="nx">i</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">suffix</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>A reference has base part (<code>this</code> value) and name part.
We cache them separately for compiling complex expressions.
<code>a()[b()] ?= c</code> -> <code>(_base = a())[_name = b()] ? _base[_name] = c</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cacheReference: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">name = </span><span class="nx">last</span> <span class="nx">@properties</span>
    <span class="k">if</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@base</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
      <span class="k">return</span> <span class="p">[</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">]</span>  <span class="c1"># `a` `a.b`</span>
    <span class="nv">base = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@properties</span><span class="p">[...</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>  <span class="c1"># `a().b`</span>
      <span class="nv">bref = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;base&#39;</span>
      <span class="nv">base = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Parens</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">bref</span><span class="p">,</span> <span class="nx">base</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">base</span><span class="p">,</span> <span class="nx">bref</span><span class="p">]</span> <span class="nx">unless</span> <span class="nx">name</span>  <span class="c1"># `a()`</span>
    <span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>  <span class="c1"># `a[b()]`</span>
      <span class="nv">nref = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;name&#39;</span>
      <span class="nv">name = </span><span class="k">new</span> <span class="nx">Index</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">nref</span><span class="p">,</span> <span class="nx">name</span><span class="p">.</span><span class="nx">index</span>
      <span class="nv">nref = </span><span class="k">new</span> <span class="nx">Index</span> <span class="nx">nref</span>
    <span class="p">[</span><span class="nx">base</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">bref</span> <span class="o">or</span> <span class="nx">base</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="p">[</span><span class="nx">nref</span> <span class="o">or</span> <span class="nx">name</span><span class="p">])]</span>

  <span class="nv">icedWrapContinuation : </span><span class="nx">YES</span>
  <span class="nv">icedCpsRotate: </span><span class="o">-&gt;</span>
    <span class="nx">unless</span> <span class="nx">@properties</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">super</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="vi">@base = </span><span class="nx">nv</span> <span class="k">if</span> <span class="p">(</span><span class="nv">nv = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@base</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@properties</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="o">?</span> <span class="o">and</span> <span class="nx">@icedCpsExprRotate</span> <span class="nx">p</span><span class="p">.</span><span class="nx">index</span><span class="p">)</span>
        <span class="nv">p.index = </span><span class="nx">v</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>We compile a value to JavaScript by compiling and joining each property.
Things get much more interesting if the chain of properties has <em>soak</em>
operators <code>?.</code> interspersed. Then we have to take care not to accidentally
evaluate anything twice when building the soak chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@base.front = </span><span class="nx">@front</span>
    <span class="nv">props = </span><span class="nx">@properties</span>
    <span class="nv">code  = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="k">if</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="nx">LEVEL_ACCESS</span> <span class="k">else</span> <span class="kc">null</span>
    <span class="nv">code  = </span><span class="s2">&quot;#{code}.&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="nx">@base</span> <span class="k">instanceof</span> <span class="nx">Parens</span> <span class="o">or</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="o">and</span> <span class="nx">SIMPLENUM</span><span class="p">.</span><span class="nx">test</span> <span class="nx">code</span>
    <span class="nx">code</span> <span class="o">+=</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span> <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">props</span>
    <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Unfold a soak into an <code>If</code>: <code>a?.b</code> -> <code>a.b if a?</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unfoldSoak: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="nx">@unfoldedSoak</span> <span class="k">if</span> <span class="nx">@unfoldedSoak</span><span class="o">?</span>
    <span class="nv">result = </span><span class="nx">do</span> <span class="o">=&gt;</span>
      <span class="k">if</span> <span class="nv">ifn = </span><span class="nx">@base</span><span class="p">.</span><span class="nx">unfoldSoak</span> <span class="nx">o</span>
        <span class="nb">Array</span><span class="o">::</span><span class="nx">push</span><span class="p">.</span><span class="nx">apply</span> <span class="nx">ifn</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="nx">@properties</span>
        <span class="k">return</span> <span class="nx">ifn</span>
      <span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@properties</span> <span class="k">when</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">soak</span>
        <span class="nv">prop.soak = </span><span class="kc">off</span>
        <span class="nv">fst = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@properties</span><span class="p">[...</span><span class="nx">i</span><span class="p">]</span>
        <span class="nv">snd = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">@base</span><span class="p">,</span> <span class="nx">@properties</span><span class="p">[</span><span class="nx">i</span><span class="p">..]</span>
        <span class="k">if</span> <span class="nx">fst</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
          <span class="nv">ref = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
          <span class="nv">fst = </span><span class="k">new</span> <span class="nx">Parens</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">fst</span>
          <span class="nv">snd.base = </span><span class="nx">ref</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">If</span> <span class="k">new</span> <span class="nx">Existence</span><span class="p">(</span><span class="nx">fst</span><span class="p">),</span> <span class="nx">snd</span><span class="p">,</span> <span class="nv">soak: </span><span class="kc">on</span>
      <span class="kc">null</span>
    <span class="vi">@unfoldedSoak = </span><span class="nx">result</span> <span class="o">or</span> <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <h3>Comment</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>CoffeeScript passes through block comments as JavaScript block comments
at the same position.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Comment = </span><span class="k">class</span> <span class="nx">Comment</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@comment) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">isStatement: </span>    <span class="nx">YES</span>
  <span class="nv">makeReturn: </span>     <span class="nx">THIS</span>

  <span class="nv">compileNode: </span><span class="nf">(o, level) -&gt;</span>
    <span class="nv">code = </span><span class="s1">&#39;/*&#39;</span> <span class="o">+</span> <span class="nx">multident</span><span class="p">(</span><span class="nx">@comment</span><span class="p">,</span> <span class="nx">@tab</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;\n#{@tab}*/\n&quot;</span>
    <span class="nv">code = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">code</span> <span class="k">if</span> <span class="p">(</span><span class="nx">level</span> <span class="o">or</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span><span class="p">)</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span>
    <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <h3>Call</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>Node for a function invocation. Takes care of converting <code>super()</code> calls into
calls against the prototype's function of the same name.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Call = </span><span class="k">class</span> <span class="nx">Call</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(variable, @args = [], @soak) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@isNew    = </span><span class="kc">false</span>
    <span class="vi">@isSuper  = </span><span class="nx">variable</span> <span class="o">is</span> <span class="s1">&#39;super&#39;</span>
    <span class="vi">@variable = </span><span class="k">if</span> <span class="nx">@isSuper</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="nx">variable</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;args&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Tag this invocation as creating a new instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">newInstance: </span><span class="o">-&gt;</span>
    <span class="nv">base = </span><span class="nx">@variable</span><span class="o">?</span><span class="p">.</span><span class="nx">base</span> <span class="o">or</span> <span class="nx">@variable</span>
    <span class="k">if</span> <span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Call</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">base</span><span class="p">.</span><span class="nx">isNew</span>
      <span class="nx">base</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="vi">@isNew = </span><span class="kc">true</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Grab the reference to the superclass's implementation of the current
method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">superReference: </span><span class="nf">(o) -&gt;</span>
    <span class="p">{</span><span class="nx">method</span><span class="p">}</span> <span class="o">=</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;cannot call super outside of a function.&#39;</span> <span class="nx">unless</span> <span class="nx">method</span>
    <span class="p">{</span><span class="nx">name</span><span class="p">}</span> <span class="o">=</span> <span class="nx">method</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;cannot call super on an anonymous function.&#39;</span> <span class="nx">unless</span> <span class="nx">name</span><span class="o">?</span>
    <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">klass</span>
      <span class="nv">accesses = </span><span class="p">[</span><span class="k">new</span> <span class="nx">Access</span><span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;__super__&#39;</span><span class="p">)]</span>
      <span class="nx">accesses</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;constructor&#39;</span> <span class="k">if</span> <span class="nx">method</span><span class="p">.</span><span class="nx">static</span>
      <span class="nx">accesses</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">name</span>
      <span class="p">(</span><span class="k">new</span> <span class="nx">Value</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">method</span><span class="p">.</span><span class="nx">klass</span><span class="p">),</span> <span class="nx">accesses</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="s2">&quot;#{name}.__super__.constructor&quot;</span>


  <span class="nv">icedWrapContinuation: </span><span class="nx">YES</span>
  <span class="nv">icedCpsRotate: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">a</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">@args</span>
      <span class="nx">@args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">if</span> <span class="p">(</span><span class="nv">v = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">a</span><span class="p">)</span>
    <span class="vi">@variable = </span><span class="nx">v</span> <span class="k">if</span> <span class="p">(</span><span class="nx">@variable</span> <span class="o">and</span> <span class="nv">v = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@variable</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Soaked chained invocations unfold into if/else ternary structures.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">unfoldSoak: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@soak</span>
      <span class="k">if</span> <span class="nx">@variable</span>
        <span class="k">return</span> <span class="nx">ifn</span> <span class="k">if</span> <span class="nv">ifn = </span><span class="nx">unfoldSoak</span> <span class="nx">o</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span>
        <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">rite</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">@variable</span><span class="p">).</span><span class="nx">cacheReference</span> <span class="nx">o</span>
      <span class="k">else</span>
        <span class="nv">left = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">@superReference</span> <span class="nx">o</span>
        <span class="nv">rite = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">left</span>
      <span class="nv">rite = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">rite</span><span class="p">,</span> <span class="nx">@args</span>
      <span class="nv">rite.isNew = </span><span class="nx">@isNew</span>
      <span class="nv">left = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;typeof #{ left.compile o } === \&quot;function\&quot;&quot;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">If</span> <span class="nx">left</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">rite</span><span class="p">),</span> <span class="nv">soak: </span><span class="kc">yes</span>
    <span class="nv">call = </span><span class="k">this</span>
    <span class="nv">list = </span><span class="p">[]</span>
    <span class="nx">loop</span>
      <span class="k">if</span> <span class="nx">call</span><span class="p">.</span><span class="nx">variable</span> <span class="k">instanceof</span> <span class="nx">Call</span>
        <span class="nx">list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">call</span>
        <span class="nv">call = </span><span class="nx">call</span><span class="p">.</span><span class="nx">variable</span>
        <span class="k">continue</span>
      <span class="k">break</span> <span class="nx">unless</span> <span class="nx">call</span><span class="p">.</span><span class="nx">variable</span> <span class="k">instanceof</span> <span class="nx">Value</span>
      <span class="nx">list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">call</span>
      <span class="k">break</span> <span class="nx">unless</span> <span class="p">(</span><span class="nv">call = </span><span class="nx">call</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">base</span><span class="p">)</span> <span class="k">instanceof</span> <span class="nx">Call</span>
    <span class="k">for</span> <span class="nx">call</span> <span class="k">in</span> <span class="nx">list</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">ifn</span>
        <span class="k">if</span> <span class="nx">call</span><span class="p">.</span><span class="nx">variable</span> <span class="k">instanceof</span> <span class="nx">Call</span>
          <span class="nv">call.variable = </span><span class="nx">ifn</span>
        <span class="k">else</span>
          <span class="nv">call.variable.base = </span><span class="nx">ifn</span>
      <span class="nv">ifn = </span><span class="nx">unfoldSoak</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">call</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span>
    <span class="nx">ifn</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>Walk through the objects in the arguments, moving over simple values.
This allows syntax like <code>call a: b, c</code> into <code>call({a: b}, c);</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">filterImplicitObjects: </span><span class="nf">(list) -&gt;</span>
    <span class="nv">nodes = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">list</span>
      <span class="nx">unless</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isObject</span><span class="o">?</span><span class="p">()</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">generated</span>
        <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">node</span>
        <span class="k">continue</span>
      <span class="nv">obj = </span><span class="kc">null</span>
      <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">node</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">properties</span>
        <span class="k">if</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Assign</span> <span class="o">or</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
          <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span> <span class="nv">obj = </span><span class="k">new</span> <span class="nx">Obj</span> <span class="nv">properties = </span><span class="p">[],</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">obj</span>
          <span class="nx">properties</span><span class="p">.</span><span class="nx">push</span> <span class="nx">prop</span>
        <span class="k">else</span>
          <span class="nx">nodes</span><span class="p">.</span><span class="nx">push</span> <span class="nx">prop</span>
          <span class="nv">obj = </span><span class="kc">null</span>
    <span class="nx">nodes</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Compile a vanilla function call.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@variable</span><span class="o">?</span><span class="p">.</span><span class="nv">front = </span><span class="nx">@front</span>
    <span class="k">if</span> <span class="nv">code = </span><span class="nx">Splat</span><span class="p">.</span><span class="nx">compileSplattedArray</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">@args</span><span class="p">,</span> <span class="kc">true</span>
      <span class="k">return</span> <span class="nx">@compileSplat</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">code</span>
    <span class="nv">args = </span><span class="nx">@filterImplicitObjects</span> <span class="nx">@args</span>
    <span class="nv">args = </span><span class="p">(</span><span class="nx">arg</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span> <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;, &#39;</span>
    <span class="k">if</span> <span class="nx">@isSuper</span>
      <span class="nx">@superReference</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.call(this#{ args and &#39;, &#39; + args })&quot;</span>
    <span class="k">else</span>
      <span class="p">(</span><span class="k">if</span> <span class="nx">@isNew</span> <span class="k">then</span> <span class="s1">&#39;new &#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_ACCESS</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;(#{args})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p><code>super()</code> is converted into a call against the superclass's implementation
of the current function.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileSuper: </span><span class="nf">(args, o) -&gt;</span>
    <span class="s2">&quot;#{@superReference(o)}.call(this#{ if args.length then &#39;, &#39; else &#39;&#39; }#{args})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>If you call a function with a splat, it's converted into a JavaScript
<code>.apply()</code> call to allow an array of arguments to be passed.
If it's a constructor, then things get real tricky. We have to inject an
inner constructor in order to be able to pass the varargs.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileSplat: </span><span class="nf">(o, splatArgs) -&gt;</span>
    <span class="k">return</span> <span class="s2">&quot;#{ @superReference o }.apply(this, #{splatArgs})&quot;</span> <span class="k">if</span> <span class="nx">@isSuper</span>
    <span class="k">if</span> <span class="nx">@isNew</span>
      <span class="nv">idt = </span><span class="nx">@tab</span> <span class="o">+</span> <span class="nx">TAB</span>
      <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        (function(func, args, ctor) {</span>
<span class="s2">        #{idt}ctor.prototype = func.prototype;</span>
<span class="s2">        #{idt}var child = new ctor, result = func.apply(child, args), t = typeof result;</span>
<span class="s2">        #{idt}return t == &quot;</span><span class="nx">object</span><span class="s2">&quot; || t == &quot;</span><span class="nx">function</span><span class="s2">&quot; ? result || child : child;</span>
<span class="s2">        #{@tab}})(#{ @variable.compile o, LEVEL_LIST }, #{splatArgs}, function(){})</span>
<span class="s2">      &quot;&quot;&quot;</span>
    <span class="nv">base = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">@variable</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">name = </span><span class="nx">base</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">pop</span><span class="p">())</span> <span class="o">and</span> <span class="nx">base</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
      <span class="nv">ref = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
      <span class="nv">fun = </span><span class="s2">&quot;(#{ref} = #{ base.compile o, LEVEL_LIST })#{ name.compile o }&quot;</span>
    <span class="k">else</span>
      <span class="nv">fun = </span><span class="nx">base</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_ACCESS</span>
      <span class="nv">fun = </span><span class="s2">&quot;(#{fun})&quot;</span> <span class="k">if</span> <span class="nx">SIMPLENUM</span><span class="p">.</span><span class="nx">test</span> <span class="nx">fun</span>
      <span class="k">if</span> <span class="nx">name</span>
        <span class="nv">ref = </span><span class="nx">fun</span>
        <span class="nx">fun</span> <span class="o">+=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
      <span class="k">else</span>
        <span class="nv">ref = </span><span class="s1">&#39;null&#39;</span>
    <span class="s2">&quot;#{fun}.apply(#{ref}, #{splatArgs})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <h3>Extends</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>Node to extend an object's prototype with an ancestor object.
After <code>goog.inherits</code> from the
<a href="http://closure-library.googlecode.com/svn/docs/closureGoogBase.js.html">Closure Library</a>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Extends = </span><span class="k">class</span> <span class="nx">Extends</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@child, @parent) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;child&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Hooks one constructor into another's prototype chain.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compile: </span><span class="nf">(o) -&gt;</span>
    <span class="k">new</span> <span class="nx">Call</span><span class="p">(</span><span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">utility</span> <span class="s1">&#39;extends&#39;</span><span class="p">),</span> <span class="p">[</span><span class="nx">@child</span><span class="p">,</span> <span class="nx">@parent</span><span class="p">]).</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h3>Access</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>A <code>.</code> access into a property of a value, or the <code>::</code> shorthand for
an access into the object's prototype.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Access = </span><span class="k">class</span> <span class="nx">Access</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@name, tag) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@name.asKey = </span><span class="kc">yes</span>
    <span class="vi">@soak  = </span><span class="nx">tag</span> <span class="o">is</span> <span class="s1">&#39;soak&#39;</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

  <span class="nv">compile: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">name = </span><span class="nx">@name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span> <span class="nx">name</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">@name</span> <span class="k">instanceof</span> <span class="nx">Defer</span><span class="p">)</span> <span class="k">then</span> <span class="s2">&quot;.#{name}&quot;</span> <span class="k">else</span> <span class="s2">&quot;[#{name}]&quot;</span>

  <span class="nv">isComplex: </span><span class="nx">NO</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h3>Index</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p>A <code>[ ... ]</code> indexed access into an array or object.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Index = </span><span class="k">class</span> <span class="nx">Index</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@index) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span>

  <span class="nv">compile: </span><span class="nf">(o) -&gt;</span>
    <span class="s2">&quot;[#{ @index.compile o, LEVEL_PAREN }]&quot;</span>

  <span class="nv">isComplex: </span><span class="o">-&gt;</span>
    <span class="nx">@index</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <h3>Range</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <p>A range literal. Ranges can be used to extract portions (slices) of arrays,
to specify a range for comprehensions, or as a value, to be expanded into the
corresponding array of integers at runtime.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Range = </span><span class="k">class</span> <span class="nx">Range</span> <span class="k">extends</span> <span class="nx">Base</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;from&#39;</span><span class="p">,</span> <span class="s1">&#39;to&#39;</span><span class="p">]</span>

  <span class="nv">constructor: </span><span class="nf">(@from, @to, tag) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@exclusive = </span><span class="nx">tag</span> <span class="o">is</span> <span class="s1">&#39;exclusive&#39;</span>
    <span class="vi">@equals = </span><span class="k">if</span> <span class="nx">@exclusive</span> <span class="k">then</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="s1">&#39;=&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <p>Compiles the range's source variables -- where it starts and where it ends.
But only if they need to be cached to avoid double evaluation.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileVariables: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">o = </span><span class="nx">merge</span> <span class="nx">o</span><span class="p">,</span> <span class="nv">top: </span><span class="kc">true</span>
    <span class="p">[</span><span class="nx">@fromC</span><span class="p">,</span> <span class="nx">@fromVar</span><span class="p">]</span>  <span class="o">=</span>  <span class="nx">@from</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="p">[</span><span class="nx">@toC</span><span class="p">,</span> <span class="nx">@toVar</span><span class="p">]</span>      <span class="o">=</span>  <span class="nx">@to</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="p">[</span><span class="nx">@step</span><span class="p">,</span> <span class="nx">@stepVar</span><span class="p">]</span>   <span class="o">=</span>  <span class="nx">step</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span> <span class="k">if</span> <span class="nv">step = </span><span class="nx">del</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span>
    <span class="p">[</span><span class="nx">@fromNum</span><span class="p">,</span> <span class="nx">@toNum</span><span class="p">]</span>  <span class="o">=</span> <span class="p">[</span><span class="nx">@fromVar</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">SIMPLENUM</span><span class="p">),</span> <span class="nx">@toVar</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">SIMPLENUM</span><span class="p">)]</span>
    <span class="vi">@stepNum            = </span><span class="nx">@stepVar</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">SIMPLENUM</span><span class="p">)</span> <span class="k">if</span> <span class="nx">@stepVar</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <p>When compiled normally, the range returns the contents of the <em>for loop</em>
needed to iterate over the values in the range. Used by comprehensions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@compileVariables</span> <span class="nx">o</span> <span class="nx">unless</span> <span class="nx">@fromVar</span>
    <span class="k">return</span> <span class="nx">@compileArray</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">o</span><span class="p">.</span><span class="nx">index</span></pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <p>Set up endpoints.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">known    = </span><span class="nx">@fromNum</span> <span class="o">and</span> <span class="nx">@toNum</span>
    <span class="nv">idx      = </span><span class="nx">del</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span>
    <span class="nv">idxName  = </span><span class="nx">del</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span>
    <span class="nv">namedIndex = </span><span class="nx">idxName</span> <span class="o">and</span> <span class="nx">idxName</span> <span class="o">isnt</span> <span class="nx">idx</span>
    <span class="nv">varPart  = </span><span class="s2">&quot;#{idx} = #{@fromC}&quot;</span>
    <span class="nx">varPart</span> <span class="o">+=</span> <span class="s2">&quot;, #{@toC}&quot;</span> <span class="k">if</span> <span class="nx">@toC</span> <span class="o">isnt</span> <span class="nx">@toVar</span>
    <span class="nx">varPart</span> <span class="o">+=</span> <span class="s2">&quot;, #{@step}&quot;</span> <span class="k">if</span> <span class="nx">@step</span> <span class="o">isnt</span> <span class="nx">@stepVar</span>
    <span class="p">[</span><span class="nx">lt</span><span class="p">,</span> <span class="nx">gt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#{idx} &lt;#{@equals}&quot;</span><span class="p">,</span> <span class="s2">&quot;#{idx} &gt;#{@equals}&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <p>Generate the condition.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">condPart = </span><span class="k">if</span> <span class="nx">@stepNum</span>
      <span class="k">if</span> <span class="o">+</span><span class="nx">@stepNum</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="s2">&quot;#{lt} #{@toVar}&quot;</span> <span class="k">else</span> <span class="s2">&quot;#{gt} #{@toVar}&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">known</span>
      <span class="p">[</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="o">+</span><span class="nx">@fromNum</span><span class="p">,</span> <span class="o">+</span><span class="nx">@toNum</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">to</span> <span class="k">then</span> <span class="s2">&quot;#{lt} #{to}&quot;</span> <span class="k">else</span> <span class="s2">&quot;#{gt} #{to}&quot;</span>
    <span class="k">else</span>
      <span class="nv">cond     = </span><span class="s2">&quot;#{@fromVar} &lt;= #{@toVar}&quot;</span>
      <span class="s2">&quot;#{cond} ? #{lt} #{@toVar} : #{gt} #{@toVar}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>Generate the step.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stepPart = </span><span class="k">if</span> <span class="nx">@stepVar</span>
      <span class="s2">&quot;#{idx} += #{@stepVar}&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">known</span>
      <span class="k">if</span> <span class="nx">namedIndex</span>
        <span class="k">if</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">to</span> <span class="k">then</span> <span class="s2">&quot;++#{idx}&quot;</span> <span class="k">else</span> <span class="s2">&quot;--#{idx}&quot;</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">from</span> <span class="o">&lt;=</span> <span class="nx">to</span> <span class="k">then</span> <span class="s2">&quot;#{idx}++&quot;</span> <span class="k">else</span> <span class="s2">&quot;#{idx}--&quot;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">namedIndex</span>
        <span class="s2">&quot;#{cond} ? ++#{idx} : --#{idx}&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;#{cond} ? #{idx}++ : #{idx}--&quot;</span>

    <span class="nv">varPart  = </span><span class="s2">&quot;#{idxName} = #{varPart}&quot;</span> <span class="k">if</span> <span class="nx">namedIndex</span>
    <span class="nv">stepPart = </span><span class="s2">&quot;#{idxName} = #{stepPart}&quot;</span> <span class="k">if</span> <span class="nx">namedIndex</span></pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <p>The final loop body.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="s2">&quot;#{varPart}; #{condPart}; #{stepPart}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>When used as a value, expand the range into the equivalent array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileArray: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@fromNum</span> <span class="o">and</span> <span class="nx">@toNum</span> <span class="o">and</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">@fromNum</span> <span class="o">-</span> <span class="nx">@toNum</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">20</span>
      <span class="nv">range = </span><span class="p">[</span><span class="o">+</span><span class="nx">@fromNum</span><span class="p">..</span><span class="o">+</span><span class="nx">@toNum</span><span class="p">]</span>
      <span class="nx">range</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@exclusive</span>
      <span class="k">return</span> <span class="s2">&quot;[#{ range.join(&#39;, &#39;) }]&quot;</span>
    <span class="nv">idt    = </span><span class="nx">@tab</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="nv">i      = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;i&#39;</span>
    <span class="nv">result = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;results&#39;</span>
    <span class="nv">pre    = </span><span class="s2">&quot;\n#{idt}#{result} = [];&quot;</span>
    <span class="k">if</span> <span class="nx">@fromNum</span> <span class="o">and</span> <span class="nx">@toNum</span>
      <span class="nv">o.index = </span><span class="nx">i</span>
      <span class="nv">body    = </span><span class="nx">@compileNode</span> <span class="nx">o</span>
    <span class="k">else</span>
      <span class="nv">vars    = </span><span class="s2">&quot;#{i} = #{@fromC}&quot;</span> <span class="o">+</span> <span class="k">if</span> <span class="nx">@toC</span> <span class="o">isnt</span> <span class="nx">@toVar</span> <span class="k">then</span> <span class="s2">&quot;, #{@toC}&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
      <span class="nv">cond    = </span><span class="s2">&quot;#{@fromVar} &lt;= #{@toVar}&quot;</span>
      <span class="nv">body    = </span><span class="s2">&quot;var #{vars}; #{cond} ? #{i} &lt;#{@equals} #{@toVar} : #{i} &gt;#{@equals} #{@toVar}; #{cond} ? #{i}++ : #{i}--&quot;</span>
    <span class="nv">post   = </span><span class="s2">&quot;{ #{result}.push(#{i}); }\n#{idt}return #{result};\n#{o.indent}&quot;</span>
    <span class="nv">hasArgs = </span><span class="nf">(node) -&gt;</span> <span class="nx">node</span><span class="o">?</span><span class="p">.</span><span class="nx">contains</span> <span class="nf">(n) -&gt;</span> <span class="nx">n</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">n</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;arguments&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">n</span><span class="p">.</span><span class="nx">asKey</span>
    <span class="nv">args   = </span><span class="s1">&#39;, arguments&#39;</span> <span class="k">if</span> <span class="nx">hasArgs</span><span class="p">(</span><span class="nx">@from</span><span class="p">)</span> <span class="o">or</span> <span class="nx">hasArgs</span><span class="p">(</span><span class="nx">@to</span><span class="p">)</span>
    <span class="s2">&quot;(function() {#{pre}\n#{idt}for (#{body})#{post}}).apply(this#{args ? &#39;&#39;})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <h3>Slice</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <p>An array slice literal. Unlike JavaScript's <code>Array#slice</code>, the second parameter
specifies the index of the end of the slice, just as the first parameter
is the index of the beginning.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Slice = </span><span class="k">class</span> <span class="nx">Slice</span> <span class="k">extends</span> <span class="nx">Base</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;range&#39;</span><span class="p">]</span>

  <span class="nv">constructor: </span><span class="nf">(@range) -&gt;</span>
    <span class="k">super</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>We have to be careful when trying to slice through the end of the array,
<code>9e9</code> is used because not all implementations respect <code>undefined</code> or <code>1/0</code>.
<code>9e9</code> should be safe because <code>9e9</code> > <code>2**32</code>, the max array length.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="p">{</span><span class="nx">to</span><span class="p">,</span> <span class="nx">from</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@range</span>
    <span class="nv">fromStr    = </span><span class="nx">from</span> <span class="o">and</span> <span class="nx">from</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_PAREN</span><span class="p">)</span> <span class="o">or</span> <span class="s1">&#39;0&#39;</span>
    <span class="nv">compiled   = </span><span class="nx">to</span> <span class="o">and</span> <span class="nx">to</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_PAREN</span>
    <span class="k">if</span> <span class="nx">to</span> <span class="o">and</span> <span class="o">not</span> <span class="p">(</span><span class="o">not</span> <span class="nx">@range</span><span class="p">.</span><span class="nx">exclusive</span> <span class="o">and</span> <span class="o">+</span><span class="nx">compiled</span> <span class="o">is</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
      <span class="nv">toStr = </span><span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="k">if</span> <span class="nx">@range</span><span class="p">.</span><span class="nx">exclusive</span>
        <span class="nx">compiled</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">SIMPLENUM</span><span class="p">.</span><span class="nx">test</span> <span class="nx">compiled</span>
        <span class="s2">&quot;#{+compiled + 1}&quot;</span>
      <span class="k">else</span>
        <span class="nv">compiled = </span><span class="nx">to</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_ACCESS</span>
        <span class="s2">&quot;#{compiled} + 1 || 9e9&quot;</span>
    <span class="s2">&quot;.slice(#{ fromStr }#{ toStr or &#39;&#39; })&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <h3>Obj</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>An object literal, nothing fancy.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Obj = </span><span class="k">class</span> <span class="nx">Obj</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(props, @generated = false) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@objects = @properties = </span><span class="nx">props</span> <span class="o">or</span> <span class="p">[]</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;properties&#39;</span><span class="p">]</span>

  <span class="nv">toSlot : </span><span class="nf">(i) -&gt;</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">@properties</span> <span class="k">when</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
      <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">toSlot</span> <span class="nx">i</span><span class="p">).</span><span class="nx">addAccess</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">variable</span>

  <span class="nv">icedWrapContinuation : </span><span class="nx">YES</span>
  <span class="nv">icedCpsRotate : </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">@properties</span> <span class="k">when</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
      <span class="nv">prop.value = </span><span class="nx">v</span> <span class="k">if</span> <span class="p">(</span><span class="nv">v = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">props = </span><span class="nx">@properties</span>
    <span class="nv">propNames = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">@properties</span>
      <span class="nv">prop = </span><span class="nx">prop</span><span class="p">.</span><span class="nx">variable</span> <span class="k">if</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">prop</span><span class="o">?</span>
        <span class="nv">propName = </span><span class="nx">prop</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">().</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">propName</span> <span class="k">in</span> <span class="nx">propNames</span>
          <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;multiple object literal properties named \&quot;#{propName}\&quot;&quot;</span>
        <span class="nx">propNames</span><span class="p">.</span><span class="nx">push</span> <span class="nx">propName</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">if</span> <span class="nx">@front</span> <span class="k">then</span> <span class="s1">&#39;({})&#39;</span> <span class="k">else</span> <span class="s1">&#39;{}&#39;</span><span class="p">)</span> <span class="nx">unless</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">@generated</span>
      <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">props</span> <span class="k">when</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Value</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;cannot have an implicit value in an implicit object&#39;</span>
    <span class="nv">idt         = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="nv">lastNoncom  = </span><span class="nx">@lastNonComment</span> <span class="nx">@properties</span>
    <span class="nv">props = </span><span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">props</span>
      <span class="nv">join = </span><span class="k">if</span> <span class="nx">i</span> <span class="o">is</span> <span class="nx">props</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="s1">&#39;&#39;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">prop</span> <span class="o">is</span> <span class="nx">lastNoncom</span> <span class="o">or</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
        <span class="s1">&#39;\n&#39;</span>
      <span class="k">else</span>
        <span class="s1">&#39;,\n&#39;</span>
      <span class="nv">indent = </span><span class="k">if</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Comment</span> <span class="k">then</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="nx">idt</span>
      <span class="k">if</span> <span class="nx">prop</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">prop</span><span class="p">.</span><span class="k">this</span>
        <span class="nv">prop = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">if</span> <span class="nx">prop</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Comment</span>
        <span class="k">if</span> <span class="nx">prop</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
          <span class="nv">prop = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">prop</span><span class="p">,</span> <span class="s1">&#39;object&#39;</span>
        <span class="p">(</span><span class="nx">prop</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">base</span> <span class="o">or</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">variable</span><span class="p">).</span><span class="nv">asKey = </span><span class="kc">yes</span>
      <span class="nx">indent</span> <span class="o">+</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span><span class="p">)</span> <span class="o">+</span> <span class="nx">join</span>
    <span class="nv">props = </span><span class="nx">props</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>
    <span class="nv">obj   = </span><span class="s2">&quot;{#{ props and &#39;\n&#39; + props + &#39;\n&#39; + @tab }}&quot;</span>
    <span class="k">if</span> <span class="nx">@front</span> <span class="k">then</span> <span class="s2">&quot;(#{obj})&quot;</span> <span class="k">else</span> <span class="nx">obj</span>

  <span class="nv">assigns: </span><span class="nf">(name) -&gt;</span>
    <span class="k">for</span> <span class="nx">prop</span> <span class="k">in</span> <span class="nx">@properties</span> <span class="k">when</span> <span class="nx">prop</span><span class="p">.</span><span class="nx">assigns</span> <span class="nx">name</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">yes</span>
    <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <h3>Arr</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>An array literal.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Arr = </span><span class="k">class</span> <span class="nx">Arr</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(objs) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@objects = </span><span class="nx">objs</span> <span class="o">or</span> <span class="p">[]</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]</span>

  <span class="nv">filterImplicitObjects: </span><span class="nx">Call</span><span class="o">::</span><span class="nx">filterImplicitObjects</span>

  <span class="nv">icedWrapContinuation : </span><span class="nx">YES</span>
  <span class="nv">icedCpsRotate: </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="nx">o</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">@objects</span>
      <span class="nx">@objects</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span> <span class="k">if</span> <span class="p">(</span><span class="nv">v = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">o</span><span class="p">)</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="s1">&#39;[]&#39;</span> <span class="nx">unless</span> <span class="nx">@objects</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="nv">objs = </span><span class="nx">@filterImplicitObjects</span> <span class="nx">@objects</span>
    <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nv">code = </span><span class="nx">Splat</span><span class="p">.</span><span class="nx">compileSplattedArray</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">objs</span>
    <span class="nv">code = </span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span> <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">objs</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;, &#39;</span>
    <span class="k">if</span> <span class="nx">code</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="s2">&quot;[\n#{o.indent}#{code}\n#{@tab}]&quot;</span>
    <span class="k">else</span>
      <span class="s2">&quot;[#{code}]&quot;</span>

  <span class="nv">assigns: </span><span class="nf">(name) -&gt;</span>
    <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">@objects</span> <span class="k">when</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">assigns</span> <span class="nx">name</span> <span class="k">then</span> <span class="k">return</span> <span class="kc">yes</span>
    <span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h3>Class</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>The CoffeeScript class definition.
Initialize a <strong>Class</strong> with its name, an optional superclass, and a
list of prototype property assignments.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Class = </span><span class="k">class</span> <span class="nx">Class</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@variable, @parent, @body = new Block) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@boundFuncs = </span><span class="p">[]</span>
    <span class="vi">@body.classBody = </span><span class="kc">yes</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <p>Figure out the appropriate name for the constructor function of this class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">determineName: </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">@variable</span>
    <span class="nv">decl = </span><span class="k">if</span> <span class="nv">tail = </span><span class="nx">last</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">properties</span>
      <span class="nx">tail</span> <span class="k">instanceof</span> <span class="nx">Access</span> <span class="o">and</span> <span class="nx">tail</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span>
    <span class="k">else</span>
      <span class="nx">@variable</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">value</span>
    <span class="k">if</span> <span class="nx">decl</span> <span class="k">in</span> <span class="nx">STRICT_PROSCRIBED</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;variable name may not be #{decl}&quot;</span>
    <span class="nx">decl</span> <span class="o">and=</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">decl</span><span class="p">)</span> <span class="o">and</span> <span class="nx">decl</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <p>For all <code>this</code>-references and bound functions in the class definition,
<code>this</code> is the Class being constructed.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">setContext: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">traverseChildren</span> <span class="kc">false</span><span class="p">,</span> <span class="nf">(node) -&gt;</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">classBody</span>
      <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;this&#39;</span>
        <span class="nv">node.value    = </span><span class="nx">name</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Code</span>
        <span class="nv">node.klass    = </span><span class="nx">name</span>
        <span class="nv">node.context  = </span><span class="nx">name</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">bound</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <p>Ensure that all functions bound to the instance are proxied in the
constructor.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addBoundFunctions: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@boundFuncs</span><span class="p">.</span><span class="nx">length</span>
      <span class="k">for</span> <span class="nx">bvar</span> <span class="k">in</span> <span class="nx">@boundFuncs</span>
        <span class="nv">lhs = </span><span class="p">(</span><span class="k">new</span> <span class="nx">Value</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;this&quot;</span><span class="p">),</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Access</span> <span class="nx">bvar</span><span class="p">]).</span><span class="nx">compile</span> <span class="nx">o</span>
        <span class="nx">@ctor</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;#{lhs} = #{utility &#39;bind&#39;}(#{lhs}, this)&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>Merge the properties from a top-level object as prototypal properties
on the class.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addProperties: </span><span class="nf">(node, name, o) -&gt;</span>
    <span class="nv">props = </span><span class="nx">node</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">properties</span><span class="p">[..]</span>
    <span class="nv">exprs = </span><span class="k">while</span> <span class="nv">assign = </span><span class="nx">props</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
      <span class="k">if</span> <span class="nx">assign</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
        <span class="nv">base = </span><span class="nx">assign</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">base</span>
        <span class="k">delete</span> <span class="nx">assign</span><span class="p">.</span><span class="nx">context</span>
        <span class="nv">func = </span><span class="nx">assign</span><span class="p">.</span><span class="nx">value</span>
        <span class="k">if</span> <span class="nx">base</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;constructor&#39;</span>
          <span class="k">if</span> <span class="nx">@ctor</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;cannot define more than one constructor in a class&#39;</span>
          <span class="k">if</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bound</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s1">&#39;cannot define a constructor as a bound function&#39;</span>
          <span class="k">if</span> <span class="nx">func</span> <span class="k">instanceof</span> <span class="nx">Code</span>
            <span class="nv">assign = </span><span class="vi">@ctor = </span><span class="nx">func</span>
          <span class="k">else</span>
            <span class="vi">@externalCtor = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;class&#39;</span>
            <span class="nv">assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="nx">@externalCtor</span><span class="p">),</span> <span class="nx">func</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">assign</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="k">this</span>
            <span class="nv">func.static = </span><span class="kc">yes</span>
            <span class="k">if</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bound</span>
              <span class="nv">func.context = </span><span class="nx">name</span>
          <span class="k">else</span>
            <span class="nv">assign.variable = </span><span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="nx">name</span><span class="p">),</span> <span class="p">[(</span><span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;prototype&#39;</span><span class="p">),</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">base</span> <span class="p">])</span>
            <span class="k">if</span> <span class="nx">func</span> <span class="k">instanceof</span> <span class="nx">Code</span> <span class="o">and</span> <span class="nx">func</span><span class="p">.</span><span class="nx">bound</span>
              <span class="nx">@boundFuncs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">base</span>
              <span class="nv">func.bound = </span><span class="kc">no</span>
      <span class="nx">assign</span>
    <span class="nx">compact</span> <span class="nx">exprs</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>Walk the body of the class, looking for prototype properties to be converted.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">walkBody: </span><span class="nf">(name, o) -&gt;</span>
    <span class="nx">@traverseChildren</span> <span class="kc">false</span><span class="p">,</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">child</span> <span class="k">instanceof</span> <span class="nx">Class</span>
      <span class="k">if</span> <span class="nx">child</span> <span class="k">instanceof</span> <span class="nx">Block</span>
        <span class="k">for</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nv">exps = </span><span class="nx">child</span><span class="p">.</span><span class="nx">expressions</span>
          <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
            <span class="nx">exps</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@addProperties</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">o</span>
        <span class="nv">child.expressions = exps = </span><span class="nx">flatten</span> <span class="nx">exps</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p><code>use strict</code> (and other directives) must be the first expression statement(s)
of a function body. This method ensures the prologue is correctly positioned
above the <code>constructor</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hoistDirectivePrologue: </span><span class="o">-&gt;</span>
    <span class="nv">index = </span><span class="mi">0</span>
    <span class="p">{</span><span class="nx">expressions</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@body</span>
    <span class="o">++</span><span class="nx">index</span> <span class="k">while</span> <span class="p">(</span><span class="nv">node = </span><span class="nx">expressions</span><span class="p">[</span><span class="nx">index</span><span class="p">])</span> <span class="o">and</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Comment</span> <span class="o">or</span>
      <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isString</span><span class="p">()</span> <span class="o">or</span>
      <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">IcedRuntime</span>
    <span class="vi">@directives = </span><span class="nx">expressions</span><span class="p">.</span><span class="nx">splice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">index</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>Make sure that a constructor is defined for the class, and properly
configured.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ensureConstructor: </span><span class="nf">(name) -&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">@ctor</span>
      <span class="vi">@ctor = </span><span class="k">new</span> <span class="nx">Code</span>
      <span class="nx">@ctor</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;#{name}.__super__.constructor.apply(this, arguments)&quot;</span> <span class="k">if</span> <span class="nx">@parent</span>
      <span class="nx">@ctor</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;#{@externalCtor}.apply(this, arguments)&quot;</span> <span class="k">if</span> <span class="nx">@externalCtor</span>
      <span class="nx">@ctor</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">makeReturn</span><span class="p">()</span>
      <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">@ctor</span>
    <span class="vi">@ctor.ctor     = @ctor.name = </span><span class="nx">name</span>
    <span class="vi">@ctor.klass    = </span><span class="kc">null</span>
    <span class="vi">@ctor.noReturn = </span><span class="kc">yes</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>Instead of generating the JavaScript string directly, we build up the
equivalent syntax tree and compile that, in pieces. You can see the
constructor, property assignments, and inheritance getting built out below.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">decl  = </span><span class="nx">@determineName</span><span class="p">()</span>
    <span class="nv">name  = </span><span class="nx">decl</span> <span class="o">or</span> <span class="s1">&#39;_Class&#39;</span>
    <span class="nv">name = </span><span class="s2">&quot;_#{name}&quot;</span> <span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">reserved</span>
    <span class="nv">lname = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">name</span>

    <span class="nx">@hoistDirectivePrologue</span><span class="p">()</span>
    <span class="nx">@setContext</span> <span class="nx">name</span>
    <span class="nx">@walkBody</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">o</span>
    <span class="nx">@ensureConstructor</span> <span class="nx">name</span>
    <span class="vi">@body.spaced = </span><span class="kc">yes</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">@ctor</span> <span class="nx">unless</span> <span class="nx">@ctor</span> <span class="k">instanceof</span> <span class="nx">Code</span>
    <span class="k">if</span> <span class="nx">decl</span>
      <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Value</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">name</span><span class="p">),</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;name&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;&#39;#{name}&#39;&quot;</span><span class="p">)</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">lname</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">@directives</span><span class="p">...</span>
    <span class="nx">@addBoundFunctions</span> <span class="nx">o</span>

    <span class="nv">call  = </span><span class="nx">Closure</span><span class="p">.</span><span class="nx">wrap</span> <span class="nx">@body</span>

    <span class="k">if</span> <span class="nx">@parent</span>
      <span class="vi">@superClass = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;super&#39;</span><span class="p">,</span> <span class="kc">no</span>
      <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">Extends</span> <span class="nx">lname</span><span class="p">,</span> <span class="nx">@superClass</span>
      <span class="nx">call</span><span class="p">.</span><span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@parent</span>
      <span class="nv">params = </span><span class="nx">call</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">params</span> <span class="o">or</span> <span class="nx">call</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">params</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Param</span> <span class="nx">@superClass</span>

    <span class="nv">klass = </span><span class="k">new</span> <span class="nx">Parens</span> <span class="nx">call</span><span class="p">,</span> <span class="kc">yes</span>
    <span class="nv">klass = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@variable</span><span class="p">,</span> <span class="nx">klass</span> <span class="k">if</span> <span class="nx">@variable</span>
    <span class="nx">klass</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <h3>Assign</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <p>The <strong>Assign</strong> is used to assign a local variable to value, or to set the
property of an object -- including within object literals.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Assign = </span><span class="k">class</span> <span class="nx">Assign</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@variable, @value, @context, options) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@param = </span><span class="nx">options</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">param</span>
    <span class="vi">@subpattern = </span><span class="nx">options</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">subpattern</span>
    <span class="nv">forbidden = </span><span class="p">(</span><span class="nv">name = </span><span class="nx">@variable</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">().</span><span class="nx">value</span><span class="p">)</span> <span class="k">in</span> <span class="nx">STRICT_PROSCRIBED</span>
    <span class="k">if</span> <span class="nx">forbidden</span> <span class="o">and</span> <span class="nx">@context</span> <span class="o">isnt</span> <span class="s1">&#39;object&#39;</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;variable name may not be \&quot;#{name}\&quot;&quot;</span>
    <span class="vi">@icedlocal = </span><span class="nx">options</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">icedlocal</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span> <span class="o">and</span> <span class="nx">@context</span><span class="o">?</span> <span class="o">and</span> <span class="s2">&quot;?&quot;</span> <span class="k">in</span> <span class="nx">@context</span>

  <span class="nv">assigns: </span><span class="nf">(name) -&gt;</span>
    <span class="err">@</span><span class="p">[</span><span class="k">if</span> <span class="nx">@context</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span> <span class="k">then</span> <span class="s1">&#39;value&#39;</span> <span class="k">else</span> <span class="s1">&#39;variable&#39;</span><span class="p">].</span><span class="nx">assigns</span> <span class="nx">name</span>

  <span class="nv">unfoldSoak: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">unfoldSoak</span> <span class="nx">o</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <p>If our value needs a CPS rotation....</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedCpsRotate : </span> <span class="o">-&gt;</span>
    <span class="vi">@value = </span><span class="nx">nv</span> <span class="k">if</span> <span class="p">(</span><span class="nv">nv = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <p>Compile an assignment, delegating to <code>compilePatternMatch</code> or
<code>compileSplice</code> if appropriate. Keep track of the name of the base object
we've been assigned to, for correct internal references. If the variable
has not been seen yet within the current scope, declare it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nv">isValue = </span><span class="nx">@variable</span> <span class="k">instanceof</span> <span class="nx">Value</span>
      <span class="k">return</span> <span class="nx">@compilePatternMatch</span> <span class="nx">o</span> <span class="k">if</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">isArray</span><span class="p">()</span> <span class="o">or</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">isObject</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@compileSplice</span>       <span class="nx">o</span> <span class="k">if</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">isSplice</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">@compileConditional</span>  <span class="nx">o</span> <span class="k">if</span> <span class="nx">@context</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;||=&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;=&#39;</span><span class="p">,</span> <span class="s1">&#39;?=&#39;</span><span class="p">]</span>
    <span class="nv">name = </span><span class="nx">@variable</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nx">unless</span> <span class="nx">@context</span>
      <span class="nx">unless</span> <span class="p">(</span><span class="nv">varBase = </span><span class="nx">@variable</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()).</span><span class="nx">isAssignable</span><span class="p">()</span>
        <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;\&quot;#{ @variable.compile o }\&quot; cannot be assigned.&quot;</span>
      <span class="nx">unless</span> <span class="nx">varBase</span><span class="p">.</span><span class="nx">hasProperties</span><span class="o">?</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">@param</span> <span class="o">or</span> <span class="nx">@icedlocal</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">add</span> <span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="nx">@icedlocal</span>
        <span class="k">else</span>
          <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">find</span> <span class="nx">name</span>
    <span class="k">if</span> <span class="nx">@value</span> <span class="k">instanceof</span> <span class="nx">Code</span> <span class="o">and</span> <span class="nv">match = </span><span class="nx">METHOD_DEF</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">name</span>
      <span class="vi">@value.klass = </span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="vi">@value.name  = </span><span class="nx">match</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">?</span> <span class="nx">match</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    <span class="nv">val = </span><span class="nx">@value</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="k">return</span> <span class="s2">&quot;#{name}: #{val}&quot;</span> <span class="k">if</span> <span class="nx">@context</span> <span class="o">is</span> <span class="s1">&#39;object&#39;</span>
    <span class="nv">val = </span><span class="nx">name</span> <span class="o">+</span> <span class="s2">&quot; #{ @context or &#39;=&#39; } &quot;</span> <span class="o">+</span> <span class="nx">val</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;=</span> <span class="nx">LEVEL_LIST</span> <span class="k">then</span> <span class="nx">val</span> <span class="k">else</span> <span class="s2">&quot;(#{val})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <p>Brief implementation of recursive pattern matching, when assigning array or
object literals to a value. Peeks at their properties to assign inner names.
See the <a href="http://wiki.ecmascript.org/doku.php?id=harmony:destructuring">ECMAScript Harmony Wiki</a>
for details.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compilePatternMatch: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">top       = </span><span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span>
    <span class="p">{</span><span class="nx">value</span><span class="p">}</span>   <span class="o">=</span> <span class="k">this</span>
    <span class="p">{</span><span class="nx">objects</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">base</span>
    <span class="nx">unless</span> <span class="nv">olen = </span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">code = </span><span class="nx">value</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_OP</span> <span class="k">then</span> <span class="s2">&quot;(#{code})&quot;</span> <span class="k">else</span> <span class="nx">code</span>
    <span class="nv">isObject = </span><span class="nx">@variable</span><span class="p">.</span><span class="nx">isObject</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">top</span> <span class="o">and</span> <span class="nx">olen</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span> <span class="p">(</span><span class="nv">obj = </span><span class="nx">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Splat</span></pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <p>Unroll simplest cases: <code>{v} = x</code> -> <code>v = x.v</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
        <span class="p">{</span><span class="nv">variable: </span><span class="p">{</span><span class="nv">base: </span><span class="nx">idx</span><span class="p">},</span> <span class="nv">value: </span><span class="nx">obj</span><span class="p">}</span> <span class="o">=</span> <span class="nx">obj</span>
      <span class="k">else</span>
        <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Parens</span>
          <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()).</span><span class="nx">cacheReference</span> <span class="nx">o</span>
        <span class="k">else</span>
          <span class="nv">idx = </span><span class="k">if</span> <span class="nx">isObject</span>
            <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="k">this</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span> <span class="k">else</span> <span class="nx">obj</span>
          <span class="k">else</span>
            <span class="k">new</span> <span class="nx">Literal</span> <span class="mi">0</span>
      <span class="nv">acc   = </span><span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span> <span class="nx">idx</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">value</span> <span class="o">or</span> <span class="mi">0</span>
      <span class="nv">value = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">value</span>
      <span class="nx">value</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="p">(</span><span class="k">if</span> <span class="nx">acc</span> <span class="k">then</span> <span class="nx">Access</span> <span class="k">else</span> <span class="nx">Index</span><span class="p">)</span> <span class="nx">idx</span>
      <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">RESERVED</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;assignment to a reserved word: #{obj.compile o} = #{value.compile o}&quot;</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Assign</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">param: </span><span class="nx">@param</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span>
    <span class="nv">vvar    = </span><span class="nx">value</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nv">assigns = </span><span class="p">[]</span>
    <span class="nv">splat   = </span><span class="kc">false</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">vvar</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">assigns</span><span class="p">(</span><span class="nx">vvar</span><span class="p">)</span>
      <span class="nx">assigns</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;#{ ref = o.scope.freeVariable &#39;ref&#39; } = #{vvar}&quot;</span>
      <span class="nv">vvar = </span><span class="nx">ref</span>
    <span class="k">for</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">objects</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <p>A regular array pattern-match.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">idx = </span><span class="nx">i</span>
      <span class="k">if</span> <span class="nx">isObject</span>
        <span class="k">if</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Assign</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <p>A regular object pattern-match.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="p">{</span><span class="nv">variable: </span><span class="p">{</span><span class="nv">base: </span><span class="nx">idx</span><span class="p">},</span> <span class="nv">value: </span><span class="nx">obj</span><span class="p">}</span> <span class="o">=</span> <span class="nx">obj</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>A shorthand <code>{a, b, @c} = val</code> pattern-match.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Parens</span>
            <span class="p">[</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()).</span><span class="nx">cacheReference</span> <span class="nx">o</span>
          <span class="k">else</span>
            <span class="nv">idx = </span><span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="k">this</span> <span class="k">then</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span> <span class="k">else</span> <span class="nx">obj</span>
      <span class="k">if</span> <span class="o">not</span> <span class="nx">splat</span> <span class="o">and</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Splat</span>
        <span class="nv">name = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">value</span>
        <span class="nv">obj = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
        <span class="nv">val = </span><span class="s2">&quot;#{olen} &lt;= #{vvar}.length ? #{ utility &#39;slice&#39; }.call(#{vvar}, #{i}&quot;</span>
        <span class="k">if</span> <span class="nv">rest = </span><span class="nx">olen</span> <span class="o">-</span> <span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span>
          <span class="nv">ivar = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;i&#39;</span>
          <span class="nx">val</span> <span class="o">+=</span> <span class="s2">&quot;, #{ivar} = #{vvar}.length - #{rest}) : (#{ivar} = #{i}, [])&quot;</span>
        <span class="k">else</span>
          <span class="nx">val</span> <span class="o">+=</span> <span class="s2">&quot;) : []&quot;</span>
        <span class="nv">val   = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">val</span>
        <span class="nv">splat = </span><span class="s2">&quot;#{ivar}++&quot;</span>
      <span class="k">else</span>
        <span class="nv">name = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">value</span>
        <span class="k">if</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Splat</span>
          <span class="nv">obj = </span><span class="nx">obj</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nx">SyntaxError</span> <span class="o">\</span>
            <span class="s2">&quot;multiple splats are disallowed in an assignment: #{obj}...&quot;</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">idx</span> <span class="o">is</span> <span class="s1">&#39;number&#39;</span>
          <span class="nv">idx = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">splat</span> <span class="o">or</span> <span class="nx">idx</span>
          <span class="nv">acc = </span><span class="kc">no</span>
        <span class="k">else</span>
          <span class="nv">acc = </span><span class="nx">isObject</span> <span class="o">and</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span> <span class="nx">idx</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">value</span> <span class="o">or</span> <span class="mi">0</span>
        <span class="nv">val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="nx">vvar</span><span class="p">),</span> <span class="p">[</span><span class="k">new</span> <span class="p">(</span><span class="k">if</span> <span class="nx">acc</span> <span class="k">then</span> <span class="nx">Access</span> <span class="k">else</span> <span class="nx">Index</span><span class="p">)</span> <span class="nx">idx</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">name</span><span class="o">?</span> <span class="o">and</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">RESERVED</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;assignment to a reserved word: #{obj.compile o} = #{val.compile o}&quot;</span>
      <span class="nx">assigns</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Assign</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nv">param: </span><span class="nx">@param</span><span class="p">,</span> <span class="nv">subpattern: </span><span class="kc">yes</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nx">assigns</span><span class="p">.</span><span class="nx">push</span> <span class="nx">vvar</span> <span class="nx">unless</span> <span class="nx">top</span> <span class="o">or</span> <span class="nx">@subpattern</span>
    <span class="nv">code = </span><span class="nx">assigns</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;, &#39;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="nx">LEVEL_LIST</span> <span class="k">then</span> <span class="nx">code</span> <span class="k">else</span> <span class="s2">&quot;(#{code})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <p>When compiling a conditional assignment, take care to ensure that the
operands are only evaluated once, even though we have to reference them
more than once.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileConditional: </span><span class="nf">(o) -&gt;</span>
    <span class="p">[</span><span class="nx">left</span><span class="p">,</span> <span class="nx">right</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">cacheReference</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>Disallow conditional assignment of undefined variables.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">left</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span> <span class="nx">left</span><span class="p">.</span><span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> 
           <span class="nx">left</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">value</span> <span class="o">!=</span> <span class="s2">&quot;this&quot;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span> <span class="nx">left</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">value</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;the variable \&quot;#{left.base.value}\&quot; can&#39;t be assigned with #{@context} because it has not been defined.&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;?&quot;</span> <span class="k">in</span> <span class="nx">@context</span> <span class="k">then</span> <span class="nv">o.isExistentialEquals = </span><span class="kc">true</span>
    <span class="k">new</span> <span class="nx">Op</span><span class="p">(</span><span class="nx">@context</span><span class="p">[...</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nx">left</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Assign</span><span class="p">(</span><span class="nx">right</span><span class="p">,</span> <span class="nx">@value</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">)</span> <span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <p>Compile the assignment from an array splice literal, using JavaScript's
<code>Array#splice</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileSplice: </span><span class="nf">(o) -&gt;</span>
    <span class="p">{</span><span class="nv">range: </span><span class="p">{</span><span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="nx">exclusive</span><span class="p">}}</span> <span class="o">=</span> <span class="nx">@variable</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span>
    <span class="nv">name = </span><span class="nx">@variable</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="p">[</span><span class="nx">fromDecl</span><span class="p">,</span> <span class="nx">fromRef</span><span class="p">]</span> <span class="o">=</span> <span class="nx">from</span><span class="o">?</span><span class="p">.</span><span class="nx">cache</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span><span class="p">)</span> <span class="o">or</span> <span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">to</span>
      <span class="k">if</span> <span class="nx">from</span><span class="o">?</span><span class="p">.</span><span class="nx">isSimpleNumber</span><span class="p">()</span> <span class="o">and</span> <span class="nx">to</span><span class="p">.</span><span class="nx">isSimpleNumber</span><span class="p">()</span>
        <span class="nv">to = </span><span class="o">+</span><span class="nx">to</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">-</span> <span class="o">+</span><span class="nx">fromRef</span>
        <span class="nx">to</span> <span class="o">+=</span> <span class="mi">1</span> <span class="nx">unless</span> <span class="nx">exclusive</span>
      <span class="k">else</span>
        <span class="nv">to = </span><span class="nx">to</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_ACCESS</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nx">fromRef</span>
        <span class="nx">to</span> <span class="o">+=</span> <span class="s1">&#39; + 1&#39;</span> <span class="nx">unless</span> <span class="nx">exclusive</span>
    <span class="k">else</span>
      <span class="nv">to = </span><span class="s2">&quot;9e9&quot;</span>
    <span class="p">[</span><span class="nx">valDef</span><span class="p">,</span> <span class="nx">valRef</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@value</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nv">code = </span><span class="s2">&quot;[].splice.apply(#{name}, [#{fromDecl}, #{to}].concat(#{valDef})), #{valRef}&quot;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;</span> <span class="nx">LEVEL_TOP</span> <span class="k">then</span> <span class="s2">&quot;(#{code})&quot;</span> <span class="k">else</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <h3>Code</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <p>A function definition. This is the only node that creates a new Scope.
When for the purposes of walking the contents of a function body, the Code
has no <em>children</em> -- they're within the inner scope.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Code = </span><span class="k">class</span> <span class="nx">Code</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(params, body, tag) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@params  = </span><span class="nx">params</span> <span class="o">or</span> <span class="p">[]</span>
    <span class="vi">@body    = </span><span class="nx">body</span> <span class="o">or</span> <span class="k">new</span> <span class="nx">Block</span>
    <span class="vi">@icedgen = </span><span class="nx">tag</span> <span class="o">is</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="vi">@bound   = </span><span class="nx">tag</span> <span class="o">is</span> <span class="s1">&#39;boundfunc&#39;</span> <span class="o">or</span> <span class="nx">@icedgen</span>
    <span class="vi">@context = </span><span class="s1">&#39;_this&#39;</span> <span class="k">if</span> <span class="nx">@bound</span> <span class="o">or</span> <span class="nx">@icedgen</span>
    <span class="vi">@icedPassedDeferral = </span><span class="kc">null</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="o">-&gt;</span> <span class="o">!!</span><span class="nx">@ctor</span>

  <span class="nv">traceName : </span><span class="o">-&gt;</span>
    <span class="nv">parts = </span><span class="p">[]</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@klass</span> <span class="k">if</span> <span class="nx">@klass</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@name</span> <span class="k">if</span> <span class="nx">@name</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;.&#39;</span>

  <span class="nv">jumps: </span><span class="nx">NO</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <p>Compilation creates a new scope unless explicitly asked to share with the
outer scope. Handles splat parameters in the parameter list by peeking at
the JavaScript <code>arguments</code> object. If the function is bound with the <code>=&gt;</code>
arrow, generates a wrapper that saves the current value of <code>this</code> through
a closure.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">o.scope         = </span><span class="k">new</span> <span class="nx">Scope</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">@body</span><span class="p">,</span> <span class="k">this</span>
    <span class="nv">o.scope.shared  = </span><span class="nx">del</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;sharedScope&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@icedgen</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">indent</span>        <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="k">delete</span> <span class="nx">o</span><span class="p">.</span><span class="nx">bare</span>
    <span class="k">delete</span> <span class="nx">o</span><span class="p">.</span><span class="nx">isExistentialEquals</span>
    <span class="nv">params = </span><span class="p">[]</span>
    <span class="nv">exprs  = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">@paramNames</span><span class="p">()</span> <span class="c1"># this step must be performed before the others</span>
      <span class="nx">unless</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span> <span class="nx">name</span> <span class="k">then</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parameter</span> <span class="nx">name</span>
    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">@params</span> <span class="k">when</span> <span class="nx">param</span><span class="p">.</span><span class="nx">splat</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">add</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span><span class="p">,</span> <span class="kc">yes</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@params</span> <span class="k">when</span> <span class="nx">p</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span>
      <span class="nv">splats = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="k">new</span> <span class="nx">Arr</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">asReference</span> <span class="nx">o</span> <span class="k">for</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">@params</span><span class="p">)),</span>
                          <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;arguments&#39;</span>
      <span class="k">break</span>
    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">@params</span>
      <span class="k">if</span> <span class="nx">param</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
        <span class="nv">val = ref = </span><span class="nx">param</span><span class="p">.</span><span class="nx">asReference</span> <span class="nx">o</span>
        <span class="nv">val = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span> <span class="k">if</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">exprs</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span> <span class="nx">val</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span><span class="p">,</span> <span class="nv">param: </span><span class="kc">yes</span>
      <span class="k">else</span>
        <span class="nv">ref = </span><span class="nx">param</span>
        <span class="k">if</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span>
          <span class="nv">lit = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">ref</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s1">&#39; == null&#39;</span>
          <span class="nv">val = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">param</span><span class="p">.</span><span class="nx">name</span><span class="p">),</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span>
          <span class="nx">exprs</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">If</span> <span class="nx">lit</span><span class="p">,</span> <span class="nx">val</span>
      <span class="nx">params</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ref</span> <span class="nx">unless</span> <span class="nx">splats</span>
    <span class="nv">wasEmpty = </span><span class="nx">@body</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
    <span class="nx">exprs</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">splats</span> <span class="k">if</span> <span class="nx">splats</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">exprs</span><span class="p">...</span> <span class="k">if</span> <span class="nx">exprs</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parameter</span> <span class="nx">params</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span> <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">params</span>
    <span class="nv">uniqs = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">@paramNames</span><span class="p">()</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;multiple parameters named &#39;#{name}&#39;&quot;</span> <span class="k">if</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">uniqs</span>
      <span class="nx">uniqs</span><span class="p">.</span><span class="nx">push</span> <span class="nx">name</span>

    <span class="k">if</span> <span class="nx">@icedFoundArguments</span> <span class="o">and</span> <span class="nx">@icedNodeFlag</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">assign</span> <span class="s1">&#39;_arguments&#39;</span><span class="p">,</span> <span class="s1">&#39;arguments&#39;</span>

    <span class="nv">wasEmpty = </span><span class="kc">false</span> <span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">makeReturn</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">wasEmpty</span> <span class="o">or</span> <span class="nx">@noReturn</span>
    <span class="k">if</span> <span class="nx">@bound</span>
      <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">method</span><span class="o">?</span><span class="p">.</span><span class="nx">bound</span>
        <span class="vi">@bound = @context = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">method</span><span class="p">.</span><span class="nx">context</span>
      <span class="k">else</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@static</span>
        <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">assign</span> <span class="s1">&#39;_this&#39;</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span>
    <span class="nv">idt   = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span>
    <span class="nv">code  = </span><span class="s1">&#39;function&#39;</span>
    <span class="nx">code</span>  <span class="o">+=</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">@name</span> <span class="k">if</span> <span class="nx">@ctor</span>
    <span class="nx">code</span>  <span class="o">+=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="nx">params</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;) {&#39;</span>

    <span class="k">if</span> <span class="nx">@icedNodeFlag</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@icedgen</span></pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <p>Find the tamecb if possible, and do this before we update the
scope, below...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@icedPassedDeferral = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">passed_deferral</span>
      <span class="nv">lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">@icedPassedDeferral</span>
      <span class="nv">f = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">ns</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">findDeferral</span>
      <span class="nv">rhs = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">f</span><span class="p">,</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;arguments&#39;</span> <span class="p">]</span>
      <span class="nx">@body</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">@icedNodeFlag</span>
      <span class="nv">o.iced_scope = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span></pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <p>There are two important cases to consider in terms of autocb;
In the case of an explicit call to return, we handle it in
'new Return' constructor.  The subtler case is when control
falls off the end of a function.  But that's just the top-level
continuation within the function.  So we assign it to the autocb
here.  There's a slight scoping hack, to supply  { icedlocal : yes },
which forces <strong>iced<em>k to be locally scoped.  To have it global is
a real disaster of subtle bugs. But wait, there's yet more!!
Recall that icedgen functions share scope with their parent function.
That means, they'll insert an '</strong>iced</em>k' in the parent scope
as a type == 'param' !! Meaning, it won't be output at the high-level
function that contains them (since only 'var's) are output.
Thus, we had to make a hack to scope.coffee to support this particular
case.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@icedNodeFlag</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@icedgen</span>
      <span class="nv">r = </span><span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span> <span class="k">then</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">autocb</span> <span class="k">else</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k_noop</span>
      <span class="nv">rhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">r</span>
      <span class="nv">lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span>
      <span class="nx">@body</span><span class="p">.</span><span class="nx">unshift</span><span class="p">(</span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span> <span class="p">)</span>

    <span class="nx">code</span>  <span class="o">+=</span> <span class="s2">&quot;\n#{ @body.compileWithDeclarations o }\n#{@tab}&quot;</span> <span class="nx">unless</span> <span class="nx">@body</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
    <span class="nx">code</span>  <span class="o">+=</span> <span class="s1">&#39;}&#39;</span>
    <span class="k">return</span> <span class="nx">@tab</span> <span class="o">+</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">@ctor</span>
    <span class="k">if</span> <span class="nx">@front</span> <span class="o">or</span> <span class="p">(</span><span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_ACCESS</span><span class="p">)</span> <span class="k">then</span> <span class="s2">&quot;(#{code})&quot;</span> <span class="k">else</span> <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <p>A list of parameter names, excluding those generated by the compiler.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">paramNames: </span><span class="o">-&gt;</span>
    <span class="nv">names = </span><span class="p">[]</span>
    <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">param</span><span class="p">.</span><span class="nx">names</span><span class="p">()...</span> <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">@params</span>
    <span class="nx">names</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>Short-circuit <code>traverseChildren</code> method to prevent it from crossing scope boundaries
unless <code>crossScope</code> is <code>true</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">traverseChildren: </span><span class="nf">(crossScope, func) -&gt;</span>
    <span class="k">super</span><span class="p">(</span><span class="nx">crossScope</span><span class="p">,</span> <span class="nx">func</span><span class="p">)</span> <span class="k">if</span> <span class="nx">crossScope</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>we are taming as a feature of all of our children.  However, if we
are iced, it's not the case that our parent is iced!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedWalkAst : </span><span class="nf">(parent, o) -&gt;</span>
    <span class="vi">@icedParentAwait = </span><span class="nx">parent</span>
    <span class="nv">fa_prev = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="nv">cf_prev = </span><span class="nx">o</span><span class="p">.</span><span class="nx">currFunc</span>
    <span class="nv">fg_prev = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundArguments</span>
    <span class="nv">faf_prev = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAwaitFunc</span>
    <span class="nv">o.foundAutocb = </span><span class="kc">false</span>
    <span class="nv">o.foundArguments = </span><span class="kc">false</span>
    <span class="nv">o.foundAwaitFunc = </span><span class="kc">false</span>
    <span class="nv">o.currFunc = </span><span class="err">@</span>
    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">@params</span>
      <span class="k">if</span> <span class="nx">param</span><span class="p">.</span><span class="nx">name</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">param</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">autocb</span>
        <span class="nv">o.foundAutocb = </span><span class="kc">true</span>
        <span class="k">break</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="k">super</span> <span class="nx">parent</span><span class="p">,</span> <span class="nx">o</span>
    <span class="vi">@icedFoundArguments = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundArguments</span>
    <span class="nv">o.foundAwaitFunc = </span><span class="nx">faf_prev</span>
    <span class="nv">o.foundArguments = </span><span class="nx">fg_prev</span>
    <span class="nv">o.foundAutocb = </span><span class="nx">fa_prev</span>
    <span class="nv">o.currFunc = </span><span class="nx">cf_prev</span>
    <span class="kc">false</span>

  <span class="nv">icedWalkAstLoops : </span><span class="nf">(flood) -&gt;</span>
    <span class="vi">@icedLoopFlag = </span><span class="kc">true</span> <span class="k">if</span> <span class="k">super</span> <span class="kc">false</span>
    <span class="kc">false</span>

  <span class="nv">icedWalkCpsPivots: </span><span class="o">-&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@icedCpsPivotFlag = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <h3>Param</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>A parameter in a function definition. Beyond a typical Javascript parameter,
these parameters can also attach themselves to the context of the function,
as well as be a splat, gathering up a group of parameters into an array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Param = </span><span class="k">class</span> <span class="nx">Param</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@name, @value, @splat) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">name = </span><span class="nx">@name</span><span class="o">?</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">().</span><span class="nx">value</span><span class="p">)</span> <span class="k">in</span> <span class="nx">STRICT_PROSCRIBED</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;parameter name \&quot;#{name}\&quot; is not allowed&quot;</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>

  <span class="nv">compile: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>

  <span class="nv">asReference: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="nx">@reference</span> <span class="k">if</span> <span class="nx">@reference</span>
    <span class="nv">node = </span><span class="nx">@name</span>
    <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="k">this</span>
      <span class="nv">node = </span><span class="nx">node</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span>
      <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">reserved</span>
        <span class="nv">node = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span>
      <span class="nv">node = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;arg&#39;</span>
    <span class="nv">node = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">node</span>
    <span class="nv">node = </span><span class="k">new</span> <span class="nx">Splat</span> <span class="nx">node</span> <span class="k">if</span> <span class="nx">@splat</span>
    <span class="vi">@reference = </span><span class="nx">node</span>

  <span class="nv">isComplex: </span><span class="o">-&gt;</span>
    <span class="nx">@name</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <p>Finds the name or names of a <code>Param</code>; useful for detecting duplicates.
In a sense, a destructured parameter represents multiple JS parameters,
thus this method returns an <code>Array</code> of names.
Reserved words used as param names, as well as the Object and Array
literals used for destructured params, get a compiler generated name
during the <code>Code</code> compilation step, so this is necessarily an incomplete
list of a parameter's names.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">names: </span><span class="nf">(name = @name)-&gt;</span>
    <span class="nv">atParam = </span><span class="nf">(obj) -&gt;</span>
      <span class="p">{</span><span class="nx">value</span><span class="p">}</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">reserved</span> <span class="k">then</span> <span class="p">[]</span> <span class="k">else</span> <span class="p">[</span><span class="nx">value</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <ul>
<li>simple literals <code>foo</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="p">[</span><span class="nx">name</span><span class="p">.</span><span class="nx">value</span><span class="p">]</span> <span class="k">if</span> <span class="nx">name</span> <span class="k">instanceof</span> <span class="nx">Literal</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <ul>
<li>at-params <code>@foo</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">return</span> <span class="nx">atParam</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="k">if</span> <span class="nx">name</span> <span class="k">instanceof</span> <span class="nx">Value</span>
    <span class="nv">names = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">name</span><span class="p">.</span><span class="nx">objects</span></pre></div>             </td>           </tr>                               <tr id="section-149">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-149">&#182;</a>               </div>               <ul>
<li>assignments within destructured parameters <code>{foo:bar}</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Assign</span>
        <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-150">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-150">&#182;</a>               </div>               <ul>
<li>destructured parameters within destructured parameters <code>[{a}]</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">isArray</span><span class="p">()</span> <span class="o">or</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">isObject</span><span class="p">()</span>
        <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@names</span><span class="p">(</span><span class="nx">obj</span><span class="p">.</span><span class="nx">base</span><span class="p">)...</span></pre></div>             </td>           </tr>                               <tr id="section-151">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-151">&#182;</a>               </div>               <ul>
<li>at-params within destructured parameters <code>{@foo}</code></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="k">this</span>
        <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">atParam</span><span class="p">(</span><span class="nx">obj</span><span class="p">)...</span></pre></div>             </td>           </tr>                               <tr id="section-152">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-152">&#182;</a>               </div>               <ul>
<li>simple destructured parameters {foo}</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">else</span> <span class="nx">names</span><span class="p">.</span><span class="nx">push</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">value</span>
    <span class="nx">names</span></pre></div>             </td>           </tr>                               <tr id="section-153">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-153">&#182;</a>               </div>               <h3>Splat</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-154">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-154">&#182;</a>               </div>               <p>A splat, either as a parameter to a function, an argument to a call,
or as part of a destructuring assignment.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Splat = </span><span class="k">class</span> <span class="nx">Splat</span> <span class="k">extends</span> <span class="nx">Base</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>

  <span class="nv">isAssignable: </span><span class="nx">YES</span>

  <span class="nv">constructor: </span><span class="nf">(name) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@name = </span><span class="k">if</span> <span class="nx">name</span><span class="p">.</span><span class="nx">compile</span> <span class="k">then</span> <span class="nx">name</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">name</span>

  <span class="nv">assigns: </span><span class="nf">(name) -&gt;</span>
    <span class="nx">@name</span><span class="p">.</span><span class="nx">assigns</span> <span class="nx">name</span>

  <span class="nv">compile: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@index</span><span class="o">?</span> <span class="k">then</span> <span class="nx">@compileParam</span> <span class="nx">o</span> <span class="k">else</span> <span class="nx">@name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>

  <span class="nv">unwrap: </span><span class="o">-&gt;</span> <span class="nx">@name</span>

  <span class="nv">toSlot: </span><span class="nf">(i) -&gt;</span>
    <span class="k">new</span> <span class="nx">Slot</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="nx">@name</span><span class="p">),</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-155">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-155">&#182;</a>               </div>               <p>Utility function that converts an arbitrary number of elements, mixed with
splats, to a proper array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@compileSplattedArray: </span><span class="nf">(o, list, apply) -&gt;</span>
    <span class="nv">index = </span><span class="o">-</span><span class="mi">1</span>
    <span class="k">continue</span> <span class="k">while</span> <span class="p">(</span><span class="nv">node = </span><span class="nx">list</span><span class="p">[</span><span class="o">++</span><span class="nx">index</span><span class="p">])</span> <span class="o">and</span> <span class="nx">node</span> <span class="o">not</span> <span class="k">instanceof</span> <span class="nx">Splat</span>
    <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nx">index</span> <span class="o">&gt;=</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">if</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span>
      <span class="nv">code = </span><span class="nx">list</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
      <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">apply</span>
      <span class="k">return</span> <span class="s2">&quot;#{ utility &#39;slice&#39; }.call(#{code})&quot;</span>
    <span class="nv">args = </span><span class="nx">list</span><span class="p">[</span><span class="nx">index</span><span class="p">..]</span>
    <span class="k">for</span> <span class="nx">node</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">args</span>
      <span class="nv">code = </span><span class="nx">node</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
      <span class="nx">args</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Splat</span>
      <span class="k">then</span> <span class="s2">&quot;#{ utility &#39;slice&#39; }.call(#{code})&quot;</span>
      <span class="k">else</span> <span class="s2">&quot;[#{code}]&quot;</span>
    <span class="k">return</span> <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.concat(#{ args[1..].join &#39;, &#39; })&quot;</span> <span class="k">if</span> <span class="nx">index</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nv">base = </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span> <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">list</span><span class="p">[...</span><span class="nx">index</span><span class="p">])</span>
    <span class="s2">&quot;[#{ base.join &#39;, &#39; }].concat(#{ args.join &#39;, &#39; })&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-156">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-156">&#182;</a>               </div>               <h3>While</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-157">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-157">&#182;</a>               </div>               <p>A while loop, the only sort of low-level loop exposed by CoffeeScript. From
it, all other loops can be manufactured. Useful in cases where you need more
flexibility or more speed than a comprehension can provide.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.While = </span><span class="k">class</span> <span class="nx">While</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(condition, options) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@condition = </span><span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">invert</span> <span class="k">then</span> <span class="nx">condition</span><span class="p">.</span><span class="nx">invert</span><span class="p">()</span> <span class="k">else</span> <span class="nx">condition</span>
    <span class="vi">@guard     = </span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">guard</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;guard&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="nx">YES</span>
  <span class="nv">isLoop : </span><span class="nx">YES</span>

  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="k">if</span> <span class="nx">res</span>
      <span class="k">super</span>
    <span class="k">else</span>
      <span class="vi">@returns = </span><span class="o">not</span> <span class="nx">@jumps</span> <span class="nv">loop: </span><span class="kc">yes</span>
      <span class="k">this</span>

  <span class="nv">addBody: </span><span class="nf">(@body) -&gt;</span>
    <span class="k">this</span>

  <span class="nv">jumps: </span><span class="o">-&gt;</span>
    <span class="p">{</span><span class="nx">expressions</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@body</span>
    <span class="k">return</span> <span class="kc">no</span> <span class="nx">unless</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">length</span>
    <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">expressions</span>
      <span class="k">return</span> <span class="nx">node</span> <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">jumps</span> <span class="nv">loop: </span><span class="kc">yes</span>
    <span class="kc">no</span>

  <span class="nv">icedWrap : </span><span class="nf">(d) -&gt;</span>
    <span class="nv">condition = </span><span class="nx">d</span><span class="p">.</span><span class="nx">condition</span>
    <span class="nv">body = </span><span class="nx">d</span><span class="p">.</span><span class="nx">body</span>
    <span class="nv">rvar = </span><span class="nx">d</span><span class="p">.</span><span class="nx">rvar</span>
    <span class="nv">outStatements = </span><span class="p">[]</span>

    <span class="k">if</span> <span class="nx">rvar</span>
      <span class="nv">rvar_value = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">rvar</span></pre></div>             </td>           </tr>                               <tr id="section-158">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-158">&#182;</a>               </div>               <p>Set up all of the IDs</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">top_id = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">t_while</span>
    <span class="nv">k_id = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span>
    <span class="nv">k_param = </span><span class="k">new</span> <span class="nx">Param</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span></pre></div>             </td>           </tr>                               <tr id="section-159">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-159">&#182;</a>               </div>               <p>Break will just call the parent continuation, but in some
cases, there will be a return value, so then we have to pass
that back out.  Hence the split below:</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">break_id = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">b_while</span>
    <span class="k">if</span> <span class="nx">rvar</span>
      <span class="nv">break_expr = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">k_id</span><span class="p">,</span> <span class="p">[</span> <span class="nx">rvar_value</span> <span class="p">]</span>
      <span class="nv">break_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">break_expr</span> <span class="p">]</span>
      <span class="nv">break_body = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="nx">break_block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
      <span class="nv">break_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">break_id</span><span class="p">,</span> <span class="nx">break_body</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="nv">break_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">break_id</span><span class="p">,</span> <span class="nx">k_id</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-160">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-160">&#182;</a>               </div>               <p>The continue assignment is the increment at the end
of the loop (if it's there), and also the recursive
call back to the top.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">continue_id = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">c_while</span>
    <span class="nv">continue_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Call</span> <span class="nx">top_id</span><span class="p">,</span> <span class="p">[</span> <span class="nx">k_id</span> <span class="p">]</span> <span class="p">]</span>
    <span class="nx">continue_block</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">d</span><span class="p">.</span><span class="nx">step</span> <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">step</span>
    <span class="nv">continue_body = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="nx">continue_block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="nv">continue_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">continue_id</span><span class="p">,</span> <span class="nx">continue_body</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-161">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-161">&#182;</a>               </div>               <p>Next is like continue, but it also squirrels away the return
value, if required!</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">next_id = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">n_while</span>
    <span class="k">if</span> <span class="nx">rvar</span>
      <span class="nv">next_arg = </span><span class="k">new</span> <span class="nx">Param</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">n_arg</span>
      <span class="nv">f = </span><span class="nx">rvar_value</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">f</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;push&#39;</span>
      <span class="nv">call1 = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">f</span><span class="p">,</span> <span class="p">[</span> <span class="nx">next_arg</span> <span class="p">]</span>
      <span class="nv">call2 = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">continue_id</span><span class="p">,</span> <span class="p">[]</span>
      <span class="nv">next_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">call1</span><span class="p">,</span> <span class="nx">call2</span> <span class="p">]</span>
      <span class="nv">next_body = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[</span> <span class="nx">next_arg</span> <span class="p">],</span> <span class="nx">next_block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
      <span class="nv">next_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">next_id</span><span class="p">,</span> <span class="nx">next_body</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span>
    <span class="k">else</span>
      <span class="nv">next_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">next_id</span><span class="p">,</span> <span class="nx">continue_id</span></pre></div>             </td>           </tr>                               <tr id="section-162">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-162">&#182;</a>               </div>               <p>The whole body is wrapped in an if, with the positive
condition being the loop, and the negative condition
being the break out of the loop</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">cond = </span><span class="k">new</span> <span class="nx">If</span> <span class="nx">condition</span><span class="p">.</span><span class="nx">invert</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Call</span> <span class="nx">break_id</span><span class="p">,</span> <span class="p">[]</span> <span class="p">]</span>
    <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">guard</span>
      <span class="nx">cond</span><span class="p">.</span><span class="nx">addElse</span> <span class="k">new</span> <span class="nx">If</span> <span class="nx">d</span><span class="p">.</span><span class="nx">guard</span><span class="p">,</span> <span class="nx">body</span>
      <span class="nx">cond</span><span class="p">.</span><span class="nx">addElse</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Call</span> <span class="nx">continue_id</span><span class="p">,</span> <span class="p">[]</span> <span class="p">]</span>
    <span class="k">else</span>
      <span class="nx">cond</span><span class="p">.</span><span class="nx">addElse</span> <span class="nx">body</span></pre></div>             </td>           </tr>                               <tr id="section-163">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-163">&#182;</a>               </div>               <p>The top of the loop construct.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">top_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">break_assign</span><span class="p">,</span> <span class="nx">continue_assign</span><span class="p">,</span> <span class="nx">next_assign</span><span class="p">,</span> <span class="nx">cond</span> <span class="p">]</span>
    <span class="nv">top_func = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[</span> <span class="nx">k_param</span> <span class="p">],</span> <span class="nx">top_body</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="nv">top_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">top_id</span><span class="p">,</span> <span class="nx">top_func</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span> <span class="nv">icedlocal : </span><span class="kc">yes</span> <span class="p">}</span>
    <span class="nv">top_call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">top_id</span><span class="p">,</span> <span class="p">[</span> <span class="nx">k_id</span> <span class="p">]</span>
    <span class="nv">top_statements = </span><span class="p">[]</span>
    <span class="nv">top_statements = </span><span class="nx">top_statements</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">d</span><span class="p">.</span><span class="nx">init</span> <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nx">init</span>
    <span class="k">if</span> <span class="nx">rvar</span>
      <span class="nv">rvar_init = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">rvar_value</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Arr</span>
      <span class="nx">top_statements</span><span class="p">.</span><span class="nx">push</span> <span class="nx">rvar_init</span>
    <span class="nv">top_statements = </span><span class="nx">top_statements</span><span class="p">.</span><span class="nx">concat</span> <span class="p">[</span> <span class="nx">top_assign</span><span class="p">,</span> <span class="nx">top_call</span> <span class="p">]</span>
    <span class="nv">top_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="nx">top_statements</span>

  <span class="nv">icedCallContinuation : </span><span class="o">-&gt;</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">icedThreadReturn</span> <span class="k">new</span> <span class="nx">IcedTailCall</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">n_while</span>

  <span class="nv">compileIced: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">@icedNodeFlag</span>
    <span class="nv">opts = </span><span class="p">{</span> <span class="nx">@condition</span><span class="p">,</span> <span class="nx">@body</span><span class="p">,</span> <span class="nx">@guard</span> <span class="p">}</span>
    <span class="k">if</span> <span class="nx">@returns</span>
      <span class="nv">opts.rvar = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;results&#39;</span>
    <span class="nv">b = </span><span class="nx">@icedWrap</span> <span class="nx">opts</span>
    <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-164">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-164">&#182;</a>               </div>               <p>The main difference from a JavaScript <em>while</em> is that the CoffeeScript
<em>while</em> can be used as a part of a larger expression -- while loops may
return an array containing the computed result of each iteration.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nv">code = </span><span class="nx">@compileIced</span> <span class="nx">o</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="nv">set      = </span><span class="s1">&#39;&#39;</span>
    <span class="p">{</span><span class="nx">body</span><span class="p">}</span>   <span class="o">=</span> <span class="k">this</span>
    <span class="k">if</span> <span class="nx">body</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">()</span>
      <span class="nv">body = </span><span class="s1">&#39;&#39;</span>
    <span class="k">else</span>
      <span class="k">if</span> <span class="nx">@returns</span>
        <span class="nx">body</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nv">rvar = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;results&#39;</span>
        <span class="nv">set  = </span><span class="s2">&quot;#{@tab}#{rvar} = [];\n&quot;</span>
      <span class="k">if</span> <span class="nx">@guard</span>
        <span class="k">if</span> <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
          <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">If</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Parens</span> <span class="nx">@guard</span><span class="p">).</span><span class="nx">invert</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;continue&quot;</span>
        <span class="k">else</span>
          <span class="nv">body = </span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="k">new</span> <span class="nx">If</span> <span class="nx">@guard</span><span class="p">,</span> <span class="nx">body</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@guard</span>
      <span class="nv">body = </span><span class="s2">&quot;\n#{ body.compile o, LEVEL_TOP }\n#{@tab}&quot;</span>
    <span class="nv">code = </span><span class="nx">set</span> <span class="o">+</span> <span class="nx">@tab</span> <span class="o">+</span> <span class="s2">&quot;while (#{ @condition.compile o, LEVEL_PAREN }) {#{body}}&quot;</span>
    <span class="k">if</span> <span class="nx">@returns</span>
      <span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;\n#{@tab}#{iced.const.autocb}(#{rvar});&quot;</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;\n#{@tab}return;&quot;</span>
      <span class="k">else</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="s2">&quot;\n#{@tab}return #{rvar};&quot;</span>
    <span class="nx">code</span></pre></div>             </td>           </tr>                               <tr id="section-165">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-165">&#182;</a>               </div>               <h3>Op</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-166">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-166">&#182;</a>               </div>               <p>Simple Arithmetic and logical operations. Performs some conversion from
CoffeeScript operations into their JavaScript equivalents.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Op = </span><span class="k">class</span> <span class="nx">Op</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(op, first, second, flip ) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nx">In</span> <span class="nx">first</span><span class="p">,</span> <span class="nx">second</span> <span class="k">if</span> <span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;in&#39;</span>
    <span class="k">if</span> <span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;do&#39;</span>
      <span class="k">return</span> <span class="nx">@generateDo</span> <span class="nx">first</span>
    <span class="k">if</span> <span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;new&#39;</span>
      <span class="k">return</span> <span class="nx">first</span><span class="p">.</span><span class="nx">newInstance</span><span class="p">()</span> <span class="k">if</span> <span class="nx">first</span> <span class="k">instanceof</span> <span class="nx">Call</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">first</span><span class="p">.</span><span class="nx">do</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">first</span><span class="p">.</span><span class="nx">isNew</span>
      <span class="nv">first = </span><span class="k">new</span> <span class="nx">Parens</span> <span class="nx">first</span>   <span class="k">if</span> <span class="nx">first</span> <span class="k">instanceof</span> <span class="nx">Code</span> <span class="o">and</span> <span class="nx">first</span><span class="p">.</span><span class="nx">bound</span> <span class="o">or</span> <span class="nx">first</span><span class="p">.</span><span class="nx">do</span>
    <span class="vi">@operator = </span><span class="nx">CONVERSIONS</span><span class="p">[</span><span class="nx">op</span><span class="p">]</span> <span class="o">or</span> <span class="nx">op</span>
    <span class="vi">@first    = </span><span class="nx">first</span>
    <span class="vi">@second   = </span><span class="nx">second</span>
    <span class="vi">@flip     = </span><span class="o">!!</span><span class="nx">flip</span>
    <span class="k">return</span> <span class="k">this</span>

  <span class="nv">icedWrapContinuation : </span><span class="o">-&gt;</span> <span class="nx">@icedCallContinuationFlag</span></pre></div>             </td>           </tr>                               <tr id="section-167">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-167">&#182;</a>               </div>               <p>The map of conversions from CoffeeScript to JavaScript symbols.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">CONVERSIONS =</span>
    <span class="s1">&#39;==&#39;</span><span class="o">:</span> <span class="s1">&#39;===&#39;</span>
    <span class="s1">&#39;!=&#39;</span><span class="o">:</span> <span class="s1">&#39;!==&#39;</span>
    <span class="s1">&#39;of&#39;</span><span class="o">:</span> <span class="s1">&#39;in&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-168">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-168">&#182;</a>               </div>               <p>The map of invertible operators.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">INVERSIONS =</span>
    <span class="s1">&#39;!==&#39;</span><span class="o">:</span> <span class="s1">&#39;===&#39;</span>
    <span class="s1">&#39;===&#39;</span><span class="o">:</span> <span class="s1">&#39;!==&#39;</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;first&#39;</span><span class="p">,</span> <span class="s1">&#39;second&#39;</span><span class="p">]</span>

  <span class="nv">isSimpleNumber: </span><span class="nx">NO</span>

  <span class="nv">isUnary: </span><span class="o">-&gt;</span>
    <span class="o">not</span> <span class="nx">@second</span>

  <span class="nv">isComplex: </span><span class="o">-&gt;</span>
    <span class="o">not</span> <span class="p">(</span><span class="nx">@isUnary</span><span class="p">()</span> <span class="o">and</span> <span class="p">(</span><span class="nx">@operator</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]))</span> <span class="o">or</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-169">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-169">&#182;</a>               </div>               <p>Am I capable of
<a href="http://docs.python.org/reference/expressions.html#notin">Python-style comparison chaining</a>?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isChainable: </span><span class="o">-&gt;</span>
    <span class="nx">@operator</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;===&#39;</span><span class="p">,</span> <span class="s1">&#39;!==&#39;</span><span class="p">]</span>

  <span class="nv">icedCpsRotate : </span> <span class="o">-&gt;</span>
    <span class="vi">@first = </span><span class="nx">fnv</span> <span class="k">if</span> <span class="nx">@first</span> <span class="o">and</span> <span class="p">(</span><span class="nv">fnv = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@first</span><span class="p">)</span>
    <span class="vi">@second = </span><span class="nx">snv</span> <span class="k">if</span> <span class="nx">@second</span> <span class="o">and</span> <span class="p">(</span><span class="nv">snv = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@second</span><span class="p">)</span>

  <span class="nv">invert: </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@isChainable</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">isChainable</span><span class="p">()</span>
      <span class="nv">allInvertable = </span><span class="kc">yes</span>
      <span class="nv">curr = </span><span class="k">this</span>
      <span class="k">while</span> <span class="nx">curr</span> <span class="o">and</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">operator</span>
        <span class="nx">allInvertable</span> <span class="o">and=</span> <span class="p">(</span><span class="nx">curr</span><span class="p">.</span><span class="nx">operator</span> <span class="k">of</span> <span class="nx">INVERSIONS</span><span class="p">)</span>
        <span class="nv">curr = </span><span class="nx">curr</span><span class="p">.</span><span class="nx">first</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">Parens</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">invert</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">allInvertable</span>
      <span class="nv">curr = </span><span class="k">this</span>
      <span class="k">while</span> <span class="nx">curr</span> <span class="o">and</span> <span class="nx">curr</span><span class="p">.</span><span class="nx">operator</span>
        <span class="nv">curr.invert = </span><span class="o">!</span><span class="nx">curr</span><span class="p">.</span><span class="nx">invert</span>
        <span class="nv">curr.operator = </span><span class="nx">INVERSIONS</span><span class="p">[</span><span class="nx">curr</span><span class="p">.</span><span class="nx">operator</span><span class="p">]</span>
        <span class="nv">curr = </span><span class="nx">curr</span><span class="p">.</span><span class="nx">first</span>
      <span class="k">this</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nv">op = </span><span class="nx">INVERSIONS</span><span class="p">[</span><span class="nx">@operator</span><span class="p">]</span>
      <span class="vi">@operator = </span><span class="nx">op</span>
      <span class="k">if</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">Op</span>
        <span class="nx">@first</span><span class="p">.</span><span class="nx">invert</span><span class="p">()</span>
      <span class="k">this</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@second</span>
      <span class="k">new</span> <span class="nx">Parens</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">invert</span><span class="p">()</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@operator</span> <span class="o">is</span> <span class="s1">&#39;!&#39;</span> <span class="o">and</span> <span class="p">(</span><span class="nv">fst = </span><span class="nx">@first</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">())</span> <span class="k">instanceof</span> <span class="nx">Op</span> <span class="o">and</span>
                                  <span class="nx">fst</span><span class="p">.</span><span class="nx">operator</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="s1">&#39;in&#39;</span><span class="p">,</span> <span class="s1">&#39;instanceof&#39;</span><span class="p">]</span>
      <span class="nx">fst</span>
    <span class="k">else</span>
      <span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="k">this</span>

  <span class="nv">unfoldSoak: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@operator</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">]</span> <span class="o">and</span> <span class="nx">unfoldSoak</span> <span class="nx">o</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;first&#39;</span>

  <span class="nv">generateDo: </span><span class="nf">(exp) -&gt;</span>
    <span class="nv">passedParams = </span><span class="p">[]</span>
    <span class="nv">func = </span><span class="k">if</span> <span class="nx">exp</span> <span class="k">instanceof</span> <span class="nx">Assign</span> <span class="o">and</span> <span class="p">(</span><span class="nv">ref = </span><span class="nx">exp</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">())</span> <span class="k">instanceof</span> <span class="nx">Code</span>
      <span class="nx">ref</span>
    <span class="k">else</span>
      <span class="nx">exp</span>
    <span class="k">for</span> <span class="nx">param</span> <span class="k">in</span> <span class="nx">func</span><span class="p">.</span><span class="nx">params</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">passedParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span>
        <span class="k">delete</span> <span class="nx">param</span><span class="p">.</span><span class="nx">value</span>
      <span class="k">else</span>
        <span class="nx">passedParams</span><span class="p">.</span><span class="nx">push</span> <span class="nx">param</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">exp</span><span class="p">,</span> <span class="nx">passedParams</span>
    <span class="nv">call.do = </span><span class="kc">yes</span>
    <span class="nx">call</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">isChain = </span><span class="nx">@isChainable</span><span class="p">()</span> <span class="o">and</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">isChainable</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-170">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-170">&#182;</a>               </div>               <p>In chains, there's no need to wrap bare obj literals in parens,
as the chained expression is wrapped.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@first.front = </span><span class="nx">@front</span> <span class="nx">unless</span> <span class="nx">isChain</span>
    <span class="k">if</span> <span class="nx">@operator</span> <span class="o">is</span> <span class="s1">&#39;delete&#39;</span> <span class="o">and</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span><span class="p">(</span><span class="nx">@first</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">().</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;delete operand may not be argument or var&#39;</span>
    <span class="k">if</span> <span class="nx">@operator</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="s1">&#39;++&#39;</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">().</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">STRICT_PROSCRIBED</span>
      <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;prefix increment/decrement may not have eval or arguments operand&#39;</span>
    <span class="k">return</span> <span class="nx">@compileUnary</span>     <span class="nx">o</span> <span class="k">if</span> <span class="nx">@isUnary</span><span class="p">()</span>
    <span class="k">return</span> <span class="nx">@compileChain</span>     <span class="nx">o</span> <span class="k">if</span> <span class="nx">isChain</span>
    <span class="k">return</span> <span class="nx">@compileExistence</span> <span class="nx">o</span> <span class="k">if</span> <span class="nx">@operator</span> <span class="o">is</span> <span class="s1">&#39;?&#39;</span>
    <span class="nv">code = </span><span class="nx">@first</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">@operator</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
           <span class="nx">@second</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;=</span> <span class="nx">LEVEL_OP</span> <span class="k">then</span> <span class="nx">code</span> <span class="k">else</span> <span class="s2">&quot;(#{code})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-171">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-171">&#182;</a>               </div>               <p>Mimic Python's chained comparisons when multiple comparison operators are
used sequentially. For example:</p>

<pre><code>bin/coffee -e 'console.log 50 &lt; 65 &gt; 10'
true
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileChain: </span><span class="nf">(o) -&gt;</span>
    <span class="p">[</span><span class="nx">@first</span><span class="p">.</span><span class="nx">second</span><span class="p">,</span> <span class="nx">shared</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">second</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span>
    <span class="nv">fst = </span><span class="nx">@first</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span>
    <span class="nv">code = </span><span class="s2">&quot;#{fst} #{if @invert then &#39;&amp;&amp;&#39; else &#39;||&#39;} #{ shared.compile o } #{@operator} #{ @second.compile o, LEVEL_OP }&quot;</span>
    <span class="s2">&quot;(#{code})&quot;</span>

  <span class="nv">compileExistence: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span> <span class="o">and</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;</span> <span class="nx">LEVEL_TOP</span>
      <span class="nv">ref = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
      <span class="nv">fst = </span><span class="k">new</span> <span class="nx">Parens</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">@first</span>
    <span class="k">else</span>
      <span class="nv">fst = </span><span class="nx">@first</span>
      <span class="nv">ref = </span><span class="nx">fst</span>
    <span class="k">new</span> <span class="nx">If</span><span class="p">(</span><span class="k">new</span> <span class="nx">Existence</span><span class="p">(</span><span class="nx">fst</span><span class="p">),</span> <span class="nx">ref</span><span class="p">,</span> <span class="nv">type: </span><span class="s1">&#39;if&#39;</span><span class="p">).</span><span class="nx">addElse</span><span class="p">(</span><span class="nx">@second</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-172">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-172">&#182;</a>               </div>               <p>Compile a unary <strong>Op</strong>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileUnary: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_ACCESS</span>
      <span class="k">return</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Parens</span> <span class="k">this</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="nv">parts = </span><span class="p">[</span><span class="nv">op = </span><span class="nx">@operator</span><span class="p">]</span>
    <span class="nv">plusMinus = </span><span class="nx">op</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">]</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span> <span class="s1">&#39; &#39;</span> <span class="k">if</span> <span class="nx">op</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;new&#39;</span><span class="p">,</span> <span class="s1">&#39;typeof&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">]</span> <span class="o">or</span>
                      <span class="nx">plusMinus</span> <span class="o">and</span> <span class="nx">@first</span> <span class="k">instanceof</span> <span class="nx">Op</span> <span class="o">and</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">operator</span> <span class="o">is</span> <span class="nx">op</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">plusMinus</span> <span class="o">&amp;&amp;</span> <span class="nx">@first</span> <span class="k">instanceof</span> <span class="nx">Op</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">op</span> <span class="o">is</span> <span class="s1">&#39;new&#39;</span> <span class="o">and</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">isStatement</span> <span class="nx">o</span><span class="p">)</span>
      <span class="vi">@first = </span><span class="k">new</span> <span class="nx">Parens</span> <span class="nx">@first</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">push</span> <span class="nx">@first</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@flip</span>
    <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span>

  <span class="nv">toString: </span><span class="nf">(idt) -&gt;</span>
    <span class="k">super</span> <span class="nx">idt</span><span class="p">,</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">@operator</span></pre></div>             </td>           </tr>                               <tr id="section-173">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-173">&#182;</a>               </div>               <h3>In</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.In = </span><span class="k">class</span> <span class="nx">In</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@object, @array) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">]</span>

  <span class="nv">invert: </span><span class="nx">NEGATE</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@array</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">@array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">()</span>
      <span class="k">for</span> <span class="nx">obj</span> <span class="k">in</span> <span class="nx">@array</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">objects</span> <span class="k">when</span> <span class="nx">obj</span> <span class="k">instanceof</span> <span class="nx">Splat</span>
        <span class="nv">hasSplat = </span><span class="kc">yes</span>
        <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-174">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-174">&#182;</a>               </div>               <p><code>compileOrTest</code> only if we have an array literal with no splats</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">@compileOrTest</span> <span class="nx">o</span> <span class="nx">unless</span> <span class="nx">hasSplat</span>
    <span class="nx">@compileLoopTest</span> <span class="nx">o</span>

  <span class="nv">compileOrTest: </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="s2">&quot;#{!!@negated}&quot;</span> <span class="k">if</span> <span class="nx">@array</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">objects</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="p">[</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@object</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span>
    <span class="p">[</span><span class="nx">cmp</span><span class="p">,</span> <span class="nx">cnj</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">@negated</span> <span class="k">then</span> <span class="p">[</span><span class="s1">&#39; !== &#39;</span><span class="p">,</span> <span class="s1">&#39; &amp;&amp; &#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39; === &#39;</span><span class="p">,</span> <span class="s1">&#39; || &#39;</span><span class="p">]</span>
    <span class="nv">tests = </span><span class="k">for</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@array</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">objects</span>
      <span class="p">(</span><span class="k">if</span> <span class="nx">i</span> <span class="k">then</span> <span class="nx">ref</span> <span class="k">else</span> <span class="nx">sub</span><span class="p">)</span> <span class="o">+</span> <span class="nx">cmp</span> <span class="o">+</span> <span class="nx">item</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_ACCESS</span>
    <span class="nv">tests = </span><span class="nx">tests</span><span class="p">.</span><span class="nx">join</span> <span class="nx">cnj</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="nx">LEVEL_OP</span> <span class="k">then</span> <span class="nx">tests</span> <span class="k">else</span> <span class="s2">&quot;(#{tests})&quot;</span>

  <span class="nv">compileLoopTest: </span><span class="nf">(o) -&gt;</span>
    <span class="p">[</span><span class="nx">sub</span><span class="p">,</span> <span class="nx">ref</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@object</span><span class="p">.</span><span class="nx">cache</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nv">code = </span><span class="nx">utility</span><span class="p">(</span><span class="s1">&#39;indexOf&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.call(#{ @array.compile o, LEVEL_LIST }, #{ref}) &quot;</span> <span class="o">+</span>
           <span class="k">if</span> <span class="nx">@negated</span> <span class="k">then</span> <span class="s1">&#39;&lt; 0&#39;</span> <span class="k">else</span> <span class="s1">&#39;&gt;= 0&#39;</span>
    <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nx">sub</span> <span class="o">is</span> <span class="nx">ref</span>
    <span class="nv">code = </span><span class="nx">sub</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span> <span class="o">+</span> <span class="nx">code</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="nx">LEVEL_LIST</span> <span class="k">then</span> <span class="nx">code</span> <span class="k">else</span> <span class="s2">&quot;(#{code})&quot;</span>

  <span class="nv">toString: </span><span class="nf">(idt) -&gt;</span>
    <span class="k">super</span> <span class="nx">idt</span><span class="p">,</span> <span class="nx">@constructor</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="k">if</span> <span class="nx">@negated</span> <span class="k">then</span> <span class="s1">&#39;!&#39;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-175">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-175">&#182;</a>               </div>               <h3>Slot</h3>

<p>A Slot is an argument passed to <code>defer(..)</code>.  It's a bit different
 from a normal parameters, since it's trying to implement pass-by-reference.
 It's used only in concert with the Defer class.  Splats and Values
 can be converted to slots with the <code>toSlot</code> method.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Slot = </span><span class="k">class</span> <span class="nx">Slot</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor : </span><span class="nf">(index, value, suffix, splat) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@index = </span><span class="nx">index</span>
    <span class="vi">@value = </span><span class="nx">value</span>
    <span class="vi">@suffix = </span><span class="nx">suffix</span>
    <span class="vi">@splat = </span><span class="nx">splat</span>
    <span class="vi">@access = </span><span class="kc">null</span>

  <span class="nv">addAccess : </span><span class="nf">(a) -&gt;</span>
    <span class="vi">@access = </span><span class="nx">a</span>
    <span class="k">this</span>

  <span class="nv">children : </span><span class="p">[</span> <span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;suffix&#39;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-176">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-176">&#182;</a>               </div>               <h3>Defer</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Defer = </span><span class="k">class</span> <span class="nx">Defer</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor : </span><span class="nf">(args, @lineno) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@slots = </span><span class="nx">flatten</span> <span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">toSlot</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">a</span><span class="p">,</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">args</span><span class="p">)</span>
    <span class="vi">@params = </span><span class="p">[]</span>
    <span class="vi">@vars = </span><span class="p">[]</span>

  <span class="nv">children : </span><span class="p">[</span><span class="s1">&#39;slots&#39;</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-177">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-177">&#182;</a>               </div>               <p>Count hidden parameters up from 1.  Make a note of which parameter
we passed out.  Return a copy of that parameter, in case we mutate
it later before we output it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">newParam : </span><span class="o">-&gt;</span>
    <span class="nv">l = </span><span class="s2">&quot;#{iced.const.slot}_#{@params.length + 1}&quot;</span>
    <span class="nx">@params</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Param</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">l</span>
    <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">l</span></pre></div>             </td>           </tr>                               <tr id="section-178">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-178">&#182;</a>               </div>               <p>makeAssignFn
  - Implement C++-style pass-by-reference in Coffee</p>

<p>the 'assign_fn' returned by here will set all parameters to defer()
to have the appropriate values after the defer is fulfilled. The
four cases to consider are listed in the following call:</p>

<pre><code>defer(x, a.b, c.d[i], rest...)
</code></pre>

<p>Case 1 -- defer(x) --  Regular assignment to a local variable
Case 2 -- defer(a.b) --  Assignment to an object; must capture
   object when defer() is called
Case 3 -- defer(c.d[i]) --  Assignment to an array slot; must capture
  array and slot index with defer() is called
Case 4 -- defer(rest...) -- rest is an array, assign it to all
  leftover arguments.</p>

<p>There is a special subcase of Case 1, which we call case 1(b):</p>

<p>defer _</p>

<p>In this case, the slot used is the return value for the surrounding await call,
for cases such as:</p>

<p>x = await foo defer _</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeAssignFn : </span><span class="nf">(o) -&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="k">if</span> <span class="nx">@slots</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">0</span>
    <span class="nv">assignments = </span><span class="p">[]</span>
    <span class="nv">args = </span><span class="p">[]</span>
    <span class="nv">i = </span><span class="mi">0</span>
    <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">@slots</span>
      <span class="nv">i = </span><span class="nx">s</span><span class="p">.</span><span class="nx">index</span>
      <span class="nv">a = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;arguments&quot;</span>
      <span class="nv">i_lit = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">i</span>
      <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">splat</span> <span class="c1"># case 4</span>
        <span class="nv">func = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="nx">utility</span> <span class="s1">&#39;slice&#39;</span><span class="p">)</span>
        <span class="nx">func</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;call&#39;</span>
        <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">func</span><span class="p">,</span> <span class="p">[</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">i_lit</span> <span class="p">]</span>
        <span class="nv">slot = </span><span class="nx">s</span><span class="p">.</span><span class="nx">value</span>
        <span class="nx">@vars</span><span class="p">.</span><span class="nx">push</span> <span class="nx">slot</span>
        <span class="nv">assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">slot</span><span class="p">,</span> <span class="nx">call</span>
      <span class="k">else</span>
        <span class="nx">a</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Index</span> <span class="nx">i_lit</span>
        <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">access</span>
          <span class="nx">a</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">s</span><span class="p">.</span><span class="nx">access</span>
        <span class="k">if</span> <span class="o">not</span> <span class="nx">s</span><span class="p">.</span><span class="nx">suffix</span> <span class="c1"># case 1</span>
          <span class="nv">lit = </span><span class="nx">s</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span>
          <span class="k">if</span> <span class="nx">lit</span> <span class="o">is</span> <span class="s2">&quot;_&quot;</span>
            <span class="nv">slot = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">deferrals</span>
            <span class="nx">slot</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">retslot</span>
          <span class="k">else</span>
            <span class="nv">slot = </span><span class="nx">s</span><span class="p">.</span><span class="nx">value</span>
            <span class="nx">@vars</span><span class="p">.</span><span class="nx">push</span> <span class="nx">slot</span>
        <span class="k">else</span>
          <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">s</span><span class="p">.</span><span class="nx">value</span>
          <span class="nv">slot = </span><span class="nx">@newParam</span><span class="p">()</span>
          <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">suffix</span> <span class="k">instanceof</span> <span class="nx">Index</span> <span class="c1"># case 3</span>
            <span class="nv">prop = </span><span class="k">new</span> <span class="nx">Index</span> <span class="nx">@newParam</span><span class="p">()</span>
            <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">s</span><span class="p">.</span><span class="nx">suffix</span><span class="p">.</span><span class="nx">index</span>
          <span class="k">else</span> <span class="c1"># case 2</span>
            <span class="nv">prop = </span><span class="nx">s</span><span class="p">.</span><span class="nx">suffix</span>
          <span class="nx">slot</span><span class="p">.</span><span class="nx">add</span> <span class="nx">prop</span>
        <span class="nv">assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">slot</span><span class="p">,</span> <span class="nx">a</span>
      <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">assign</span>

    <span class="nv">block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="nx">assignments</span>
    <span class="nv">inner_fn = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="nx">block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="nv">outer_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Return</span> <span class="nx">inner_fn</span> <span class="p">]</span>
    <span class="nv">outer_fn = </span><span class="k">new</span> <span class="nx">Code</span> <span class="nx">@params</span><span class="p">,</span> <span class="nx">outer_block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">outer_fn</span><span class="p">,</span> <span class="nx">args</span>

  <span class="nv">transform : </span><span class="nf">(o) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-179">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-179">&#182;</a>               </div>               <p>fn is 'Deferrals.defer'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">fn = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">deferrals</span>
    <span class="nv">meth = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">defer_method</span>
    <span class="nx">fn</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">meth</span></pre></div>             </td>           </tr>                               <tr id="section-180">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-180">&#182;</a>               </div>               <p>There is one argument to Deferrals.defer(), which is a dictionary.
The dictionary currently only has one slot: assign_fn, which
  indicates a function.
More slots will be needed if we ever want to keep track of iced-aware
  stack traces.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">assignments = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">assign_fn = </span><span class="nx">@makeAssignFn</span> <span class="nx">o</span><span class="p">)</span>
      <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Assign</span><span class="p">(</span><span class="k">new</span> <span class="nx">Value</span><span class="p">(</span><span class="k">new</span> <span class="nx">Literal</span><span class="p">(</span><span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">assign_fn</span><span class="p">)),</span>
                                  <span class="nx">assign_fn</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span><span class="p">)</span>
    <span class="nv">ln_lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">lineno</span>
    <span class="nv">ln_rhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">@lineno</span>
    <span class="nv">ln_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ln_lhs</span><span class="p">,</span> <span class="nx">ln_rhs</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span>
    <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">ln_assign</span>
    <span class="nv">o = </span><span class="k">new</span> <span class="nx">Obj</span> <span class="nx">assignments</span></pre></div>             </td>           </tr>                               <tr id="section-181">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-181">&#182;</a>               </div>               <p>Return the final call</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">new</span> <span class="nx">Call</span> <span class="nx">fn</span><span class="p">,</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Value</span> <span class="nx">o</span> <span class="p">]</span>

  <span class="nv">compileNode : </span><span class="nf">(o) -&gt;</span>
    <span class="nv">call = </span><span class="nx">@transform</span> <span class="nx">o</span>
    <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">@vars</span>
      <span class="nv">name = </span><span class="nx">v</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
      <span class="nv">scope = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">add</span> <span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span>
    <span class="nx">call</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>

  <span class="nv">icedWalkAst : </span><span class="nf">(p, o) -&gt;</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="nv">o.foundDefer = </span><span class="kc">true</span>
    <span class="vi">@parentFunc = </span><span class="nx">o</span><span class="p">.</span><span class="nx">currFunc</span>
    <span class="k">super</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-182">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-182">&#182;</a>               </div>               <h3>Await</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Await = </span><span class="k">class</span> <span class="nx">Await</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor : </span><span class="nf">(@body) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">transform : </span><span class="nf">(o) -&gt;</span>
    <span class="nv">body = </span><span class="nx">@body</span>
    <span class="nv">name = </span><span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">deferrals</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">add</span> <span class="nx">name</span><span class="p">,</span> <span class="s1">&#39;var&#39;</span>
    <span class="nv">lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">name</span>
    <span class="nv">cls = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">ns</span>
    <span class="nx">cls</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">new</span> <span class="nx">Access</span><span class="p">(</span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">Deferrals</span><span class="p">))</span>

    <span class="nv">assignments = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nv">n = </span><span class="nx">@parentFunc</span><span class="o">?</span><span class="p">.</span><span class="nx">icedPassedDeferral</span>
      <span class="nv">cb_lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">parent</span>
      <span class="nv">cb_rhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">n</span>
      <span class="nv">cb_assignment = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">cb_lhs</span><span class="p">,</span> <span class="nx">cb_rhs</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span>
      <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">cb_assignment</span>

    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">filename</span><span class="o">?</span>
      <span class="nv">fn_lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">filename</span>
      <span class="nv">fn_rhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">o</span><span class="p">.</span><span class="nx">filename</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
      <span class="nv">fn_assignment = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">fn_lhs</span><span class="p">,</span> <span class="nx">fn_rhs</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span>
      <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fn_assignment</span>

    <span class="k">if</span> <span class="nv">n = </span><span class="nx">@parentFunc</span><span class="o">?</span><span class="p">.</span><span class="nx">traceName</span><span class="p">()</span>
      <span class="nv">func_lhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">funcname</span>
      <span class="nv">func_rhs = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="nx">n</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span>
      <span class="nv">func_assignment = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">func_lhs</span><span class="p">,</span> <span class="nx">func_rhs</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span>
      <span class="nx">assignments</span><span class="p">.</span><span class="nx">push</span> <span class="nx">func_assignment</span>

    <span class="nv">trace = </span><span class="k">new</span> <span class="nx">Obj</span> <span class="nx">assignments</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">cls</span><span class="p">,</span> <span class="p">[</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span><span class="p">),</span> <span class="nx">trace</span> <span class="p">]</span>
    <span class="nv">rhs = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span> <span class="nx">call</span>
    <span class="nv">assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">lhs</span><span class="p">,</span> <span class="nx">rhs</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">assign</span>
    <span class="nv">meth = </span><span class="nx">lhs</span><span class="p">.</span><span class="nx">copy</span><span class="p">().</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">fulfill</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">meth</span><span class="p">,</span> <span class="p">[]</span>
    <span class="nx">body</span><span class="p">.</span><span class="nx">push</span> <span class="p">(</span><span class="nx">call</span><span class="p">)</span>
    <span class="vi">@body = </span><span class="nx">body</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-183">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-183">&#182;</a>               </div>               <p>??? Revisit!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isStatement: </span><span class="o">-&gt;</span> <span class="nx">YES</span>

  <span class="nv">makeReturn : </span><span class="nx">THIS</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@transform</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-184">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-184">&#182;</a>               </div>               <p>We still need to walk our children to see if there are any embedded
function which might also be iced.  But we're always going to report
to our parent that we are iced, since we are!</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedWalkAst : </span><span class="nf">(p, o) -&gt;</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="vi">@parentFunc = </span><span class="nx">o</span><span class="p">.</span><span class="nx">currFunc</span>
    <span class="nv">p = </span><span class="nx">p</span> <span class="o">||</span> <span class="k">this</span>
    <span class="vi">@icedParentAwait = </span><span class="nx">p</span>
    <span class="k">super</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
    <span class="vi">@icedNodeFlag = </span><span class="nv">o.foundAwaitFunc = o.foundAwait = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-185">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-185">&#182;</a>               </div>               <h3>IcedRuntime</h3>

<p>By default, the iced libraries are require'd via nodejs' require.
You can change this behavior on the command line:</p>

<p>-I inline --- inlines a simplified runtime to the output file
   -I node   --- force node.js inclusion
   -I window --- attach the inlined runtime to the window.* object
   -I none   --- no inclusion, do it yourself...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">IcedRuntime</span> <span class="k">extends</span> <span class="nx">Block</span>
  <span class="nv">constructor: </span><span class="nf">(@foundDefer, @foundAwait) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@expressions = </span><span class="p">[]</span>

    <span class="nv">v = </span><span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">runtime</span>    <span class="k">then</span> <span class="nx">o</span><span class="p">.</span><span class="nx">runtime</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">bare</span>      <span class="k">then</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nx">@foundDefer</span> <span class="k">then</span> <span class="s2">&quot;node&quot;</span>
    <span class="k">else</span>                     <span class="s2">&quot;none&quot;</span>

    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">runtime</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@foundDefer</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">o</span><span class="p">.</span><span class="nx">runforce</span>
      <span class="nv">v = </span><span class="s2">&quot;none&quot;</span>

    <span class="nv">window_mode = </span><span class="kc">false</span>
    <span class="nv">window_val = </span><span class="kc">null</span>

    <span class="nv">inc = </span><span class="kc">null</span>
    <span class="nv">inc = </span><span class="k">switch</span> <span class="p">(</span><span class="nx">v</span><span class="p">)</span>
      <span class="k">when</span> <span class="s2">&quot;inline&quot;</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span>
        <span class="nv">window_mode = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">v</span> <span class="o">is</span> <span class="s2">&quot;window&quot;</span>
        <span class="k">if</span> <span class="nx">window_mode</span>
          <span class="nv">window_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">v</span>
        <span class="nx">InlineRuntime</span><span class="p">.</span><span class="nx">generate</span><span class="p">(</span><span class="k">if</span> <span class="nx">window_val</span> <span class="k">then</span> <span class="nx">window_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
      <span class="k">when</span> <span class="s2">&quot;node&quot;</span>
        <span class="nv">file = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;&#39;iced-coffee-script&#39;&quot;</span>
        <span class="nv">access = </span><span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">ns</span>
        <span class="nv">req = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;require&quot;</span>
        <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">req</span><span class="p">,</span> <span class="p">[</span> <span class="nx">file</span> <span class="p">]</span>
        <span class="nv">callv = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">call</span>
        <span class="nx">callv</span><span class="p">.</span><span class="nx">add</span> <span class="nx">access</span>
        <span class="nv">ns = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">ns</span>
        <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">callv</span>
      <span class="k">when</span> <span class="s2">&quot;none&quot;</span> <span class="k">then</span> <span class="kc">null</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;unexpected flag IcedRuntime #{v}&quot;</span>

    <span class="nx">@push</span> <span class="nx">inc</span> <span class="k">if</span> <span class="nx">inc</span>

    <span class="k">if</span> <span class="nx">@foundAwait</span>
      </pre></div>             </td>           </tr>                               <tr id="section-186">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-186">&#182;</a>               </div>               <p>Emit <em>_iced</em>k = <em>_iced</em>k_noop = function(){} </p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">rhs = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[]</span>

      <span class="nv">lhs_vec = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">k</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k_noop</span><span class="p">,</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span> <span class="p">]</span>
        <span class="nv">val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">k</span>
        </pre></div>             </td>           </tr>                               <tr id="section-187">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-187">&#182;</a>               </div>               <p>Add window. if necessary</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">window_val</span>
          <span class="nv">klass = </span><span class="nx">window_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
          <span class="nx">klass</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">val</span>
          <span class="nv">val = </span><span class="nx">klass</span>
          
        <span class="nx">lhs_vec</span><span class="p">.</span><span class="nx">push</span> <span class="nx">val</span>
          
      <span class="nv">assign = </span><span class="nx">rhs</span>
      <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">lhs_vec</span>
        <span class="nv">assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">v</span><span class="p">,</span> <span class="nx">assign</span>
      <span class="nx">@push</span> <span class="nx">assign</span>

    <span class="k">if</span> <span class="nx">@isEmpty</span><span class="p">()</span> <span class="k">then</span> <span class="kc">null</span>
    <span class="k">else</span>               <span class="k">super</span> <span class="nx">o</span>

  <span class="nv">icedWalkAst : </span><span class="nf">(p,o) -&gt;</span>
    <span class="vi">@icedHasAutocbFlag = </span><span class="nx">o</span><span class="p">.</span><span class="nx">foundAutocb</span>
    <span class="k">super</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-188">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-188">&#182;</a>               </div>               <h3>Try</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-189">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-189">&#182;</a>               </div>               <p>A classic <em>try/catch/finally</em> block.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Try = </span><span class="k">class</span> <span class="nx">Try</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@attempt, @error, @recovery, @ensure) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;attempt&#39;</span><span class="p">,</span> <span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;ensure&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="nx">YES</span>

  <span class="nv">jumps: </span><span class="nf">(o) -&gt;</span> <span class="nx">@attempt</span><span class="p">.</span><span class="nx">jumps</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@recovery</span><span class="o">?</span><span class="p">.</span><span class="nx">jumps</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>

  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="vi">@attempt  = </span><span class="nx">@attempt</span> <span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span> <span class="k">if</span> <span class="nx">@attempt</span>
    <span class="vi">@recovery = </span><span class="nx">@recovery</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span> <span class="k">if</span> <span class="nx">@recovery</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-190">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-190">&#182;</a>               </div>               <p>Compilation is more or less as you would expect -- the <em>finally</em> clause
is optional, the <em>catch</em> is not.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">indent</span>  <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="nv">errorPart = </span><span class="k">if</span> <span class="nx">@error</span> <span class="k">then</span> <span class="s2">&quot; (#{ @error.compile o }) &quot;</span> <span class="k">else</span> <span class="s1">&#39; &#39;</span>
    <span class="nv">tryPart   = </span><span class="nx">@attempt</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span>

    <span class="nv">catchPart = </span><span class="k">if</span> <span class="nx">@recovery</span>
      <span class="k">if</span> <span class="nx">@error</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="nx">STRICT_PROSCRIBED</span>
        <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s2">&quot;catch variable may not be \&quot;#{@error.value}\&quot;&quot;</span>
      <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@error</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span> <span class="nx">unless</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span> <span class="nx">@error</span><span class="p">.</span><span class="nx">value</span>
      <span class="s2">&quot; catch#{errorPart}{\n#{ @recovery.compile o, LEVEL_TOP }\n#{@tab}}&quot;</span>
    <span class="k">else</span> <span class="nx">unless</span> <span class="nx">@ensure</span> <span class="o">or</span> <span class="nx">@recovery</span>
      <span class="s1">&#39; catch (_error) {}&#39;</span>

    <span class="nv">ensurePart = </span><span class="k">if</span> <span class="nx">@ensure</span> <span class="k">then</span> <span class="s2">&quot; finally {\n#{ @ensure.compile o, LEVEL_TOP }\n#{@tab}}&quot;</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="s2">&quot;&quot;&quot;#{@tab}try {</span>
<span class="s2">    #{tryPart}</span>
<span class="s2">    #{@tab}}#{ catchPart or &#39;&#39; }#{ensurePart}&quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-191">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-191">&#182;</a>               </div>               <h3>Throw</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-192">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-192">&#182;</a>               </div>               <p>Simple node to throw an exception.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Throw = </span><span class="k">class</span> <span class="nx">Throw</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@expression) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="nx">YES</span>
  <span class="nv">jumps: </span>      <span class="nx">NO</span></pre></div>             </td>           </tr>                               <tr id="section-193">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-193">&#182;</a>               </div>               <p>A <strong>Throw</strong> is already a return, of sorts...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">makeReturn: </span><span class="nx">THIS</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@tab</span> <span class="o">+</span> <span class="s2">&quot;throw #{ @expression.compile o };&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-194">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-194">&#182;</a>               </div>               <h3>Existence</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-195">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-195">&#182;</a>               </div>               <p>Checks a variable for existence -- not <em>null</em> and not <em>undefined</em>. This is
similar to <code>.nil?</code> in Ruby, and avoids having to consult a JavaScript truth
table.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Existence = </span><span class="k">class</span> <span class="nx">Existence</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@expression) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;expression&#39;</span><span class="p">]</span>

  <span class="nv">invert: </span><span class="nx">NEGATE</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="vi">@expression.front = </span><span class="nx">@front</span>
    <span class="nv">code = </span><span class="nx">@expression</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_OP</span>
    <span class="k">if</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">check</span> <span class="nx">code</span>
      <span class="p">[</span><span class="nx">cmp</span><span class="p">,</span> <span class="nx">cnj</span><span class="p">]</span> <span class="o">=</span> <span class="k">if</span> <span class="nx">@negated</span> <span class="k">then</span> <span class="p">[</span><span class="s1">&#39;===&#39;</span><span class="p">,</span> <span class="s1">&#39;||&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="p">[</span><span class="s1">&#39;!==&#39;</span><span class="p">,</span> <span class="s1">&#39;&amp;&amp;&#39;</span><span class="p">]</span>
      <span class="nv">code = </span><span class="s2">&quot;typeof #{code} #{cmp} \&quot;undefined\&quot; #{cnj} #{code} #{cmp} null&quot;</span>
    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-196">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-196">&#182;</a>               </div>               <p>do not use strict equality here; it will break existing code</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">code = </span><span class="s2">&quot;#{code} #{if @negated then &#39;==&#39; else &#39;!=&#39;} null&quot;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;=</span> <span class="nx">LEVEL_COND</span> <span class="k">then</span> <span class="nx">code</span> <span class="k">else</span> <span class="s2">&quot;(#{code})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-197">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-197">&#182;</a>               </div>               <h3>Parens</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-198">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-198">&#182;</a>               </div>               <p>An extra set of parentheses, specified explicitly in the source. At one time
we tried to clean up the results by detecting and removing redundant
parentheses, but no longer -- you can put in as many as you please.</p>

<p>Parentheses are a good way to force any statement to become an expression.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Parens = </span><span class="k">class</span> <span class="nx">Parens</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@body) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">]</span>

  <span class="nv">unwrap    : </span><span class="o">-&gt;</span> <span class="nx">@icedUnwrap</span> <span class="nx">@body</span>
  <span class="nv">isComplex : </span><span class="o">-&gt;</span> <span class="nx">@body</span><span class="p">.</span><span class="nx">isComplex</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-199">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-199">&#182;</a>               </div>               <p>icedWrapContinuation : YES
icedCpsRotate: ->
 @body = b if (b = @icedCpsExprRotate @body)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">expr = </span><span class="nx">@body</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">isAtomic</span><span class="p">()</span>
      <span class="nv">expr.front = </span><span class="nx">@front</span>
      <span class="k">return</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="nv">code = </span><span class="nx">expr</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_PAREN</span>
    <span class="nv">bare = </span><span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&lt;</span> <span class="nx">LEVEL_OP</span> <span class="o">and</span> <span class="p">(</span><span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Op</span> <span class="o">or</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Call</span> <span class="o">or</span>
      <span class="p">(</span><span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">For</span> <span class="o">and</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">returns</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">bare</span> <span class="k">then</span> <span class="nx">code</span> <span class="k">else</span> <span class="s2">&quot;(#{code})&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-200">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-200">&#182;</a>               </div>               <h3>For</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-201">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-201">&#182;</a>               </div>               <p>CoffeeScript's replacement for the <em>for</em> loop is our array and object
comprehensions, that compile into <em>for</em> loops here. They also act as an
expression, able to return the result of each filtered iteration.</p>

<p>Unlike Python array comprehensions, they can be multi-line, and you can pass
the current index of the loop as a second parameter. Unlike Ruby blocks,
you can map and filter in a single pass.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.For = </span><span class="k">class</span> <span class="nx">For</span> <span class="k">extends</span> <span class="nx">While</span>
  <span class="nv">constructor: </span><span class="nf">(body, source) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@condition = </span><span class="kc">null</span>
    <span class="p">{</span><span class="nx">@source</span><span class="p">,</span> <span class="nx">@guard</span><span class="p">,</span> <span class="nx">@step</span><span class="p">,</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@index</span><span class="p">}</span> <span class="o">=</span> <span class="nx">source</span>
    <span class="vi">@body    = </span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="nx">body</span><span class="p">]</span>
    <span class="vi">@own     = </span><span class="o">!!</span><span class="nx">source</span><span class="p">.</span><span class="nx">own</span>
    <span class="vi">@object  = </span><span class="o">!!</span><span class="nx">source</span><span class="p">.</span><span class="nx">object</span>
    <span class="p">[</span><span class="nx">@name</span><span class="p">,</span> <span class="nx">@index</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">@index</span><span class="p">,</span> <span class="nx">@name</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@object</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;index cannot be a pattern matching expression&#39;</span> <span class="k">if</span> <span class="nx">@index</span> <span class="k">instanceof</span> <span class="nx">Value</span>
    <span class="vi">@range   = </span><span class="nx">@source</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">base</span> <span class="k">instanceof</span> <span class="nx">Range</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">length</span>
    <span class="vi">@pattern = </span><span class="nx">@name</span> <span class="k">instanceof</span> <span class="nx">Value</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;indexes do not apply to range loops&#39;</span> <span class="k">if</span> <span class="nx">@range</span> <span class="o">and</span> <span class="nx">@index</span>
    <span class="k">throw</span> <span class="nx">SyntaxError</span> <span class="s1">&#39;cannot pattern match over range loops&#39;</span> <span class="k">if</span> <span class="nx">@range</span> <span class="o">and</span> <span class="nx">@pattern</span>
    <span class="vi">@returns = </span><span class="kc">false</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;guard&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">]</span>

  <span class="nv">compileIced: </span><span class="nf">(o, d) -&gt;</span>
    <span class="k">return</span> <span class="kc">null</span> <span class="nx">unless</span> <span class="nx">@icedNodeFlag</span>

    <span class="nv">body = </span><span class="nx">d</span><span class="p">.</span><span class="nx">body</span>
    <span class="nv">condition = </span><span class="kc">null</span>
    <span class="nv">init = </span><span class="p">[]</span>
    <span class="nv">step = </span><span class="kc">null</span>
    <span class="nv">scope = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span></pre></div>             </td>           </tr>                               <tr id="section-202">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-202">&#182;</a>               </div>               <p>Handle 'for k,v of obj'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@object</span></pre></div>             </td>           </tr>                               <tr id="section-203">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-203">&#182;</a>               </div>               <p>_ref = source</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">ref = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
      <span class="nv">ref_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">ref</span>
      <span class="nv">a1 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ref_val</span><span class="p">,</span> <span class="nx">@source</span></pre></div>             </td>           </tr>                               <tr id="section-204">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-204">&#182;</a>               </div>               <p>keys = for k of _ref
  k</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">keys = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;keys&#39;</span>
      <span class="nv">keys_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">keys</span>
      <span class="nv">key = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;k&#39;</span>
      <span class="nv">key_lit = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">key</span>
      <span class="nv">key_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">key_lit</span>
      <span class="nv">empty_arr = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Arr</span>
      <span class="nv">loop_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">key_val</span> <span class="p">]</span>
      <span class="nv">loop_source = </span><span class="p">{</span> <span class="nv">object : </span><span class="kc">yes</span><span class="p">,</span> <span class="nv">name : </span><span class="nx">key_lit</span><span class="p">,</span> <span class="nv">source : </span><span class="nx">ref_val</span> <span class="p">}</span>
      <span class="nv">loop_keys = </span><span class="k">new</span> <span class="nx">For</span> <span class="nx">loop_body</span><span class="p">,</span> <span class="nx">loop_source</span>
      <span class="nv">a2 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">keys_val</span><span class="p">,</span> <span class="nx">loop_keys</span></pre></div>             </td>           </tr>                               <tr id="section-205">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-205">&#182;</a>               </div>               <p>_i = 0</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">iname = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;i&#39;</span>
      <span class="nv">ival = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iname</span>
      <span class="nv">a3 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ival</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="mi">0</span>

      <span class="nv">init = </span><span class="p">[</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">a3</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-206">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-206">&#182;</a>               </div>               <p>_i &lt; keys.length</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">keys_len = </span><span class="nx">keys_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">keys_len</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;length&quot;</span>
      <span class="nv">condition = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">ival</span><span class="p">,</span> <span class="nx">keys_len</span></pre></div>             </td>           </tr>                               <tr id="section-207">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-207">&#182;</a>               </div>               <p>_i++</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">step = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="nx">ival</span></pre></div>             </td>           </tr>                               <tr id="section-208">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-208">&#182;</a>               </div>               <p>value = _ref[name]</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@name</span>
        <span class="nv">source_access = </span><span class="nx">ref_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
        <span class="nx">source_access</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Index</span> <span class="nx">@index</span>
        <span class="nv">a5 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">source_access</span>
        <span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">a5</span></pre></div>             </td>           </tr>                               <tr id="section-209">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-209">&#182;</a>               </div>               <p>key = keys[_i]</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">keys_access = </span><span class="nx">keys_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">keys_access</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Index</span> <span class="nx">ival</span>
      <span class="nv">a4 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@index</span><span class="p">,</span> <span class="nx">keys_access</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">a4</span></pre></div>             </td>           </tr>                               <tr id="section-210">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-210">&#182;</a>               </div>               <p>Handle the case of 'for i in [0..10]'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="nx">@range</span> <span class="o">and</span> <span class="nx">@name</span>
      <span class="nv">condition = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">to</span>
      <span class="nv">init = </span><span class="p">[</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">base</span><span class="p">.</span><span class="nx">from</span> <span class="p">]</span>
      <span class="k">if</span> <span class="nx">@step</span><span class="o">?</span>
        <span class="nv">step = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s2">&quot;+=&quot;</span><span class="p">,</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@step</span>
      <span class="k">else</span>
        <span class="nv">step = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="nx">@name</span></pre></div>             </td>           </tr>                               <tr id="section-211">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-211">&#182;</a>               </div>               <p>Handle the case of 'for i,blah in arr'</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span> <span class="nx">@range</span> <span class="o">and</span> <span class="nx">@name</span>
      <span class="nv">kval = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">d</span><span class="p">.</span><span class="nx">kvar</span>
      <span class="nv">len = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;len&#39;</span>
      <span class="nv">ref = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;ref&#39;</span>
      <span class="nv">ref_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">ref</span>
      <span class="nv">len_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">len</span>
      <span class="nv">a1 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ref_val</span><span class="p">,</span> <span class="nx">@source</span>
      <span class="nv">len_rhs = </span><span class="nx">ref_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">().</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;length&quot;</span>
      <span class="nv">a2 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">len_val</span><span class="p">,</span> <span class="nx">len_rhs</span>
      <span class="nv">a3 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">kval</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="mi">0</span>
      <span class="nv">init = </span><span class="p">[</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span><span class="p">,</span> <span class="nx">a3</span> <span class="p">]</span>
      <span class="nv">condition = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="nx">kval</span><span class="p">,</span> <span class="nx">len_val</span>
      <span class="nv">step = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;++&#39;</span><span class="p">,</span> <span class="nx">kval</span>
      <span class="nv">ref_val_copy = </span><span class="nx">ref_val</span><span class="p">.</span><span class="nx">copy</span><span class="p">()</span>
      <span class="nx">ref_val_copy</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Index</span> <span class="nx">kval</span>
      <span class="nv">a4 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">ref_val_copy</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">unshift</span> <span class="nx">a4</span>

    <span class="nv">rvar = </span><span class="nx">d</span><span class="p">.</span><span class="nx">rvar</span>
    <span class="nv">guard = </span><span class="nx">d</span><span class="p">.</span><span class="nx">guard</span>
    <span class="nv">b = </span><span class="nx">@icedWrap</span> <span class="p">{</span> <span class="nx">condition</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">init</span><span class="p">,</span> <span class="nx">step</span><span class="p">,</span> <span class="nx">rvar</span><span class="p">,</span> <span class="nx">guard</span> <span class="p">}</span>
    <span class="nx">b</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-212">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-212">&#182;</a>               </div>               <p>Welcome to the hairiest method in all of CoffeeScript. Handles the inner
loop, filtering, stepping, and result saving for array, object, and range
comprehensions. Some of the generated code can be shared in common, and
some cannot.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">body      = </span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="nx">@body</span><span class="p">]</span>
    <span class="nv">lastJumps = </span><span class="nx">last</span><span class="p">(</span><span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">jumps</span><span class="p">()</span>
    <span class="vi">@returns  = </span><span class="kc">no</span> <span class="k">if</span> <span class="nx">lastJumps</span> <span class="o">and</span> <span class="nx">lastJumps</span> <span class="k">instanceof</span> <span class="nx">Return</span>
    <span class="nv">source    = </span><span class="k">if</span> <span class="nx">@range</span> <span class="k">then</span> <span class="nx">@source</span><span class="p">.</span><span class="nx">base</span> <span class="k">else</span> <span class="nx">@source</span>
    <span class="nv">scope     = </span><span class="nx">o</span><span class="p">.</span><span class="nx">scope</span>
    <span class="nv">name      = </span><span class="nx">@name</span>  <span class="o">and</span> <span class="nx">@name</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nv">index     = </span><span class="nx">@index</span> <span class="o">and</span> <span class="nx">@index</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span>  <span class="nv">immediate: </span><span class="kc">yes</span><span class="p">)</span> <span class="k">if</span> <span class="nx">name</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@pattern</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">index</span><span class="p">,</span> <span class="nv">immediate: </span><span class="kc">yes</span><span class="p">)</span> <span class="k">if</span> <span class="nx">index</span>
    <span class="nv">rvar      = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;results&#39;</span> <span class="k">if</span> <span class="nx">@returns</span>
    <span class="nv">ivar      = </span><span class="p">(</span><span class="nx">@object</span> <span class="o">and</span> <span class="nx">index</span><span class="p">)</span> <span class="o">or</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;i&#39;</span>
    <span class="nv">kvar      = </span><span class="p">(</span><span class="nx">@range</span> <span class="o">and</span> <span class="nx">name</span><span class="p">)</span> <span class="o">or</span> <span class="nx">index</span> <span class="o">or</span> <span class="nx">ivar</span>
    <span class="nv">kvarAssign = </span><span class="k">if</span> <span class="nx">kvar</span> <span class="o">isnt</span> <span class="nx">ivar</span> <span class="k">then</span> <span class="s2">&quot;#{kvar} = &quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-213">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-213">&#182;</a>               </div>               <p>the <code>_by</code> variable is created twice in <code>Range</code>s if we don't prevent it from being declared here</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">stepvar   = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s2">&quot;step&quot;</span> <span class="k">if</span> <span class="nx">@step</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@range</span>
    <span class="nv">name      = </span><span class="nx">ivar</span> <span class="k">if</span> <span class="nx">@pattern</span>
    <span class="nv">varPart   = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">guardPart = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">defPart   = </span><span class="s1">&#39;&#39;</span>
    <span class="nv">idt1      = </span><span class="nx">@tab</span> <span class="o">+</span> <span class="nx">TAB</span>

    <span class="k">return</span> <span class="nx">code</span> <span class="k">if</span> <span class="nv">code = </span><span class="nx">@compileIced</span> <span class="nx">o</span><span class="p">,</span> <span class="p">{</span> <span class="nx">stepvar</span><span class="p">,</span> <span class="nx">body</span><span class="p">,</span> <span class="nx">rvar</span><span class="p">,</span> <span class="nx">kvar</span><span class="p">,</span> <span class="nx">@guard</span> <span class="p">}</span>

    <span class="k">if</span> <span class="nx">@range</span>
      <span class="nv">forPart = </span><span class="nx">source</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="p">{</span><span class="nv">index: </span><span class="nx">ivar</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">@step</span><span class="p">})</span>
    <span class="k">else</span>
      <span class="nv">svar    = </span><span class="nx">@source</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">name</span> <span class="o">or</span> <span class="nx">@own</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">IDENTIFIER</span><span class="p">.</span><span class="nx">test</span> <span class="nx">svar</span>
        <span class="nv">defPart    = </span><span class="s2">&quot;#{@tab}#{ref = scope.freeVariable &#39;ref&#39;} = #{svar};\n&quot;</span>
        <span class="nv">svar       = </span><span class="nx">ref</span>
      <span class="k">if</span> <span class="nx">name</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@pattern</span>
        <span class="nv">namePart   = </span><span class="s2">&quot;#{name} = #{svar}[#{kvar}]&quot;</span>
      <span class="nx">unless</span> <span class="nx">@object</span>
        <span class="nv">lvar       = </span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;len&#39;</span>
        <span class="nv">forVarPart = </span><span class="s2">&quot;#{kvarAssign}#{ivar} = 0, #{lvar} = #{svar}.length&quot;</span>
        <span class="nx">forVarPart</span> <span class="o">+=</span> <span class="s2">&quot;, #{stepvar} = #{@step.compile o, LEVEL_OP}&quot;</span> <span class="k">if</span> <span class="nx">@step</span>
        <span class="nv">stepPart   = </span><span class="s2">&quot;#{kvarAssign}#{if @step then &quot;</span><span class="c1">#{ivar} += #{stepvar}&quot; else (if kvar isnt ivar then &quot;++#{ivar}&quot; else &quot;#{ivar}++&quot;)}&quot;</span>
        <span class="nv">forPart    = </span><span class="s2">&quot;#{forVarPart}; #{ivar} &lt; #{lvar}; #{stepPart}&quot;</span>
    <span class="k">if</span> <span class="nx">@returns</span>
      <span class="nv">resultPart   = </span><span class="s2">&quot;#{@tab}#{rvar} = [];\n&quot;</span>
      <span class="nv">returnResult = </span><span class="k">if</span> <span class="nx">@icedHasAutocbFlag</span>
        <span class="s2">&quot;\n#{@tab}#{iced.const.autocb}(#{rvar}); return;&quot;</span>
      <span class="k">else</span>
        <span class="s2">&quot;\n#{@tab}return #{rvar};&quot;</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">rvar</span>
    <span class="k">if</span> <span class="nx">@guard</span>
      <span class="k">if</span> <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">If</span> <span class="p">(</span><span class="k">new</span> <span class="nx">Parens</span> <span class="nx">@guard</span><span class="p">).</span><span class="nx">invert</span><span class="p">(),</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;continue&quot;</span>
      <span class="k">else</span>
        <span class="nv">body = </span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="k">new</span> <span class="nx">If</span> <span class="nx">@guard</span><span class="p">,</span> <span class="nx">body</span><span class="p">]</span> <span class="k">if</span> <span class="nx">@guard</span>
    <span class="k">if</span> <span class="nx">@pattern</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">unshift</span> <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">@name</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;#{svar}[#{kvar}]&quot;</span>
    <span class="nx">defPart</span>     <span class="o">+=</span> <span class="nx">@pluckDirectCall</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">body</span>
    <span class="nv">varPart     = </span><span class="s2">&quot;\n#{idt1}#{namePart};&quot;</span> <span class="k">if</span> <span class="nx">namePart</span>
    <span class="k">if</span> <span class="nx">@object</span>
      <span class="nv">forPart   = </span><span class="s2">&quot;#{kvar} in #{svar}&quot;</span>
      <span class="nv">guardPart = </span><span class="s2">&quot;\n#{idt1}if (!#{utility &#39;hasProp&#39;}.call(#{svar}, #{kvar})) continue;&quot;</span> <span class="k">if</span> <span class="nx">@own</span>
    <span class="nv">body        = </span><span class="nx">body</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">merge</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nv">indent: </span><span class="nx">idt1</span><span class="p">),</span> <span class="nx">LEVEL_TOP</span>
    <span class="nv">body        = </span><span class="s1">&#39;\n&#39;</span> <span class="o">+</span> <span class="nx">body</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="k">if</span> <span class="nx">body</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    #{defPart}#{resultPart or &#39;&#39;}#{@tab}for (#{forPart}) {#{guardPart}#{varPart}#{body}#{@tab}}#{returnResult or &#39;&#39;}</span>
<span class="s2">    &quot;&quot;&quot;</span>

  <span class="nv">pluckDirectCall: </span><span class="nf">(o, body) -&gt;</span>
    <span class="nv">defs = </span><span class="s1">&#39;&#39;</span>
    <span class="k">for</span> <span class="nx">expr</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">in</span> <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span>
      <span class="nv">expr = </span><span class="nx">expr</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()</span>
      <span class="k">continue</span> <span class="nx">unless</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Call</span>
      <span class="nv">val = </span><span class="nx">expr</span><span class="p">.</span><span class="nx">variable</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()</span>
      <span class="k">continue</span> <span class="nx">unless</span> <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nx">Code</span><span class="p">)</span> <span class="o">or</span>
                      <span class="p">(</span><span class="nx">val</span> <span class="k">instanceof</span> <span class="nx">Value</span> <span class="o">and</span>
                      <span class="nx">val</span><span class="p">.</span><span class="nx">base</span><span class="o">?</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()</span> <span class="k">instanceof</span> <span class="nx">Code</span> <span class="o">and</span>
                      <span class="nx">val</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">1</span> <span class="o">and</span>
                      <span class="nx">val</span><span class="p">.</span><span class="nx">properties</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">name</span><span class="o">?</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="p">[</span><span class="s1">&#39;call&#39;</span><span class="p">,</span> <span class="s1">&#39;apply&#39;</span><span class="p">])</span>
      <span class="nv">fn    = </span><span class="nx">val</span><span class="p">.</span><span class="nx">base</span><span class="o">?</span><span class="p">.</span><span class="nx">unwrapAll</span><span class="p">()</span> <span class="o">or</span> <span class="nx">val</span>
      <span class="nv">ref   = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">o</span><span class="p">.</span><span class="nx">scope</span><span class="p">.</span><span class="nx">freeVariable</span> <span class="s1">&#39;fn&#39;</span>
      <span class="nv">base  = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">ref</span>
      <span class="k">if</span> <span class="nx">val</span><span class="p">.</span><span class="nx">base</span>
        <span class="p">[</span><span class="nx">val</span><span class="p">.</span><span class="nx">base</span><span class="p">,</span> <span class="nx">base</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">base</span><span class="p">,</span> <span class="nx">val</span><span class="p">]</span>
      <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Call</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">args</span>
      <span class="nx">defs</span> <span class="o">+=</span> <span class="nx">@tab</span> <span class="o">+</span> <span class="k">new</span> <span class="nx">Assign</span><span class="p">(</span><span class="nx">ref</span><span class="p">,</span> <span class="nx">fn</span><span class="p">).</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;\n&#39;</span>
    <span class="nx">defs</span></pre></div>             </td>           </tr>                               <tr id="section-214">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-214">&#182;</a>               </div>               <h3>Switch</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-215">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-215">&#182;</a>               </div>               <p>A JavaScript <em>switch</em> statement. Converts into a returnable expression on-demand.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Switch = </span><span class="k">class</span> <span class="nx">Switch</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(@subject, @cases, @otherwise) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span> <span class="s1">&#39;cases&#39;</span><span class="p">,</span> <span class="s1">&#39;otherwise&#39;</span><span class="p">]</span>

  <span class="nv">isStatement: </span><span class="nx">YES</span>

  <span class="nv">jumps: </span><span class="nf">(o = {block: yes}) -&gt;</span>
    <span class="k">for</span> <span class="p">[</span><span class="nx">conds</span><span class="p">,</span> <span class="nx">block</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@cases</span>
      <span class="k">return</span> <span class="nx">block</span> <span class="k">if</span> <span class="nx">block</span><span class="p">.</span><span class="nx">jumps</span> <span class="nx">o</span>
    <span class="nx">@otherwise</span><span class="o">?</span><span class="p">.</span><span class="nx">jumps</span> <span class="nx">o</span>

  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="nx">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">makeReturn</span> <span class="nx">res</span> <span class="k">for</span> <span class="nx">pair</span> <span class="k">in</span> <span class="nx">@cases</span>
    <span class="nx">@otherwise</span> <span class="o">or=</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;void 0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nx">res</span>
    <span class="nx">@otherwise</span><span class="o">?</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span>
    <span class="k">this</span>

  <span class="nv">icedCallContinuation : </span><span class="o">-&gt;</span>
    <span class="k">for</span> <span class="p">[</span><span class="nx">condition</span><span class="p">,</span><span class="nx">block</span><span class="p">]</span> <span class="k">in</span> <span class="nx">@cases</span>
      <span class="nx">block</span><span class="p">.</span><span class="nx">icedThreadReturn</span><span class="p">()</span>
    <span class="nx">@otherwise</span><span class="o">?</span><span class="p">.</span><span class="nx">icedThreadReturn</span><span class="p">()</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">idt1 = </span><span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="nv">idt2 = o.indent = </span><span class="nx">idt1</span> <span class="o">+</span> <span class="nx">TAB</span>
    <span class="nv">code = </span><span class="nx">@tab</span> <span class="o">+</span> <span class="s2">&quot;switch (#{ @subject?.compile(o, LEVEL_PAREN) or false }) {\n&quot;</span>
    <span class="k">for</span> <span class="p">[</span><span class="nx">conditions</span><span class="p">,</span> <span class="nx">block</span><span class="p">],</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">@cases</span>
      <span class="k">for</span> <span class="nx">cond</span> <span class="k">in</span> <span class="nx">flatten</span> <span class="p">[</span><span class="nx">conditions</span><span class="p">]</span>
        <span class="nv">cond  = </span><span class="nx">cond</span><span class="p">.</span><span class="nx">invert</span><span class="p">()</span> <span class="nx">unless</span> <span class="nx">@subject</span>
        <span class="nx">code</span> <span class="o">+=</span> <span class="nx">idt1</span> <span class="o">+</span> <span class="s2">&quot;case #{ cond.compile o, LEVEL_PAREN }:\n&quot;</span>
      <span class="nx">code</span> <span class="o">+=</span> <span class="nx">body</span> <span class="o">+</span> <span class="s1">&#39;\n&#39;</span> <span class="k">if</span> <span class="nv">body = </span><span class="nx">block</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span>
      <span class="k">break</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">is</span> <span class="nx">@cases</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">@otherwise</span>
      <span class="nv">expr = </span><span class="nx">@lastNonComment</span> <span class="nx">block</span><span class="p">.</span><span class="nx">expressions</span>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Return</span> <span class="o">or</span> <span class="p">(</span><span class="nx">expr</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">jumps</span><span class="p">()</span> <span class="o">and</span> <span class="nx">expr</span><span class="p">.</span><span class="nx">value</span> <span class="o">isnt</span> <span class="s1">&#39;debugger&#39;</span><span class="p">)</span>
      <span class="nx">code</span> <span class="o">+=</span> <span class="nx">idt2</span> <span class="o">+</span> <span class="s1">&#39;break;\n&#39;</span>
    <span class="nx">code</span> <span class="o">+=</span> <span class="nx">idt1</span> <span class="o">+</span> <span class="s2">&quot;default:\n#{ @otherwise.compile o, LEVEL_TOP }\n&quot;</span> <span class="k">if</span> <span class="nx">@otherwise</span> <span class="o">and</span> <span class="nx">@otherwise</span><span class="p">.</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">length</span>
    <span class="nx">code</span> <span class="o">+</span>  <span class="nx">@tab</span> <span class="o">+</span> <span class="s1">&#39;}&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-216">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-216">&#182;</a>               </div>               <h3>If</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-217">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-217">&#182;</a>               </div>               <p><em>If/else</em> statements. Acts as an expression by pushing down requested returns
to the last line of each clause.</p>

<p>Single-expression <strong>Ifs</strong> are compiled into conditional operators if possible,
because ternaries are already proper expressions, and don't need conversion.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.If = </span><span class="k">class</span> <span class="nx">If</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor: </span><span class="nf">(condition, @body, options = {}) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@condition = </span><span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">type</span> <span class="o">is</span> <span class="s1">&#39;unless&#39;</span> <span class="k">then</span> <span class="nx">condition</span><span class="p">.</span><span class="nx">invert</span><span class="p">()</span> <span class="k">else</span> <span class="nx">condition</span>
    <span class="vi">@elseBody  = </span><span class="kc">null</span>
    <span class="vi">@isChain   = </span><span class="kc">false</span>
    <span class="p">{</span><span class="nx">@soak</span><span class="p">}</span>    <span class="o">=</span> <span class="nx">options</span>

  <span class="nv">children: </span><span class="p">[</span><span class="s1">&#39;condition&#39;</span><span class="p">,</span> <span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="s1">&#39;elseBody&#39;</span><span class="p">]</span>

  <span class="nv">bodyNode: </span>    <span class="o">-&gt;</span> <span class="nx">@body</span><span class="o">?</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span>
  <span class="nv">elseBodyNode: </span><span class="o">-&gt;</span> <span class="nx">@elseBody</span><span class="o">?</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-218">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-218">&#182;</a>               </div>               <p>Rewrite a chain of <strong>Ifs</strong> to add a default case as the final <em>else</em>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">addElse: </span><span class="nf">(elseBody) -&gt;</span>
    <span class="k">if</span> <span class="nx">@isChain</span>
      <span class="nx">@elseBodyNode</span><span class="p">().</span><span class="nx">addElse</span> <span class="nx">elseBody</span>
    <span class="k">else</span>
      <span class="vi">@isChain  = </span><span class="nx">elseBody</span> <span class="k">instanceof</span> <span class="nx">If</span>
      <span class="vi">@elseBody = </span><span class="nx">@ensureBlock</span> <span class="nx">elseBody</span>
    <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-219">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-219">&#182;</a>               </div>               <p>propogate the closing continuation call down both branches of the if.
note this prevents if ...else if... inline chaining, and makes it
fully nested if { .. } else { if { } ..} ..'s</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">icedCallContinuation : </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@elseBody</span>
      <span class="nx">@elseBody</span><span class="p">.</span><span class="nx">icedThreadReturn</span><span class="p">()</span>
      <span class="vi">@isChain = </span><span class="kc">false</span>
    <span class="k">else</span>
      <span class="nx">@addElse</span> <span class="k">new</span> <span class="nx">IcedTailCall</span>
    <span class="nx">@body</span><span class="p">.</span><span class="nx">icedThreadReturn</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-220">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-220">&#182;</a>               </div>               <p>The <strong>If</strong> only compiles into a statement if either of its bodies needs
to be a statement. Otherwise a conditional operator is safe.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">isStatement: </span><span class="nf">(o) -&gt;</span>
    <span class="nx">o</span><span class="o">?</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span> <span class="o">or</span>
      <span class="nx">@bodyNode</span><span class="p">().</span><span class="nx">isStatement</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@elseBodyNode</span><span class="p">()</span><span class="o">?</span><span class="p">.</span><span class="nx">isStatement</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span>
      <span class="nx">@icedHasContinuation</span><span class="p">()</span>

  <span class="nv">jumps: </span><span class="nf">(o) -&gt;</span> <span class="nx">@body</span><span class="p">.</span><span class="nx">jumps</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@elseBody</span><span class="o">?</span><span class="p">.</span><span class="nx">jumps</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span>

  <span class="nv">compileNode: </span><span class="nf">(o) -&gt;</span>
    <span class="k">if</span> <span class="nx">@isStatement</span> <span class="nx">o</span> <span class="o">or</span> <span class="nx">@icedIsCpsPivot</span><span class="p">()</span> <span class="k">then</span> <span class="nx">@compileStatement</span> <span class="nx">o</span> <span class="k">else</span> <span class="nx">@compileExpression</span> <span class="nx">o</span>

  <span class="nv">makeReturn: </span><span class="nf">(res) -&gt;</span>
    <span class="nx">@elseBody</span>  <span class="o">or=</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;void 0&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nx">res</span>
    <span class="nx">@body</span>     <span class="o">and=</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span><span class="nx">@body</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span><span class="p">]</span>
    <span class="nx">@elseBody</span> <span class="o">and=</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span><span class="nx">@elseBody</span><span class="p">.</span><span class="nx">makeReturn</span> <span class="nx">res</span><span class="p">]</span>
    <span class="k">this</span>

  <span class="nv">ensureBlock: </span><span class="nf">(node) -&gt;</span>
    <span class="k">if</span> <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Block</span> <span class="k">then</span> <span class="nx">node</span> <span class="k">else</span> <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span><span class="nx">node</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-221">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-221">&#182;</a>               </div>               <p>Compile the <code>If</code> as a regular <em>if-else</em> statement. Flattened chains
force inner <em>else</em> bodies into statement form.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileStatement: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">child    = </span><span class="nx">del</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;chainChild&#39;</span>
    <span class="nv">exeq     = </span><span class="nx">del</span> <span class="nx">o</span><span class="p">,</span> <span class="s1">&#39;isExistentialEquals&#39;</span>

    <span class="k">if</span> <span class="nx">exeq</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nx">If</span><span class="p">(</span><span class="nx">@condition</span><span class="p">.</span><span class="nx">invert</span><span class="p">(),</span> <span class="nx">@elseBodyNode</span><span class="p">(),</span> <span class="nv">type: </span><span class="s1">&#39;if&#39;</span><span class="p">).</span><span class="nx">compile</span> <span class="nx">o</span>

    <span class="nv">cond     = </span><span class="nx">@condition</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_PAREN</span>
    <span class="nx">o</span><span class="p">.</span><span class="nx">indent</span> <span class="o">+=</span> <span class="nx">TAB</span>
    <span class="nv">body     = </span><span class="nx">@ensureBlock</span> <span class="nx">@body</span>
    <span class="nv">bodyc    = </span><span class="nx">body</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span>
    <span class="k">if</span> <span class="p">(</span>
      <span class="mi">1</span> <span class="o">is</span> <span class="nx">body</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">and</span>
      <span class="o">!</span><span class="nx">@elseBody</span> <span class="o">and</span> <span class="o">!</span><span class="nx">child</span> <span class="o">and</span>
      <span class="nx">bodyc</span> <span class="o">and</span> <span class="nx">cond</span> <span class="o">and</span>
      <span class="o">-</span><span class="mi">1</span> <span class="o">is</span> <span class="p">(</span><span class="nx">bodyc</span><span class="p">.</span><span class="nx">indexOf</span> <span class="s1">&#39;\n&#39;</span><span class="p">)</span> <span class="o">and</span>
      <span class="mi">80</span> <span class="o">&gt;</span> <span class="nx">cond</span><span class="p">.</span><span class="nx">length</span> <span class="o">+</span> <span class="nx">bodyc</span><span class="p">.</span><span class="nx">length</span>
    <span class="p">)</span>
      <span class="k">return</span> <span class="s2">&quot;#{@tab}if (#{cond}) #{bodyc.replace /^\s+/, &#39;&#39;}&quot;</span>
    <span class="nv">bodyc    = </span><span class="s2">&quot;\n#{bodyc}\n#{@tab}&quot;</span> <span class="k">if</span> <span class="nx">bodyc</span>
    <span class="nv">ifPart   = </span><span class="s2">&quot;if (#{cond}) {#{bodyc}}&quot;</span>
    <span class="nv">ifPart   = </span><span class="nx">@tab</span> <span class="o">+</span> <span class="nx">ifPart</span> <span class="nx">unless</span> <span class="nx">child</span>
    <span class="k">return</span> <span class="nx">ifPart</span> <span class="nx">unless</span> <span class="nx">@elseBody</span>
    <span class="nx">ifPart</span> <span class="o">+</span> <span class="s1">&#39; else &#39;</span> <span class="o">+</span> <span class="k">if</span> <span class="nx">@isChain</span>
      <span class="nv">o.indent = </span><span class="nx">@tab</span>
      <span class="nv">o.chainChild = </span><span class="kc">yes</span>
      <span class="nx">@elseBody</span><span class="p">.</span><span class="nx">unwrap</span><span class="p">().</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_TOP</span>
    <span class="k">else</span>
      <span class="s2">&quot;{\n#{ @elseBody.compile o, LEVEL_TOP }\n#{@tab}}&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-222">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-222">&#182;</a>               </div>               <p>Compile the <code>If</code> as a conditional operator.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">compileExpression: </span><span class="nf">(o) -&gt;</span>
    <span class="nv">cond = </span><span class="nx">@condition</span><span class="p">.</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_COND</span>
    <span class="nv">body = </span><span class="nx">@bodyNode</span><span class="p">().</span><span class="nx">compile</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span>
    <span class="nv">alt  = </span><span class="k">if</span> <span class="nx">@elseBodyNode</span><span class="p">()</span> <span class="k">then</span> <span class="nx">@elseBodyNode</span><span class="p">().</span><span class="nx">compile</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span> <span class="nx">LEVEL_LIST</span><span class="p">)</span> <span class="k">else</span> <span class="s1">&#39;void 0&#39;</span>
    <span class="nv">code = </span><span class="s2">&quot;#{cond} ? #{body} : #{alt}&quot;</span>
    <span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">&gt;=</span> <span class="nx">LEVEL_COND</span> <span class="k">then</span> <span class="s2">&quot;(#{code})&quot;</span> <span class="k">else</span> <span class="nx">code</span>

  <span class="nv">unfoldSoak: </span><span class="o">-&gt;</span>
    <span class="nx">@soak</span> <span class="o">and</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-223">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-223">&#182;</a>               </div>               <h2>Faux-Nodes</h2>

<p>Faux-nodes are never created by the grammar, but are used during code
generation to generate other combinations of nodes.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-224">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-224">&#182;</a>               </div>               <h3>Closure</h3>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-225">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-225">&#182;</a>               </div>               <p>A faux-node used to wrap an expressions body in a closure.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">Closure =</span></pre></div>             </td>           </tr>                               <tr id="section-226">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-226">&#182;</a>               </div>               <p>Wrap the expressions body, unless it contains a pure statement,
in which case, no dice. If the body mentions <code>this</code> or <code>arguments</code>,
then make sure that the closure wrapper preserves the original values.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">wrap: </span><span class="nf">(expressions, statement, noReturn) -&gt;</span>
    <span class="k">return</span> <span class="nx">expressions</span> <span class="k">if</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">jumps</span><span class="p">()</span>
    <span class="nv">func = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="nx">expressions</span><span class="p">]</span>
    <span class="nv">args = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">mentionsArgs = </span><span class="nx">expressions</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">@literalArgs</span><span class="p">)</span> <span class="o">or</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">@literalThis</span>
      <span class="nv">meth = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="k">if</span> <span class="nx">mentionsArgs</span> <span class="k">then</span> <span class="s1">&#39;apply&#39;</span> <span class="k">else</span> <span class="s1">&#39;call&#39;</span>
      <span class="nv">args = </span><span class="p">[</span><span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;this&#39;</span><span class="p">]</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s1">&#39;arguments&#39;</span> <span class="k">if</span> <span class="nx">mentionsArgs</span>
      <span class="nv">func = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">func</span><span class="p">,</span> <span class="p">[</span><span class="k">new</span> <span class="nx">Access</span> <span class="nx">meth</span><span class="p">]</span>
    <span class="nv">func.noReturn = </span><span class="nx">noReturn</span>
    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">func</span><span class="p">,</span> <span class="nx">args</span>
    <span class="k">if</span> <span class="nx">statement</span> <span class="k">then</span> <span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span><span class="nx">call</span><span class="p">]</span> <span class="k">else</span> <span class="nx">call</span>

  <span class="nv">literalArgs: </span><span class="nf">(node) -&gt;</span>
    <span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;arguments&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">asKey</span>

  <span class="nv">literalThis: </span><span class="nf">(node) -&gt;</span>
    <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Literal</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">value</span> <span class="o">is</span> <span class="s1">&#39;this&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">node</span><span class="p">.</span><span class="nx">asKey</span><span class="p">)</span> <span class="o">or</span>
      <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">Code</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">bound</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-227">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-227">&#182;</a>               </div>               <h3>CpsCascade</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">CpsCascade =</span>

  <span class="nv">wrap: </span><span class="nf">(statement, rest, returnValue, o) -&gt;</span>
    <span class="nv">func = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Param</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span> <span class="p">],</span>
      <span class="p">(</span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span> <span class="nx">statement</span> <span class="p">]),</span> <span class="s1">&#39;icedgen&#39;</span>
    <span class="nv">args = </span><span class="p">[]</span>
    <span class="k">if</span> <span class="nx">returnValue</span>
      <span class="nx">returnValue</span><span class="p">.</span><span class="nx">bindName</span> <span class="nx">o</span>
      <span class="nx">args</span><span class="p">.</span><span class="nx">push</span> <span class="nx">returnValue</span>

    <span class="nv">block = </span><span class="nx">Block</span><span class="p">.</span><span class="nx">wrap</span> <span class="p">[</span> <span class="nx">rest</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-228">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-228">&#182;</a>               </div>               <p>Optimization! If the block is just a tail call to another continuation
that can be inlined, then we just call that call directly.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="p">(</span><span class="nv">e = </span><span class="nx">block</span><span class="p">.</span><span class="nx">getSingle</span><span class="p">())</span> <span class="o">and</span> <span class="nx">e</span> <span class="k">instanceof</span> <span class="nx">IcedTailCall</span> <span class="o">and</span> <span class="nx">e</span><span class="p">.</span><span class="nx">canInline</span><span class="p">()</span>
      <span class="nv">cont = </span><span class="nx">e</span><span class="p">.</span><span class="nx">extractFunc</span><span class="p">()</span>
    <span class="k">else</span>
      <span class="nv">cont = </span><span class="k">new</span> <span class="nx">Code</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">block</span><span class="p">,</span> <span class="s1">&#39;icedgen&#39;</span>

    <span class="nv">call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">func</span><span class="p">,</span> <span class="p">[</span> <span class="nx">cont</span> <span class="p">]</span>
    <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">call</span> <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-229">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-229">&#182;</a>               </div>               <h3>TailCall</h3>

<p>At the end of a iced if, loop, or switch statement, we tail call off
to the next continuation</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">IcedTailCall</span> <span class="k">extends</span> <span class="nx">Base</span>
  <span class="nv">constructor : </span><span class="nf">(@func, val = null) -&gt;</span>
    <span class="k">super</span><span class="p">()</span>
    <span class="vi">@func = </span><span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">k</span> <span class="nx">unless</span> <span class="nx">@func</span>
    <span class="vi">@value = </span><span class="nx">val</span>

  <span class="nv">children : </span><span class="p">[</span> <span class="s1">&#39;value&#39;</span> <span class="p">]</span>

  <span class="nv">assignValue : </span><span class="nf">(v) -&gt;</span>
    <span class="vi">@value = </span><span class="nx">v</span>

  <span class="nv">canInline : </span><span class="o">-&gt;</span>
    <span class="k">return</span> <span class="o">not</span> <span class="nx">@value</span> <span class="o">or</span> <span class="nx">@value</span> <span class="k">instanceof</span> <span class="nx">IcedReturnValue</span>

  <span class="nv">literalFunc: </span><span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">@func</span>
  <span class="nv">extractFunc: </span><span class="o">-&gt;</span> <span class="k">new</span> <span class="nx">Value</span> <span class="nx">@literalFunc</span><span class="p">()</span>

  <span class="nv">icedCpsRotate : </span><span class="o">-&gt;</span>
    <span class="k">if</span> <span class="nx">@value</span>
      <span class="vi">@value = </span><span class="nx">nv</span> <span class="k">if</span> <span class="p">(</span><span class="nv">nv = </span><span class="nx">@icedCpsExprRotate</span> <span class="nx">@value</span><span class="p">)</span>

  <span class="nv">compileNode : </span><span class="nf">(o) -&gt;</span>
    <span class="nv">f = </span><span class="nx">@literalFunc</span><span class="p">()</span>
    <span class="nv">out = </span><span class="k">if</span> <span class="nx">o</span><span class="p">.</span><span class="nx">level</span> <span class="o">is</span> <span class="nx">LEVEL_TOP</span>
      <span class="k">if</span> <span class="nx">@value</span>
        <span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">@value</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Call</span> <span class="nx">f</span> <span class="p">]</span>
      <span class="k">else</span>
        <span class="k">new</span> <span class="nx">Call</span> <span class="nx">f</span>
    <span class="k">else</span>
      <span class="nv">args = </span><span class="k">if</span> <span class="nx">@value</span> <span class="k">then</span> <span class="p">[</span> <span class="nx">@value</span> <span class="p">]</span> <span class="k">else</span> <span class="p">[]</span>
      <span class="k">new</span> <span class="nx">Call</span> <span class="nx">f</span><span class="p">,</span> <span class="nx">args</span>
    <span class="nx">out</span><span class="p">.</span><span class="nx">compileNode</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-230">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-230">&#182;</a>               </div>               <h3>IcedReturnValue</h3>

<p>A variable reference to a deferred computation</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="k">class</span> <span class="nx">IcedReturnValue</span> <span class="k">extends</span> <span class="nx">Param</span>
  <span class="vi">@counter : </span><span class="mi">0</span>
  <span class="nv">constructor : </span><span class="nf">() -&gt;</span>
    <span class="k">super</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">no</span>

  <span class="nv">bindName : </span><span class="nf">(o) -&gt;</span>
    <span class="nv">l = </span><span class="s2">&quot;#{o.scope.freeVariable iced.const.param, no}_#{IcedReturnValue.counter++}&quot;</span>
    <span class="vi">@name = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">l</span>

  <span class="nv">compile : </span><span class="nf">(o) -&gt;</span>
    <span class="nx">@bindName</span> <span class="nx">o</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@name</span>
    <span class="k">super</span> <span class="nx">o</span></pre></div>             </td>           </tr>                               <tr id="section-231">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-231">&#182;</a>               </div>               <h3>Runtime class and funcs, the most basic one...</h3>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">InlineRuntime =</span></pre></div>             </td>           </tr>                               <tr id="section-232">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-232">&#182;</a>               </div>               <p>Generate this code, inline. Is there a better way?</p>

<p>iced =
  Deferrals : class
    constructor: (@continuation) ->
      @count = 1
      @ret = null
    <em>fulfill : ->
      @continuation @ret if not --@count
    defer : (defer</em>params) ->
      @count++
      (inner<em>params...) =>
        defer</em>params?.assign<em>fn?.apply(null, inner</em>params)
        @_fulfill()
  findDeferral : (args) -> null</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate : </span><span class="nf">(ns_window) -&gt;</span>
    <span class="nv">k = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;continuation&quot;</span>
    <span class="nv">cnt = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;count&quot;</span>
    <span class="nv">cn = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">Deferrals</span>
    <span class="nv">ns = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">ns</span>
    <span class="k">if</span> <span class="nx">ns_window</span> <span class="c1"># window.iced = ...</span>
      <span class="nx">ns_window</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">ns</span>
      <span class="nv">ns = </span><span class="nx">ns_window</span></pre></div>             </td>           </tr>                               <tr id="section-233">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-233">&#182;</a>               </div>               <p>make the constructor:</p>

<p>constructor: (@continuation) ->
    @count = 1
    @ret = null</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">k_member = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;this&quot;</span>
    <span class="nx">k_member</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">k</span>
    <span class="nv">p1 = </span><span class="k">new</span> <span class="nx">Param</span> <span class="nx">k_member</span>
    <span class="nv">cnt_member = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;this&quot;</span>
    <span class="nx">cnt_member</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">cnt</span>
    <span class="nv">ret_member = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;this&quot;</span>
    <span class="nx">ret_member</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">retslot</span>
    <span class="nv">a1 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">cnt_member</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="mi">1</span>
    <span class="nv">a2 = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ret_member</span><span class="p">,</span> <span class="nx">NULL</span><span class="p">()</span>
    <span class="nv">constructor_params = </span><span class="p">[</span> <span class="nx">p1</span> <span class="p">]</span>
    <span class="nv">constructor_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">a1</span><span class="p">,</span> <span class="nx">a2</span> <span class="p">]</span>
    <span class="nv">constructor_code = </span><span class="k">new</span> <span class="nx">Code</span> <span class="nx">constructor_params</span><span class="p">,</span> <span class="nx">constructor_body</span>
    <span class="nv">constructor_name = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;constructor&quot;</span>
    <span class="nv">constructor_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">constructor_name</span><span class="p">,</span> <span class="nx">constructor_code</span></pre></div>             </td>           </tr>                               <tr id="section-234">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-234">&#182;</a>               </div>               <p>make the _fulfill member:</p>

<p>_fulfill : ->
    @continuation @ret if not --@count</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">if_expr = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">k_member</span><span class="p">,</span> <span class="p">[</span> <span class="nx">ret_member</span> <span class="p">]</span>
    <span class="nv">if_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">if_expr</span> <span class="p">]</span>
    <span class="nv">decr = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="nx">cnt_member</span>
    <span class="nv">if_cond = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="nx">decr</span>
    <span class="nv">my_if = </span><span class="k">new</span> <span class="nx">If</span> <span class="nx">if_cond</span><span class="p">,</span> <span class="nx">if_body</span>
    <span class="nv">_fulfill_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">my_if</span> <span class="p">]</span>
    <span class="nv">_fulfill_code = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[],</span> <span class="nx">_fulfill_body</span>
    <span class="nv">_fulfill_name = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">fulfill</span>
    <span class="nv">_fulfill_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">_fulfill_name</span><span class="p">,</span> <span class="nx">_fulfill_code</span></pre></div>             </td>           </tr>                               <tr id="section-235">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-235">&#182;</a>               </div>               <p>Make the defer member:
  defer : (defer<em>params) ->
    @count++
    (inner</em>params...) ->
      defer<em>params?.assign</em>fn?.apply(null, inner<em>params)
      @</em>fulfill()</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">inc = </span><span class="k">new</span> <span class="nx">Op</span> <span class="s2">&quot;++&quot;</span><span class="p">,</span> <span class="nx">cnt_member</span>
    <span class="nv">ip = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;inner_params&quot;</span>
    <span class="nv">dp = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;defer_params&quot;</span>
    <span class="nv">dp_value = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">dp</span>
    <span class="nv">call_meth = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">dp</span>
    <span class="nv">af = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">assign_fn</span>
    <span class="nx">call_meth</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">af</span><span class="p">,</span> <span class="s2">&quot;soak&quot;</span>
    <span class="nv">my_apply = </span><span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;apply&quot;</span>
    <span class="nx">call_meth</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="nx">my_apply</span><span class="p">,</span> <span class="s2">&quot;soak&quot;</span>
    <span class="nv">my_null = </span><span class="nx">NULL</span><span class="p">()</span>
    <span class="nv">apply_call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">call_meth</span><span class="p">,</span> <span class="p">[</span> <span class="nx">my_null</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Value</span> <span class="nx">ip</span> <span class="p">]</span>
    <span class="nv">_fulfill_method = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="s2">&quot;this&quot;</span>
    <span class="nx">_fulfill_method</span><span class="p">.</span><span class="nx">add</span> <span class="k">new</span> <span class="nx">Access</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">fulfill</span>
    <span class="nv">_fulfill_call = </span><span class="k">new</span> <span class="nx">Call</span> <span class="nx">_fulfill_method</span><span class="p">,</span> <span class="p">[]</span>
    <span class="nv">inner_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">apply_call</span><span class="p">,</span> <span class="nx">_fulfill_call</span> <span class="p">]</span>
    <span class="nv">inner_params = </span><span class="p">[</span> <span class="k">new</span> <span class="nx">Param</span> <span class="nx">ip</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">on</span> <span class="p">]</span>
    <span class="nv">inner_code = </span><span class="k">new</span> <span class="nx">Code</span> <span class="nx">inner_params</span><span class="p">,</span> <span class="nx">inner_body</span><span class="p">,</span> <span class="s2">&quot;boundfunc&quot;</span>
    <span class="nv">defer_body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">inc</span><span class="p">,</span> <span class="nx">inner_code</span> <span class="p">]</span>
    <span class="nv">defer_params = </span><span class="p">[</span> <span class="k">new</span> <span class="nx">Param</span> <span class="nx">dp</span> <span class="p">]</span>
    <span class="nv">defer_code = </span><span class="k">new</span> <span class="nx">Code</span> <span class="nx">defer_params</span><span class="p">,</span> <span class="nx">defer_body</span>
    <span class="nv">defer_name = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">defer_method</span>
    <span class="nv">defer_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">defer_name</span><span class="p">,</span> <span class="nx">defer_code</span></pre></div>             </td>           </tr>                               <tr id="section-236">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-236">&#182;</a>               </div>               <p>Piece the class together</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">assignments = </span><span class="p">[</span> <span class="nx">constructor_assign</span><span class="p">,</span> <span class="nx">_fulfill_assign</span><span class="p">,</span> <span class="nx">defer_assign</span> <span class="p">]</span>
    <span class="nv">obj = </span><span class="k">new</span> <span class="nx">Obj</span> <span class="nx">assignments</span><span class="p">,</span> <span class="kc">true</span>
    <span class="nv">body = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="k">new</span> <span class="nx">Value</span> <span class="nx">obj</span> <span class="p">]</span>
    <span class="nv">klass = </span><span class="k">new</span> <span class="nx">Class</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">body</span>
    <span class="nv">klass_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">cn</span><span class="p">,</span> <span class="nx">klass</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-237">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-237">&#182;</a>               </div>               <p>A stub so that the function still works
     findDeferral : (args) -> null</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">outer_block = </span><span class="k">new</span> <span class="nx">Block</span> <span class="p">[</span> <span class="nx">NULL</span><span class="p">()</span> <span class="p">]</span>
    <span class="nv">fn_code = </span><span class="k">new</span> <span class="nx">Code</span> <span class="p">[</span> <span class="p">],</span> <span class="nx">outer_block</span>
    <span class="nv">fn_name = </span><span class="k">new</span> <span class="nx">Value</span> <span class="k">new</span> <span class="nx">Literal</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">findDeferral</span>
    <span class="nv">fn_assign = </span><span class="k">new</span> <span class="nx">Assign</span> <span class="nx">fn_name</span><span class="p">,</span> <span class="nx">fn_code</span><span class="p">,</span> <span class="s2">&quot;object&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-238">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-238">&#182;</a>               </div>               <p>iced =
  Deferrals : <class>
  findDeferral : <code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">ns_obj = </span><span class="k">new</span> <span class="nx">Obj</span> <span class="p">[</span> <span class="nx">klass_assign</span><span class="p">,</span> <span class="nx">fn_assign</span> <span class="p">],</span> <span class="kc">true</span>
    <span class="nv">ns_val = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">ns_obj</span>
    <span class="k">new</span> <span class="nx">Assign</span> <span class="nx">ns</span><span class="p">,</span> <span class="nx">ns_val</span></pre></div>             </td>           </tr>                               <tr id="section-239">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-239">&#182;</a>               </div>               <p>Unfold a node's child if soak, then tuck the node under created <code>If</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">unfoldSoak = </span><span class="nf">(o, parent, name) -&gt;</span>
  <span class="k">return</span> <span class="nx">unless</span> <span class="nv">ifn = </span><span class="nx">parent</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">unfoldSoak</span> <span class="nx">o</span>
  <span class="nx">parent</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">ifn</span><span class="p">.</span><span class="nx">body</span>
  <span class="nv">ifn.body = </span><span class="k">new</span> <span class="nx">Value</span> <span class="nx">parent</span>
  <span class="nx">ifn</span></pre></div>             </td>           </tr>                               <tr id="section-240">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-240">&#182;</a>               </div>               <h2>Constants</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">UTILITIES =</span></pre></div>             </td>           </tr>                               <tr id="section-241">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-241">&#182;</a>               </div>               <p>Correctly set up a prototype chain for inheritance, including a reference
to the superclass for <code>super()</code> calls, and copies of any static properties.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">extends</span><span class="o">:</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    function(child, parent) { for (var key in parent) { if (#{utility &#39;hasProp&#39;}.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; }</span>
<span class="s2">  &quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-242">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-242">&#182;</a>               </div>               <p>Create a function bound to the current value of "this".</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">bind: </span><span class="o">-&gt;</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    function(fn, me){ return function(){ return fn.apply(me, arguments); }; }</span>
<span class="s1">  &#39;&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-243">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-243">&#182;</a>               </div>               <p>Discover if an item is in an array.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">indexOf: </span><span class="o">-&gt;</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    [].indexOf || function(item) { for (var i = 0, l = this.length; i &lt; l; i++) { if (i in this &amp;&amp; this[i] === item) return i; } return -1; }</span>
<span class="s2">  &quot;&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-244">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-244">&#182;</a>               </div>               <p>Shortcuts to speed up the lookup time for native functions.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">hasProp: </span><span class="o">-&gt;</span> <span class="s1">&#39;{}.hasOwnProperty&#39;</span>
  <span class="nv">slice  : </span><span class="o">-&gt;</span> <span class="s1">&#39;[].slice&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-245">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-245">&#182;</a>               </div>               <p>Levels indicate a node's position in the AST. Useful for knowing if
parens are necessary or superfluous.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">LEVEL_TOP    = </span><span class="mi">1</span>  <span class="c1"># ...;</span>
<span class="nv">LEVEL_PAREN  = </span><span class="mi">2</span>  <span class="c1"># (...)</span>
<span class="nv">LEVEL_LIST   = </span><span class="mi">3</span>  <span class="c1"># [...]</span>
<span class="nv">LEVEL_COND   = </span><span class="mi">4</span>  <span class="c1"># ... ? x : y</span>
<span class="nv">LEVEL_OP     = </span><span class="mi">5</span>  <span class="c1"># !...</span>
<span class="nv">LEVEL_ACCESS = </span><span class="mi">6</span>  <span class="c1"># ...[0]</span></pre></div>             </td>           </tr>                               <tr id="section-246">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-246">&#182;</a>               </div>               <p>Tabs are two spaces for pretty printing.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">TAB = </span><span class="s1">&#39;  &#39;</span>

<span class="nv">IDENTIFIER_STR = </span><span class="s2">&quot;[$A-Za-z_\\x7f-\\uffff][$\\w\\x7f-\\uffff]*&quot;</span>
<span class="nv">IDENTIFIER = </span><span class="err">/// ^ #{IDENTIFIER_STR} $ ///</span>
<span class="nv">SIMPLENUM  = </span><span class="sr">/^[+-]?\d+$/</span>
<span class="nv">METHOD_DEF = </span><span class="err">///</span>
  <span class="o">^</span>
    <span class="p">(</span><span class="o">?:</span>
      <span class="p">(</span><span class="c1">#{IDENTIFIER_STR})</span>
      <span class="err">\</span><span class="p">.</span><span class="nx">prototype</span>
      <span class="p">(</span><span class="o">?:</span>
        <span class="err">\</span><span class="p">.(</span><span class="c1">#{IDENTIFIER_STR})</span>
      <span class="o">|</span> <span class="err">\</span><span class="p">[(</span><span class="s2">&quot;(?:[^\\&quot;</span><span class="err">\</span><span class="nx">r</span><span class="err">\</span><span class="nx">n</span><span class="p">]</span><span class="o">|</span><span class="err">\\</span><span class="p">.)</span><span class="o">*</span><span class="s2">&quot;|&#39;(?:[^\\&#39;\r\n]|\\.)*&#39;)\]</span>
<span class="s2">      | \[(0x[\da-fA-F]+ | \d*\.?\d+ (?:[eE][+-]?\d+)?)\]</span>
<span class="s2">      )</span>
<span class="s2">    )</span>
<span class="s2">  |</span>
<span class="s2">    (#{IDENTIFIER_STR})</span>
<span class="s2">  $</span>
<span class="s2">///</span>


<span class="s2">#DIVIDER</span>
<span class="s2">IS_STRING = /^[&#39;&quot;</span><span class="p">]</span><span class="o">/</span></pre></div>             </td>           </tr>                               <tr id="section-247">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-247">&#182;</a>               </div>               <p>Is a literal value a string?</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-248">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-248">&#182;</a>               </div>               <h2>Utility Functions</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">utility = </span><span class="nf">(name) -&gt;</span>
  <span class="nv">ref = </span><span class="s2">&quot;__#{name}&quot;</span>
  <span class="nx">Scope</span><span class="p">.</span><span class="nx">root</span><span class="p">.</span><span class="nx">assign</span> <span class="nx">ref</span><span class="p">,</span> <span class="nx">UTILITIES</span><span class="p">[</span><span class="nx">name</span><span class="p">]()</span>
  <span class="nx">ref</span>

<span class="nv">multident = </span><span class="nf">(code, tab) -&gt;</span>
  <span class="nv">code = </span><span class="nx">code</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s1">&#39;$&amp;&#39;</span> <span class="o">+</span> <span class="nx">tab</span>
  <span class="nx">code</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\s+$/</span><span class="p">,</span> <span class="s1">&#39;&#39;</span>

</pre></div>             </td>           </tr>                               <tr id="section-249">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-249">&#182;</a>               </div>               <p>Helper for ensuring that utility functions are assigned at the top level.</p>             </td>             <td class="code">               <div class="highlight"><pre>undefined</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
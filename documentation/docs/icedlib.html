<!DOCTYPE html>  <html> <head>   <title>icedlib.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="browser.html">                 browser.coffee               </a>                                           <a class="source" href="cake.html">                 cake.coffee               </a>                                           <a class="source" href="coffee-script.html">                 coffee-script.coffee               </a>                                           <a class="source" href="command.html">                 command.coffee               </a>                                           <a class="source" href="grammar.html">                 grammar.coffee               </a>                                           <a class="source" href="helpers.html">                 helpers.coffee               </a>                                           <a class="source" href="iced.html">                 iced.coffee               </a>                                           <a class="source" href="icedlib.html">                 icedlib.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="lexer.html">                 lexer.coffee               </a>                                           <a class="source" href="nodes.html">                 nodes.coffee               </a>                                           <a class="source" href="optparse.html">                 optparse.coffee               </a>                                           <a class="source" href="repl.html">                 repl.coffee               </a>                                           <a class="source" href="rewriter.html">                 rewriter.coffee               </a>                                           <a class="source" href="scope.html">                 scope.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               icedlib.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">iced_internals = </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./iced&#39;</span><span class="p">)</span>
<span class="nv">exports.iced = iced = </span><span class="nx">iced_internals</span><span class="p">.</span><span class="nx">runtime</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>icedlib</p>

<p>This class contains non-essential but convenient runtime libraries
  for iced programs</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>The <code>timeout</code> connector, which allows us to compose timeouts with
existing event-based calls</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_timeout = </span><span class="nf">(cb, t, res, tmp) -&gt;</span>
    <span class="nv">rv = </span><span class="k">new</span> <span class="nx">iced</span><span class="p">.</span><span class="nx">Rendezvous</span>
    <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="kc">true</span><span class="p">).</span><span class="nx">defer</span><span class="p">(</span><span class="nx">arr</span><span class="p">...)</span>
    <span class="nx">setTimeout</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">id</span><span class="p">(</span><span class="kc">false</span><span class="p">).</span><span class="nx">defer</span><span class="p">(),</span> <span class="nx">t</span>
    <span class="nx">await</span> <span class="nx">rv</span><span class="p">.</span><span class="nx">wait</span> <span class="nx">defer</span> <span class="nx">which</span>
    <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">which</span> <span class="k">if</span> <span class="nx">res</span>
    <span class="nx">cb</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">arr</span><span class="p">)</span>

<span class="nv">exports.timeout = </span><span class="nf">(cb, t, res) -&gt;</span>    
  <span class="nv">tmp = </span><span class="p">[]</span>
  <span class="nx">_timeout</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">tmp</span>
  <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>The 'and' connector, that allows you to check only once that
all operations with a parallel <code>await</code> worked...</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_iand = </span><span class="nf">(cb, res, tmp) -&gt;</span>
  <span class="nx">await</span>
    <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defer</span> <span class="nx">ok</span>
  <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span> <span class="nx">unless</span> <span class="nx">ok</span>
  <span class="nx">cb</span><span class="p">()</span>
 
<span class="nv">exports.iand = </span><span class="nf">(cb, res) -&gt;</span>
  <span class="nv">tmp = </span><span class="p">[]</span>
  <span class="nx">_iand</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">tmp</span>
  <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The 'or' connector, that allows you to check only once that
one of several operations in a parallel <code>await</code> worked</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_ior = </span><span class="nf">(cb, res, tmp) -&gt;</span>
  <span class="nx">await</span>
    <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">defer</span> <span class="nx">ok</span>
  <span class="nx">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">ok</span>
  <span class="nx">cb</span><span class="p">()</span>

<span class="nv">exports.ior = </span><span class="nf">(cb, res) -&gt;</span>
  <span class="nv">tmp = </span><span class="p">[]</span>
  <span class="nx">_ior</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">tmp</span>
  <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>#</h2>

<p>Pipeliner -- a class for firing a follow of network calls in a pipelined
  fashion, so that only so many of them are outstanding at once.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.Pipeliner = </span><span class="k">class</span> <span class="nx">Pipeliner</span>

  <span class="nv">constructor : </span><span class="nf">(window, delay) -&gt;</span>
    <span class="vi">@window = </span><span class="nb">window</span> <span class="o">||</span> <span class="mi">1</span>
    <span class="vi">@delay = </span><span class="nx">delay</span> <span class="o">||</span> <span class="mi">0</span>
    <span class="vi">@queue = </span><span class="p">[]</span>
    <span class="vi">@n_out = </span><span class="mi">0</span>
    <span class="vi">@cb = </span><span class="kc">null</span>
    </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This is a hack to work with the desugaring of
'defer' output by the coffee compiler. Same as in rendezvous</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="err">@</span><span class="p">[</span><span class="nx">iced_internals</span><span class="p">.</span><span class="nx">const</span><span class="p">.</span><span class="nx">deferrals</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span>
    </pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Rebind "defer" to "_defer"; We can't do this directly since the
compiler would pick it up</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="err">@</span><span class="p">[</span><span class="s2">&quot;defer&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@_defer</span>
    </pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Call this to wait in a queue until there is room in the window</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">waitInQueue : </span><span class="nf">(cb) -&gt;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Wait until there is room in the window.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">while</span> <span class="nx">@n_out</span> <span class="o">&gt;</span> <span class="nx">@window</span>
      <span class="nx">await</span> <span class="p">(</span><span class="vi">@cb = </span><span class="nx">defer</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Lanuch a computation, so mark that there's one more
guy outstanding.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@n_out</span><span class="o">++</span>
      </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Delay if that was asked for...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@delay</span>
      <span class="nx">await</span> <span class="nx">setTimeout</span> <span class="nx">defer</span><span class="p">(),</span> <span class="nx">@delay</span>
      
    <span class="nx">cb</span><span class="p">()</span>
        </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Helper for this._defer, seen below..</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">__defer : </span><span class="nf">(out, deferArgs) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Make a callback that this.defer can return.
This callback might have to fill in slots when its
fulfilled, so that's why we need to wrap the output
of defer() in an anonymous wrapper.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">await</span>
      <span class="nv">voidCb = </span><span class="nx">defer</span><span class="p">()</span>
      <span class="nx">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(args...) -&gt;</span>
        <span class="nx">deferArgs</span><span class="p">.</span><span class="nx">assign_fn</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">args</span>
        <span class="nx">voidCb</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>There is now one fewer outstanding computation.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@n_out</span><span class="o">--</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>If some is waiting in waitInQueue above, then now is the
time to release him. Use "race-free" callback technique.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@cb</span>
      <span class="nv">tmp = </span><span class="nx">@cb</span>
      <span class="vi">@cb = </span><span class="kc">null</span>
      <span class="nx">tmp</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>This function, Pipeliner._defer, has to return a 
callback to its caller.  It does this with the same trick above.
The helper function _defer() does the heavy lifting, returning
its callback to us as the first slot in tmp[0].</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_defer : </span><span class="nf">(deferArgs) -&gt;</span>
    <span class="nv">tmp = </span><span class="p">[]</span>
    <span class="nx">@__defer</span> <span class="nx">tmp</span><span class="p">,</span> <span class="nx">deferArgs</span>
    <span class="nx">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>flush everything left in the pipe</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">flush : </span><span class="nf">(autocb) -&gt;</span>
    <span class="k">while</span> <span class="nx">@n_out</span>
      <span class="nx">await</span> <span class="p">(</span><span class="vi">@cb = </span><span class="nx">defer</span><span class="p">())</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 